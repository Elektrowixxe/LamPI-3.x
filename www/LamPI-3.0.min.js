var fake=0,w_url=location.host,w_svr="LamPI-node.js",w_port="5000",w_uri,w_sock,w_tcnt=0,phonegap=0,jqmobile=0,dynamicIP=1,murl="/",skin="",debug="1",persist="1",mysql="1",cntrl="1",use_weather="0",use_energy="0",loginprocess=!1,healthcount=5,healthtime=1E4,s_screen="room",s_controller=murl+"frontend_rasp.php",s_room_id=1,s_scene_id=1,s_timer_id=1,s_handset_id=1,s_weather_id="",s_energy_id=0,s_setting_id=0,s_recorder="",s_recording=0,max_rooms=16,max_scenes=16,max_devices=16,max_timers=16,max_handsets=
8,max_weather=8,rooms={},devices={},moods={},scenes={},timers={},brands={},handsets={},weather={},energy={},settings={};
function start_LAMP(){$(window).on("beforeunload",function(){logger("beforeunload closing the socket");w_sock.close()});$(window).load(function(){function c(){var a=w_url.split(":");logger("init_websockets:: Splitting url and port: "+a[0],2);w_uri="ws://"+a[0]+":"+w_port;logger("init_websockets:: new WebSocket w_uri: "+w_uri,1);w_sock=new WebSocket(w_uri);w_sock.onopen=function(a){logger("Websocket:: Opening socket "+w_uri,1);message("websocket reopen",1)};w_sock.onclose=function(a){logger("Websocket:: socket closed "+
w_uri+", code: "+a.code,1);message('<DIV style="textdecoration: blink; background-color:yellow; color:black;">Restarting the Websocket. Please wait ...</DIV>');setTimeout(function(){message("")},500);setTimeout(function(){c()},1E3);logger("Websocket:: socket re-opened: "+w_sock.readyState)};w_sock.onerror=function(a){logger("Websocket:: error. State is: "+w_sock.readyState)};w_sock.onmessage=function(a){10>healthcount&&healthcount++;2<=debug&&(logger("Websocket:: message received: "),console.log(a.data));
a=JSON.parse(a.data);1<=debug&&(logger("Websocket:: message rcv: "),console.log(a));var b=a.tcnt,c=a.type,d=a.action;switch(d){case "ack":3<=debug?message("action: "+d+", tcnt: "+b+", mes: "+e+", type: "+c,3):logger("action: "+d+", tcnt: "+b+", mes: "+e+", type: "+c,2);break;case "alert":myAlert("Server msg:: "+a.message);break;case "alarm":myAlert("Server msg:: "+a.message);break;case "upd":case "gui":var e=a.message;switch(c){case "json":logger("onmessage:: read upd message. Type is: "+c+". Json is not supported yet",
1);var g=a.room,f=a.uaddr,l=a.val,t=lookup_uaddr(g,f);devices[t].val=l;g==s_room_id&&"room"==s_screen&&activate_room(s_room_id);break;case "raw":e=a.message;logger("onmessage:: read upd message. Type is: "+c,1);a=parse_int(e);"!R"==e.substr(0,2)&&(g=a[0],f=a[1],t=lookup_uaddr(g,f),e.search("FdP"),l=a[2],logger("onmessage:: room: "+g+", device: "+f+", val: "+l+", ind: "+t,2),devices[t].val=l,g==s_room_id&&"room"==s_screen&&activate_room(s_room_id));break;default:logger("onmessage:: read upd message. Unknown type: "+
c,1)}0==debug?message("Update: "+devices[t].name+" to value: "+l,0):message("action: "+d+", tcnt: "+b+", mes: "+e+", type: "+c,1);break;case "weather":for(l=0;l<weather.length&&(weather[l].address!=a.address||weather[l].channel!=a.channel);l++);l<weather.length&&(weather[l].temperature=a.temperature,weather[l].humidity=a.humidity,weather[l].airpressure=a.airpressure,weather[l].windspeed=a.windspeed,weather[l].winddirection=a.winddirection,weather[l].rainfall=a.rainfall,e="",2<=debug&&(e+="Weather "+
weather[l].name+"@ "+weather[l].location,e+=": temp: "+weather[l].temperature,e+=", humi: "+weather[l].humidity+"%<br>",logger("Weather "+weather[l].name+"@"+weather[l].location+": temp: "+weather[l].temperature+", humi: "+weather[l].humidity+"%")),message(e));break;case "sensor":logger("Lampi.js:: received sensor message");break;case "energy":logger("Energy message, kw_act_use: "+a.kw_act_use,1);energy.kw_hi_use=a.kw_hi_use;energy.kw_lo_use=a.kw_lo_use;energy.kw_hi_ret=a.kw_hi_ret;energy.kw_lo_ret=
a.kw_lo_ret;energy.gas_use=a.gas_use;energy.kw_act_use=a.kw_act_use;energy.kw_act_ret=a.kw_act_ret;energy.kw_ph1_use=a.kw_ph1_use;energy.kw_ph2_use=a.kw_ph2_use;energy.kw_ph3_use=a.kw_ph3_use;break;case "console":logger("console message received"+a.response,2);myAlert("Console Message :\n"+a.response,a.request+" Output");break;case "user":case "login":if(loginprocess)break;loginprocess=!0;"undefined"!==typeof Storage?(e=localStorage.getItem("uname"),l=localStorage.getItem("pword"),1<=debug&&logger("Support for localstorage, uname: "+
e),null==e&&(e=""),null==l&&(l="")):(1<=debug&&logger("No local storage in browser"),e="login",l="****");logger("Lampi.js:: received login request");askForm('<form id="addRoomForm"><fieldset><p>Since your computer <'+a.address+'> is outside our network, we ask you to logon to the system and prove your identity </p><label for="val_1">Login: </label><input type="text" name="val_1" id="val_1" value="'+e+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Password: </label><input type="text" name="val_2" id="val_2" value="'+
l+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);var b={tcnt:++w_tcnt%1E3,action:"login",login:a[0],password:a[1]};w_sock.send(JSON.stringify(b));logger(b);"undefined"!==typeof Storage&&(localStorage.setItem("uname",a[0]),localStorage.setItem("pword",a[1]),logger("localstorage:: uname: "+a[0]));2<=debug&&myAlert("Submit login: "+a[0]+", password: "+a[1]);loginprocess=!1;return 1},function(){2<=debug&&myAlert("Submit login Cancelled");
loginprocess=!1;return 0},"Confirm Login");break;case "load_database":logger("Receiving load_database message",2);rooms=a.response.rooms;devices=a.response.devices;scenes=a.response.scenes;timers=a.response.timers;handsets=a.response.handsets;settings=a.response.settings;brands=a.response.brands;weather=a.response.weather;init();message("database received");void 0!==typeof Storage&&(localStorage.setObject("rooms",rooms),localStorage.setObject("devices",devices),localStorage.setObject("scenes",scenes),
localStorage.setObject("timers",timers),localStorage.setObject("handsets",handsets),localStorage.setObject("settings",settings),localStorage.setObject("brands",brands),localStorage.setObject("weather",weather));message("database received: #rooms: "+rooms.length+", #devices:"+devices.length);break;default:message("Unknown message: action: "+d+", tcnt: "+b+", mes: "+e+", type: "+c)}};logger("Websocket:: readyState: "+w_sock.readyState,1)}$("#gui_header").on("click",".hr_button",function(a){a.preventDefault();
selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hr_button").removeClass("hover");$(this).addClass("hover");activate_room(id)});$("#gui_header").on("click",".cr_button",function(a){a.preventDefault();selected=$(this);$(".cr_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_rooms;){for(a=0;a<rooms.length&&rooms[a].id!=b;a++);if(a==rooms.length)break;b++}if(b>max_rooms)return alert("Unable to add more rooms"),
-1;2<debug&&alert("Add Room: New index found: "+b);askForm("<form><fieldset><p>You have created room nr "+b+'. Please specify name for your new room</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned Name,Type: "+a);a={id:b,name:a[0]};rooms.push(a);s_room_id=b;send2dbase("add_room",a);init_rooms("init");return 1},function(){activate_room(s_room_id);return 1},
"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Room: </label><select id="val_1" value="val_1" >';for(a=0;a<rooms.length;a++)c+="<option>"+rooms[a].name+"</option>";a="<form><fieldset><br />You are planning to delete a room from the system. If you do so, all actions associated with the room must be deleted too.\nPlease start with selecting a room from the list on top of the screen.Please click on the room you wish to delete from the system.<br /><br />"+(c+"</select>")+"<br /></fieldset></form>";
askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);for(var b=a[0],c=0;c<rooms.length&&rooms[c].name!=b;c++);a=rooms[c].id;for(var d=0;d<devices.length;d++)if(devices[d].room==a)return alert("Room "+b+" is not empty\nWe cannot delete this room\nSorry"),0;b=rooms.splice(c,1);s_room_id==a&&(s_room_id=rooms[0].id);0<persist&&(logger(b[0],2),send2dbase("delete_room",b[0]),2<=debug&&alert("Removed from dbase:: id: "+b[0].id+" , name: "+b[0].name));init_rooms("init");return 1},function(){activate_room(s_room_id);
return 1},"Confirm Delete Room");break;case "Help":helpForm("Room","This form allows you to control the lighting in a particular room Select the room that you like to control with the buttons in the top header area For every device in the room, whether dimmer or switch, users can change the light setting.\nThe small buttons in the top right corner are special buttons The leftmost green one allows you to add a device to the active room.\nThe red X allows you to delete a device from the room. Press the X and you'll see small selection buttons on the left of every device line. Press one and you'll be able to delete the device.\n"),
$(".cr_button").removeClass("hover")}$(this).removeClass("hover")});$("#gui_header").on("click",".hs_button",function(a){a.preventDefault();selected=$(this);$(".hs_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_scene(id)});$("#gui_header").on("click",".cs_button",function(a){a.preventDefault();selected=$(this);$(".cs_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=
1;b<=max_scenes;){for(a=0;a<scenes.length&&scenes[a].id!=b;a++);if(a==scenes.length)break;b++}if(b>max_scenes)return alert("Unable to add more scenes"),-1;askForm("<form><fieldset><p>You have created scene nr "+b+'. Please specify name for your new scene</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a={id:b,name:a[0],val:"0",
seq:""};scenes.push(a);send2dbase("add_scene",a);s_scene_id=b;init_scenes("init");return 1},function(){activate_scene(s_scene_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Scene: </label><select id="val_1" value="val_1" >';for(a=0;a<scenes.length;a++)c+="<option>"+scenes[a].name+"</option>";a="<form><fieldset><br />You are planning to delete a scene from the system. If you do so, all actions associated with the scene must be deleted too.\nPlease start with selecting a scene from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=0;b<scenes.length&&scenes[b].name!=a;b++);a=scenes.splice(b,1);0<persist&&(logger(a[0]),send2dbase("delete_scene",a[0]),1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name));s_scene_id=scenes[0].id;init_scenes("init");return 1},function(){activate_scene(s_scene_id);return 1},"Confirm Delete Scene");break;case "Help":helpForm("Scene","This is the Help screen for Scenes (or sequences if you wish)\n\nIn the header section you see an overview of your scenes defined, which enables you to view/change or add to a scene of your choice. \n\nThe Context section in the middle shows for each defines scene the sequence of actions that will be performed when you RUN that scene with the blue > button. \nIf you add or remove a device action to a scene this will NOT be stored unless you use the store function which will write the sequence to the database. ");
$(".cs_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_header").on("click",".ht_button",function(a){a.preventDefault();selected=$(this);
$(".ht_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_timer(id);2<debug&&alert("init_timer:: Button event")});$("#gui_header").on("click",".ct_button",function(a){a.preventDefault();selected=$(this);$(".ct_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_timers;){for(a=0;a<timers.length&&timers[a].id!=b;a++);if(a==timers.length)break;b++}if(b>
max_timers)return alert("Unable to add more timers"),-1;askForm("<form><fieldset><p>You have created timer nr"+b+'. Please specify name for your new timer</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a={id:b,name:a[0],scene:"",tstart:"00:00:00",startd:"01/01/13",endd:"",days:"mtwtfss",months:"jfmamjjasond",skip:"0"};timers.push(a);
send2dbase("add_timer",a);s_timer_id=b;init_timers("init");return 1},function(){activate_timer(s_timer_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Timer: </label><select id="val_1" value="val_1" >';for(a=0;a<timers.length;a++)c+="<option>"+timers[a].name+"</option>";a="<form><fieldset><br />You are planning to delete a timer from the system. If you do so, all actions associated with the timer are deleted too.\nPlease start with selecting a timer from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=0;b<timers.length&&timers[b].name!=a;b++);a=timers.splice(b,1);0<persist&&(logger(a[0]),send2dbase("delete_timer",a[0]),1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name));s_timer_id=timers[0].id;init_timers("init");return 1},function(){activate_timer(s_timer_id);return 1},"Confirm Delete Timer");break;case "Help":helpForm("Timers","This is the Help screen for Timers\n\nIn the header section you see an overview of your timers defined, selecting one enables you to view/change or add to a timer. \n\nThe Content section in the middle shows its settings: Which scene should be started, on what time, and on whichs days or months. \nIf you change a timer setting this will NOT be stored unless you use the store function which will write the timer to the database. ");
$(".ct_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}$(this).removeClass("hover")});$("#gui_header").on("click",".hh_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hh_button").removeClass("hover");$(this).addClass("hover");activate_handset(id)});$("#gui_header").on("click",".ch_button",function(a){a.preventDefault();selected=$(this);$(".ch_button").removeClass("hover");$(this).addClass("hover");
value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_handsets;){for(a=0;a<handsets.length&&handsets[a].id!=b;a++);if(a==handsets.length)break;b++}if(b>max_handsets)return alert("Unable to add more handsets"),-1;askForm("<form><fieldset><br />DRAFT:<p>You have created handset nr "+b+'. Please specify name for your new remote</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><br /><label for="val_2">Address: </label><input type="text" name="val_2" id="val_2" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',
function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);var c=a[0];a=a[1];for(var d=0;d<handsets.length&&handsets[d].addr!=a;d++);if(d!=handsets.length)return alert("The handset address "+a+" is already registered"),0;1<debug&&alert("New handset on ind: "+b+", name: "+c+", addr: "+a);c={id:b,name:c,brand:"",addr:a,unit:"0",val:"0",type:"switch",scene:""};handsets.push(c);logger("Added new handset "+c.name);send2dbase("add_handset",c);s_handset_id=b;init_handsets("init");return 1},function(){activate_handset(s_handset_id);
return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Handset: </label><select id="val_1" value="val_1" >',d=[];for(a=0;a<handsets.length;a++)-1==$.inArray(handsets[a].id,d)&&(c+="<option>"+handsets[a].name+"</option>",d[d.length]=handsets[a].id);a="<form><fieldset><br>DRAFT:</br><br />You are planning to delete a handset from the system. If you do so, all actions associated with the handset must be deleted too.\nPlease start with selecting a handset from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=handsets.length-1;0<=b;b--)if(2<debug&&alert("working with i: "+b+", handset id: "+handsets[b].name),handsets[b].name==a){var c=handsets.splice(b,1);0<persist&&(logger(c[0]),send2dbase("delete_handset",c[0]),1<debug&&myAlert("Removed from dbase:: id: "+c[0].id+" , name: "+c[0].name))}s_handset_id=handsets[0].id;init_handsets("init");return 1},function(){activate_handset(s_handset_id);
return 1},"Confirm Delete Handset");break;case "Help":helpForm("Handsets","This is the Help screen for Handsets or Remote controls\n\nIn the header section you see an overview of your handsets defined, which enables you to view/change or add to a handset of your choice. \n\nThe Content section in the middle shows for each defined handset the button definitions. If you add or remove a device action to a handset these will NOT be stored unless you use the store function which will write the sequence to the database. ");
$(".ch_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_header").on("click",".hw_button",function(a){a.preventDefault();selected=$(this);
value=$(this).val();id=$(a.target).attr("id");$(".hw_button").removeClass("hover");$(this).addClass("hover");activate_weather(id)});$("#gui_content").on("click",".cw_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".cw_button").removeClass("hover");$(this).addClass("hover");window.open("http://"+w_url+"/graphs/weather.html","_parent");$(this).removeClass("hover")});$("#gui_header").on("click",".cw_button",function(a){a.preventDefault();selected=
$(this);$(".cw_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_weather;){for(a=0;a<weather.length&&weathers[a].id!=b;a++);if(a==weather.length)break;b++}if(b>max_weather)return alert("Unable to add more Weather sensors"),-1;askForm("<form><fieldset><br />DRAFT:<p>You have created weather station nr "+b+'. Please specify name</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><br /><label for="val_2">Address: </label><input type="text" name="val_2" id="val_2" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',
function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);var c=a[0];a=a[1];for(var d=0;d<weather.length&&weather[d].addr!=a;d++);if(d!=weather.length)return alert("The weather address "+a+" is already registered"),0;1<=debug&&alert("New weather on ind: "+b+", name: "+c+", addr: "+a);c={id:b,name:c,brand:"",addr:a,unit:"0",val:"0",type:"switch",scene:""};weather.push(c);logger("Added new weather "+neweather.name);send2dbase("add_weather",c);s_weather_id=b;init_weather("init");return 1},function(){activate_weather(s_weather_id);
return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Weather: </label><select id="val_1" value="val_1" >',d=[];for(a=0;a<weather.length;a++)-1==$.inArray(weather[a].id,d)&&(c+="<option>"+weather[a].name+"</option>",d[d.length]=weather[a].id);a="<form><fieldset><br>DRAFT:</br><br />You are planning to delete a sensor from the system. If you do so, all actions associated with the sensor must be deleted too.\nPlease start with selecting a sensor from the list.<br /><br />"+(c+
"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=weather.length-1;0<=b;b--)if(2<debug&&alert("working with i: "+b+", weather id: "+weather[b].name),weather[b].name==a){var c=weather.splice(b,1);0<persist&&(logger(c[0]),send2dbase("delete_weather",c[0]),1<debug&&myAlert("Removed from dbase:: id: "+c[0].id+" , name: "+c[0].name))}s_weather_id=weather[0].id;init_weather("init");return 1},function(){activate_weather(s_weather_id);
return 1},"Confirm Delete weather");break;case "Help":helpForm("Weather","This is the Help screen for weather stations and sensors\n\nIn the header section you see an overview of your sensors defined, which enables you to view/change or add sensors to a station of your choice. \n\nThe Content section in the middle shows for each defined station the dials, it will only show those sensors available for a station\nIt is quite good possible to change the layout of the dials, as well as color etc.\nAt the moment these style definitions are part of the steel subdirectory");
$(".cw_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_content").on("click",".ce_button",function(a){a.preventDefault();selected=$(this);
value=$(this).val();id=$(a.target).attr("id");$(".ce_button").removeClass("hover");$(this).addClass("hover");window.open("http://"+w_url+"/graphs/energy.html","_parent");$(this).removeClass("hover")});$("#gui_header").on("click",".hc_button",function(a){a.preventDefault();selected=$(this);$(".hc_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_setting(id)});$("#gui_header").on("click",".cc_button",function(a){a.preventDefault();selected=
$(this);$(".cc_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":alert("Add a Setting");break;case "Del":break;case "Help":alert("This is the Help screen for Setting Configuration\n\nIn the header section you see buttons to select a configuration item, each one will show a form where you can change certain settings. ");$(".cc_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}});$("#gui_content").on("click",
".scene_button",function(a){a.preventDefault();a.stopPropagation();value=$(this).val();var b=$(a.target).attr("id"),c=get_scene(s_scene_id),d=c.name,e=c.seq.split(",");logger("scene handler:: scene_name: "+d,2);switch(b.substr(0,2)){case "Fq":d='!FqP"'+c.name+'"';message_device("scene","run",d);break;case "Fe":d='!FeP"'+c.name+'"='+c.seq;send2dbase("store_scene",c);break;case "Fx":2<debug&&alert("Activate_screen:: Delete Fx button pressed");var f="Deleted actions ";$($("#gui_scenes .scene").get().reverse()).each(function(a){var b=
$(this).children().children(".dlabels").attr("id");a=parse_int(b)[1];$(this).children().children('input[type="checkbox"]').is(":checked")&&(1<debug&&alert("delete scene id: "+b+", index: "+a+" selected"),b=e.splice(2*(a-1),2),a--,1<debug&&alert("removed:"+b[0]+","+b[1]+": from seq: "+e),f+=a+" : "+decode_scene_string(b[0])+"; ")});message(f);for(c=0;c<scenes.length;c++)if(scenes[c].id==s_scene_id){"undefined"==typeof e?2<debug&&alert("activate_scene:: case FX: scene_split undefined"):(scenes[c].seq=
e.join(),2<debug&&alert("seq: "+scenes[c].seq));break}activate_scene(s_scene_id);break;case "Fc":d='!FcP"'+c.name+'"';alert("Cancel current Sequence: "+c.name+"\nScene cmd: "+d);message_device("scene","cancel",d);break;case "Fr":2<debug&&alert("Activate_screen:: Add Fr button pressed, start recording ...");myConfirm("You are about to add a new action to the scene. If you continue, the system will be in recording mode until you have selected a device action. Then you are returned to this scene screen again. Please confirm if you want to add a device. ",
function(){message('<p style="textdecoration: blink; background-color:red; color:white;">RECORDING</p>')},function(){s_recording=0;return 1},"Adding a Device action?");s_recording=1;s_recorder="";init_rooms("init");break;case "Ft":for(var m=$(a.target).val(),c="",d=0;24>d;d++)c=d==m.substr(0,2)?c+('<option selected="selected">'+("00"+d).slice(-2)+"</option>"):c+("<option>"+("00"+d).slice(-2)+"</option>");for(var n="",d=0;60>d;d++)n=d==m.substr(3,2)?n+('<option selected="selected">'+("00"+d).slice(-2)+
"</option>"):n+("<option>"+("00"+d).slice(-2)+"</option>");for(var l="",d=0;60>d;d++)l=d==m.substr(6,2)?l+('<option selected="selected">'+("00"+d).slice(-2)+"</option>"):l+("<option>"+("00"+d).slice(-2)+"</option>");c='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm:ss</p><br /><label style="width:50px;" for="val_1">hrs: </label><select id="val_1" value="'+m.substr(0,2)+'" >'+c+'</select><label style="width:50px;" for="val_2">mins: </label><select id="val_2" value="'+
m.substr(3,2)+'">'+n+'</select><label style="width:50px;" for="val_3">secs: </label><select id="val_3" selectedIndex="10" value="'+m.substr(6,2)+'">'+l+"</select></fieldset></form>";askForm(c,function(c){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+c);c=c[0]+":"+c[1]+":"+c[2];$(a.target).val(c);2<debug&&alert("Timer changed from "+m+" to: "+$(a.target).val());var d=parse_int(b)[1];e[2*(d-1)+1]=c;var f="";$("#gui_scenes .scene").each(function(a){a=$(this).children().children(".dbuttons").attr("id");
a=parse_int(a)[1];f+=e[2*(a-1)]+","+e[2*(a-1)+1]+","});f=f.slice(0,-1);c=idx_scene(s_scene_id);logger("store_scene:: sindex: "+c+",my_list :"+f);logger("store_scene: "+c+", "+scenes[c].name+", my_list: "+f);scenes[c].seq=f;2<debug&&alert("new scene_list:: "+f);return 0},function(){return 1},"Confirm Change");break;default:alert("Sequence action unknown: "+b.substr(-2))}});if(1==jqmobile)if(1==phonegap&&1==dynamicIP){$("#popup").empty();"undefined"!==typeof Storage?(rooms=localStorage.getItem("rooms"),
devices=localStorage.getItem("devices"),settings=localStorage.getItem("settings"),init()):alert("no localStorage");var b;b='<form><fieldset><div><label for="saddr">IP:</label>';b=(null!==d?b+('<input type="text" name="saddr" id="saddr" value="'+d+'" />'):b+'<input type="text" name="saddr" id="saddr" placeholder="server ip" />')+"</div>\n";b+='<div><label for="uname">Username:</label>';b=null!==e?b+('<input type="text" name="uname" id="uname" value="'+e+'"/>'):b+'<input type="text" name="uname" id="uname" placeholder="username"/>';
b+="</div>\n";b+='<div><label for="pword">Password:</label>';b=null!==f?b+('<input type="password" name="pword" id="pword" value="'+f+'"/>'):b+'<input type="password" name="pword" id="pword" placeholder="pin"/>';b+="</div></fieldset></form>";var a=$("<div/>").popup({id:"popform",dismissible:!1,theme:"b",overlayTheme:"a",title:"Confirm Login",maxWidth:"500px",transition:"pop"}).bind("popupafterclose",function(){logger("popupafterclose");$(this).remove()});$("<div/>",{text:"Confirm Login"}).appendTo(a);
$(b,{}).appendTo(a);$("<a>",{text:"SUBMIT"}).buttonMarkup({inline:!0,icon:"check"}).on("click",function(){logger("Start submit");var b=$("#uname").val(),d=$("#saddr").val(),e=$("#pword").val();murl="http://"+d+"/";"undefined"!==typeof Storage&&(localStorage.setItem("uname",b),localStorage.setItem("saddr",d),localStorage.setItem("pword",e));0<settings.length?logger("Database already read"):(logger("Submit saddr: "+d),0>load_database("init")?alert("Error:: loading database failed"):logger("load_database returns success"));
a.popup("close");1==settings[1].val&&1!=phonegap?(logger("calling init_websockets"),c()):alert("Either Phonegap OR Raspi Set");logger("Submit done")}).appendTo(a);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).on("click",function(){logger("Start Cancel",2);a.popup("close");logger("End Cancel",2)}).appendTo(a);1==phonegap?(logger("Do Phonegap",2),a.popup("open"),logger("Do Phonegap done",2)):(logger("No Phonegap",2),a.popup("open"),logger("No Phonegap return",
2))}else b=load_database("init"),0>b&&alert("Error:: loading database failed"),1==settings[1].val&&1!=phonegap&&c();else{if("undefined"!==typeof Storage){logger("Loading user and database settings from localStorage",1);var e=localStorage.getItem("uname"),f=localStorage.getItem("pword"),d=localStorage.getItem("saddr");rooms=localStorage.getObject("rooms");devices=localStorage.getObject("devices");scenes=localStorage.getObject("scenes");timers=localStorage.getObject("timers");handsets=localStorage.getObject("handsets");
brands=localStorage.getObject("brands");weather=localStorage.getObject("weather");settings=localStorage.getObject("settings")}1!=phonegap&&c();b=load_database("init");0>b&&alert("Error:: loading database failed")}})}
function init(){debug=settings[0].val;cntrl=settings[1].val;s_controller=0==cntrl?murl+"frontend_ics.php":murl+"frontend_rasp.php";mysql=settings[2].val;persist=settings[3].val;1!=jqmobile&&("undefined"!==typeof Storage?(skin=localStorage.getItem("skin"),logger("init:: localStorage, skin: "+skin,1)):logger("init:: No localStorage support for skin",1),null==skin&&(skin=settings[4].val),$("link[href^='styles']").attr("href",skin));use_weather=settings[7].val;use_energy=settings[8].val;setInterval(function(){send2daemon("ping",
"","");0<healthcount&&healthcount--;logger("healthcount:: "+healthcount,2);$("#health-slider").val(healthcount);$("#health-slider").slider("option","value",healthcount)},1E4);energy.kw_hi_use=0;energy.kw_lo_use=0;energy.kw_hi_ret=0;energy.kw_lo_ret=0;energy.gas_use=0;energy.kw_act_use=0;energy.kw_act_ret=0;energy.kw_ph1_use=0;energy.kw_ph2_use=0;energy.kw_ph3_use=0;if("undefined"!==typeof Storage){var c=localStorage.getItem("uname"),b=localStorage.getItem("pword");logger("init:: localStorage, uname: "+
c+", pword: "+b)}else logger("init:: No localStorage support");devices.sort(function(a,b){return a.id<b.id?-1:a.id>b.id?1:0});if(2<=debug)for(c=0;c<devices.length;c++)logger("devices i: "+c+", id: "+devices[c].id+", name: "+devices[c].name);init_rooms(s_room_id);init_menu(s_setting_id)}function logger(c,b){3<=debug&&alert("Message called: "+c+", lvl: "+b+", debug: "+debug);"undefined"===typeof b&&(b=debug);b<=debug&&console.log(c)}
function message(c,b,a){2<debug&&alert("Message called: "+c+", lvl: "+b+", debug: "+debug);"undefined"===typeof b&&(b=debug);b<=debug&&($("#gui_messages").empty(""),c='<div id="comment">'+c+"</div>",$("#gui_messages").append(c));return 0}Storage.prototype.setObject=function(c,b){logger("setObject:: key: "+c+":"+JSON.stringify(b),2);this.setItem(c,JSON.stringify(b))};
Storage.prototype.getObject=function(c){var b=this.getItem(c);logger("getObject:: type: "+typeof b+", key: "+c+":"+JSON.stringify(b),2);if(null==b)return null;try{JSON.parse(b)}catch(a){return logger("getObject:: Exception error JSON parse"),null}return b&&JSON.parse(b)};function getTime(){var c=new Date;return pad(c.getHours(),2)+":"+pad(c.getMinutes(),2)+":"+pad(c.getSeconds(),2)}function parse_int(c){return c.match(/\d+\.?\d*/g)}function read_int(c){return c.match(/\d+\.?\d*/g)[0]}
function myAlert(c,b){$('<div style="padding:10px; min-width:250px; max-width:800px; max-height:500px; overflow:scroll; word-wrap:break-word;">'+c+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:b||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){$(this).dialog("destroy")}}})}
function myConfirm(c,b,a,e){$('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+c+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:e||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){"function"==typeof b&&setTimeout(b,50);$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}}})}
function helpForm(c,b,a,e){if(1==jqmobile){$("#header").empty();var f=$("<div/>").popup({id:"popform",dismissible:!1,theme:"a",overlayTheme:"a",maxWidth:"400px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<h2/>",{text:c}).appendTo(f);$("<p/>",{text:b}).appendTo(f);$("<a>",{text:"Read More"}).buttonMarkup({inline:!0,icon:"check"}).on("click",function(){if("function"==typeof a){var b=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val()];
setTimeout(function(){a(b)},50)}switch(s_screen){case "room":var c=window.open("http://platenspeler.github.io/LamPI-1.9/gh-pages/rooms.html","_blank");c.focus();break;case "scene":c=window.open("http://platenspeler.github.io/LamPI-1.9/gh-pages/scenes.html","_blank");c.focus();break;case "timer":c=window.open("http://platenspeler.github.io/LamPI-1.9/gh-pages/timers.html","_blank");c.focus();break;case "handset":c=window.open("http://platenspeler.github.io/LamPI-1.9/gh-pages/handsets.html","_blank");
c.focus();break;case "weather":c=window.open("http://platenspeler.github.io/LamPI-1.9/gh-pages/weather.html","_blank"),c.focus()}2<=debug&&alert("Read More for screen: "+s_screen);f.popup("close")}).appendTo(f);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).on("click",function(){f.popup("close");1<debug&&alert("cancel")}).appendTo(f);f.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,
modal:!0,resizable:!1,width:"auto",title:c||"Help",minHeight:120,buttons:{More:function(){"function"==typeof a&&setTimeout(function(){a(ret)},50);switch(s_screen){case "room":var b=window.open("http://platenspeler.github.io/LamPI-2.0/gh-pages/UserGuide/rooms.html","_blank");b.focus();break;case "scene":b=window.open("http://platenspeler.github.io/LamPI-2.0/gh-pages/UserGuide/scenes.html","_blank");b.focus();break;case "timer":b=window.open("http://platenspeler.github.io/LamPI-2.0/gh-pages/UserGuide/timers.html",
"_blank");b.focus();break;case "handset":b=window.open("http://platenspeler.github.io/LamPI-2.0/gh-pages/UserGuide/handsets.html","_blank");b.focus();break;case "weather":b=window.open("http://platenspeler.github.io/LamPI-2.0/gh-pages/UserGuide/weather.html","_blank"),b.focus()}$(this).dialog("destroy")},Done:function(){"function"==typeof e&&setTimeout(e,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function checkLength(c,b,a,e){return c.val().length>e||c.val().length<a?(c.addClass("ui-state-error"),updateTips("Length of "+b+" must be between "+a+" and "+e+"."),!1):!0}
function askForm(c,b,a,e){if(1==jqmobile){$("#header").empty();var f=$("<div/>").popup({id:"popform",dismissible:!1,theme:"b",overlayTheme:"a",title:e||"Confirm",maxWidth:"500px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<div/>",{text:e}).appendTo(f);$(c,{}).appendTo(f);$("<a>",{text:"Submit"}).buttonMarkup({inline:!0,icon:"check"}).bind("click",function(){if("function"==typeof b){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),
,$("#val_5").val()];setTimeout(function(){b(a)},50)}2<=debug&&alert("Submit");f.popup("close")}).appendTo(f);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).bind("click",function(){"function"==typeof a&&setTimeout(a,50);f.popup("close");1<debug&&alert("cancel")}).appendTo(f);f.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+c+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:e||"Confirm",minHeight:120,
dialogClass:"askform",buttons:{OK:function(){if("function"==typeof b){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),$("#val_5").val()];setTimeout(function(){b(a)},50)}$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function init_rooms(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="";for(var b=0;b<rooms.length;b++)room_name=rooms[b].name,room_id=rooms[b].id,c=room_id==s_room_id?c+room_button(room_id,room_name,"hover"):c+room_button(room_id,room_name);$("#gui_header_content").append(c);c='<input type="submit" id="Add"  value= "+"  class="cr_button new_button"><input type="submit" id="Del"  value= "X"  class="cr_button del_button"><input type="submit" id="Help" value= "?" class="cr_button help_button">';
$("#gui_header_controls").append(c);c='<div id="health-slider" class="slider-health" ></div>';$("#gui_header_controls").append(c);$(function(){logger("Starting Healthcount Slider function",2);$("#health-slider").slider({range:"max",min:0,max:9,value:healthcount,slide:function(a,b){$("#health-slider").val(b.value);var c=healthcount;2>=c?$(".slider-health").css("background","#4ea6cf"):2<c&&3>=c?$(".slider-health").css("background","#5ac5cf"):3<c&&4>=c?$(".slider-health").css("background","#7dd7bf"):
4<c&&5>=c?$(".slider-health").css("background","#b1cfa1"):5<c&&6>=c?$(".slider-health").css("background","#e5bf7c"):6<c&&7>=c?$(".slider-health").css("background","#d79168"):7<c&&8>=c?$("#health-slider").css("background","#cd7159"):8<c&&$(".slider-health").css("background","#c4463a")}})});s_screen="room";activate_room(s_room_id)}
function init_scenes(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="Init Scenes, scenes read: ";for(var b="",a=0;a<scenes.length;a++){var e=scenes[a].id,f=scenes[a].name;c+=a+", ";b=e==s_scene_id?b+scene_button(e,f,"hover"):b+scene_button(e,f)}1<debug&&message(c);$("#gui_header_content").append(b);b='<input type="submit" id="Add" value= "+" class="cs_button new_button"><input type="submit" id="Del" value= "X" class="cs_button del_button"><input type="submit" id="Help" value= "?" class="cs_button help_button">';
$("#gui_header_controls").append(b);s_screen="scene";activate_scene(s_scene_id)}
function init_timers(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="Init Timers, timers read: ";for(var b="",a=0;a<timers.length;a++){var e=timers[a].id,f=timers[a].name;c+=a+", ";b=e==s_timer_id?b+timer_button(e,f,"hover"):b+timer_button(e,f)}1<debug&&message(c);$("#gui_header_content").append(b);b='<input type="submit" id="Add" value= "+" class="ct_button new_button"><input type="submit" id="Del" value= "X" class="ct_button del_button">';b+=
'<input type="submit" id="Help" value= "?" class="ct_button help_button">';$("#gui_header_controls").append(b);s_screen="timer";activate_timer(s_timer_id)}
function init_handsets(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="Init Handsets, handsets read: ";for(var b="",a=[],e=0;e<handsets.length;e++)if(-1==$.inArray(handsets[e].id,a)){var f=handsets[e].id,d=handsets[e].name;c+=e+", ";b=f==s_handset_id?b+handset_button(f,d,"hover"):b+handset_button(f,d);a[a.length]=handsets[e].id}1<debug&&message(c);$("#gui_header_content").append(b);b='<input type="submit" id="Add" value= "+" class="ch_button new_button"><input type="submit" id="Del" value= "X" class="ch_button del_button">';
b+='<input type="submit" id="Help" value= "?" class="ch_button help_button">';$("#gui_header_controls").append(b);s_screen="handset";activate_handset(s_handset_id)}
function init_weather(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="Init weather, config read: ";var b="";""==s_weather_id&&(s_weather_id=weather[0].location);for(var a=[],e=0;e<weather.length;e++)if(-1==$.inArray(weather[e].location,a)){var f=weather[e].location;c+=e+", ";b=f==s_weather_id?b+weather_button(f,f,"hover"):b+weather_button(f,f);a[a.length]=weather[e].location}1<debug&&message(c);$("#gui_header_content").append(b);
b='<input type="submit" id="Help" value= "?" class="cw_button help_button">';$("#gui_header_controls").append(b);s_screen="weather";activate_weather(s_weather_id)}
function init_energy(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="";$("#gui_header_content").append(c);1<debug&&message("Init energy, config read: ");c='<input type="submit" id="Help" value= "?" class="cw_button help_button">';$("#gui_header_controls").append(c);s_screen="energy";activate_energy(s_energy_id)}
function init_settings(c){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);c="Init Config, config read: ";for(var b="",a=0;a<settings.length;a++){var e=settings[a].id,f=settings[a].name;c+=a+", ";b=e==s_setting_id?b+setting_button(e,f,"hover"):b+setting_button(e,f)}1<debug&&message(c);$("#gui_header_content").append(b);b='<input type="submit" id="Help" value= "?" class="cc_button help_button"></td>';$("#gui_header_controls").append(b);
s_screen="config";activate_setting(s_setting_id)}
function init_menu(c){$("#gui_menu").empty();html_msg='<table border="0">';$("#gui_menu").append(html_msg);c=$("#gui_menu").children();if(1==jqmobile){var b='<tr><td><input type="submit" id="M1" value= "Rooms" class="hm_button hover"><input type="submit" id="M2" value= "Scenes" class="hm_button"><input type="submit" id="M3" value= "Timers" class="hm_button"><input type="submit" id="M4" value= "Handsets" class="hm_button">';0<weather.length&&(b+='<input type="submit" id="M6" value= "Weather" class="hm_button">');b+=
'<input type="submit" id="M5" value= "Config" class="hm_button"></td></tr>'}else b='<tr><td><input type="submit" id="M1" value= "Rooms" class="hm_button hover"></td><tr><td><input type="submit" id="M2" value= "Scenes" class="hm_button"></td><tr><td><input type="submit" id="M3" value= "Timers" class="hm_button"></td><tr><td><input type="submit" id="M4" value= "Handsets" class="hm_button"></td>',0<weather.length&&(b+='<tr><td><input type="submit" id="M6" value= "Weather" class="hm_button"></td>'),0<
use_energy&&(b+='<tr><td><input type="submit" id="M7" value= "Energy" class="hm_button"></td>'),b+='<tr><td></td><tr><td></td><tr><td><input type="submit" id="M5" value= "Config" class="hm_button"></td></table>';$(c).append(b);$("#gui_menu").on("click",".hm_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hm_button").removeClass("hover");$(this).addClass("hover");switch(id){case "M1":init_rooms("init");break;case "M2":init_scenes(s_scene_id);
break;case "M3":init_timers();break;case "M4":init_handsets();break;case "M5":init_settings();break;case "M6":init_weather();break;case "M7":init_energy();break;default:message("init_menu:: id: "+id+" not a valid menu option")}})}
function activate_room(c,b){for(var a,e,f=0;f<rooms.length;f++)if(rooms[f].id==c){e=rooms[f].name;break}$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");a='<div id="gui_devices"></div>';$("#gui_content").append(a);a='<table border="0">';$("#gui_devices").append(a);var f=$("#gui_devices").children(),d='<thead><tr class="headrow switch">',d=("Del"==b?d+'<td colspan="2">':d+"<td>")+'<input type="submit" id="Rx" value="X" class="dbuttons del_button" ><input type="submit" id="Ra" value="+" class="dbuttons new_button" ></td>',
d=d+('<td class="filler" align="center">'+e+"</td>");1!=jqmobile&&(d+="<td></td>");d+='<td><input type="submit" id="Fa" value="ALL OFF" class="dbuttons all_off_button" ></td>';$(f).append(d);$(f).append("</tr>");a="</thead><tbody>";$(f).append(a);f=$("#gui_devices tbody").last();for(e=0;e<devices.length;e++){var g=devices[e].id,h=devices[e].room;if(h==c){a=devices[e].name;var k=devices[e].type,d=devices[e].val,r,p;0==d?(r=" hover",p=""):(r="",p=" hover");switch(k){case "switch":1==jqmobile?(d='<tr class="devrow switch">',
"Del"==b&&(d+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),d+='<td colspan="2"><input type="text" id="'+g+'" value="'+a+'" class="dlabels"></td>',d+='<td><input type="submit" id="'+g+'F0" value="OFF" class="dbuttons off_button'+r+'">',d+='<input type="submit" id="'+g+'F1" value="ON" class="dbuttons on_button'+p+'"></td>'):(d='<tr class="devrow switch">',"Del"==b&&(d+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),
d+='<td colspan="2"><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td>',d+="<td></td>",d+='<td><input type="submit" id="'+g+'F0" value= "OFF" class="dbuttons off_button'+r+'">',d+='    <input type="submit" id="'+g+'F1" value= "ON" class="dbuttons on_button'+p+'"></td>');$(f).append(d);break;case "dimmer":1==jqmobile?(k='<tr class="devrow dimrow">',"Del"==b&&(k+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),k+='<td colspan="2"><label for="'+
g+'Fd">'+a+"</label>",k+='<input type="number" data-type="range" style="min-width:32px;" id="'+g+'Fd" name="'+g+'Fl" value="'+d+'" min=0 max=31 data-highlight="true" data-mini="false" data-theme="b" class="ddimmer"/></td>',k+='<td><input type="submit" id="'+g+'F0" value= "OFF" class="dbuttons off_button'+r+'" />',k+='<input type="submit" id="'+g+'F1" value= "ON" class="dbuttons on_button'+p+'" /></td>',k+="</tr>"):(k='<tr class="devrow dimrow">',"Del"==b&&(k+='<td><input type="checkbox" id="'+g+'c" name="cb'+
g+'" value="yes" class="dbuttons"></td>'),k+='<td><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td><td><div id="'+g+'Fd" class="slider slider-dimmer"></div></td><td><input type="text" id="'+g+'Fl" class="slidval"></td><td><input type="submit" id="'+g+'F0" value="OFF" class="dbuttons off_button'+r+'">    <input type="submit" id="'+g+'F1" value="ON" class="dbuttons on_button'+p+'"></td></tr>');f.append(k);var q="#"+g+"Fl",m="#"+g+"Fd";1==jqmobile?$(function(){var a=load_device(h,
g);"F0"==a&&(a=0);$(m).slider({stop:function(a,b){var c=$(a.target).attr("id"),d=$(a.target).val();0==d?(handle_device(c.slice(0,-2),"F"+d),$("#"+c.slice(0,-2)+"F1").removeClass("hover"),$("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$("#"+c.slice(0,-2)+"F0").removeClass("hover"),$("#"+c.slice(0,-2)+"F1").addClass("hover"));store_device(s_room_id,c.slice(0,-2),d)}});$(m).slider("refresh")}):$(function(){var a=load_device(h,g);"F0"==a&&(a=0);$(m).slider({range:"max",main:1,min:0,
max:32,value:a,slide:function(a,b){var c="#"+$(a.target).attr("id").slice(0,-1)+"l";$(c).val(b.value)},stop:function(a,b){var c=$(a.target).attr("id"),d=b.value;0==d?(d=0,handle_device(c.slice(0,-2),"F"+d),$(this).parent().siblings().children().removeClass("hover"),$(this).parent().siblings().children("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$(this).parent().siblings().children().removeClass("hover"),$(this).parent().siblings().children("#"+c.slice(0,-2)+"F1").addClass("hover"));
store_device(s_room_id,c.slice(0,-2),d)}});$(q).val(a)});break;case "thermostat":1==jqmobile?(k='<tr class="devrow dimrow">',"Del"==b&&(k+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),k+='<td colspan="2"><label for="'+g+'Fd">'+a+"</label>",k+='<input type="number" data-type="range" style="min-width:32px;" id="'+g+'Fd" name="'+g+'Fl" value="'+d+'" min=15 max=25 data-highlight="true" data-mini="false" data-theme="b" class="ddimmer"/></td>',k+="<td></td>",
k+="</tr>"):(k='<tr class="devrow dimrow">',"Del"==b&&(k+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),k+='<td><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td><td><div id="'+g+'Fd" class="slider slider-thermo"></div></td><td><input type="text" id="'+g+'Fl" class="slidval"></td><td></td></tr>');f.append(k);q="#"+g+"Fl";m="#"+g+"Fd";1==jqmobile?$(function(){var a=load_device(h,g);"F0"==a&&(a=0);$(m).slider({stop:function(a,b){var c=
$(a.target).attr("id"),d=$(a.target).val();0==d?(handle_device(c.slice(0,-2),"F"+d),$("#"+c.slice(0,-2)+"F1").removeClass("hover"),$("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$("#"+c.slice(0,-2)+"F0").removeClass("hover"),$("#"+c.slice(0,-2)+"F1").addClass("hover"));store_device(s_room_id,c.slice(0,-2),d)}});$(m).slider("refresh")}):$(function(){var a=load_device(h,g);$(m).slider({range:"max",main:1,min:15,max:25,value:a,slide:function(a,b){var c="#"+$(a.target).attr("id").slice(0,
-1)+"l";$(c).val(b.value)},stop:function(a,b){var c=$(a.target).attr("id"),d=b.value;handle_device(c,"P"+d);store_device(s_room_id,c.slice(0,-2),d)}});$(q).val(a)});break;default:alert("lamp_button, type: "+k+" unknown")}}}s_room_id=c;$("#gui_devices").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();var d=$(a.target).attr("id");switch(d){case "Ra":2<debug&&alert("activate_room:: Add Device Button: "+d);for(var e=1;e<=max_devices;){for(a=0;a<devices.length&&(devices[a].room!=
s_room_id||devices[a].id.substr(1)!=e);a++);if(a==devices.length)break;e++}1<debug&&alert("Add device:: room:"+s_room_id+", device: "+e+", devices.length: "+devices.length);d='<label for="val_3">  Select Brand: </label><select id="val_3" value="kaku">';for(a=0;a<brands.length;a++)d+="<option>"+brands[a].name+"</option>";askForm('<form id="addRoomForm"><fieldset><p>You have created a new device, please give it a name and specify its type and brand. Optionally, the group address can be set if this device address is different from the room address</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Type: </label><select id="val_2" value="switch" ><option selected="selected">switch</option><option>dimmer</option><br /><option>thermostat</option></select><br />'+
(d+"</select><br />")+'<label for="val_4">Group addr: </label><input type="text" name="val_4" id="val_4" value="'+(Number(s_room_id)+99)+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_5">Unit addr: </label><input type="text" name="val_5" id="val_5" value="'+e+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);for(var b,c,d=0;d<brands.length;d++)brands[d].name==a[2]&&(b=brands[d].id,c=brands[d].fname);
if("dimmer"==a[1]&&("kaku"!=c||"zwave"!=c))return alert("Type dimmer is not supported for brand "+c),1;if("thermostat"==a[1]&&"zwave"!=c)return alert("Type thermostat is not supported for brand "+c),1;a={id:"D"+e,room:""+s_room_id+"",gaddr:a[3],name:a[0],type:a[1],uaddr:a[4],val:"0",lastval:"0",brand:b};devices.push(a);logger(a,2);send2dbase("add_device",a);activate_room(s_room_id);return 1},function(){activate_room(c);return 1},"Confirm Create");return 1;case "Rx":return message('<p style="textdecoration: blink; background-color:yellow; color:black;">Click a button to delete ...</p>'),
activate_room(c,"Del"),1;case "Fa":handle_device("","Fa");for(a=0;a<devices.length;a++)devices[a].room==s_room_id&&"thermostat"!=devices[a].type&&(store_device(s_room_id,devices[a].id,"OFF"),logger("activate_room:: All Off command for device: "+devices[a].uaddr,2));activate_room(s_room_id);return 1}if("Del"==b&&"checkbox"==$(this).attr("type")){1>debug&&$("#gui_messages").empty();var f=d.slice(0,-1),g=find_device(s_room_id,f),k=$(this);message("Device to delete: id Name"+devices[g].name,0);myConfirm("You have selected device "+
devices[g].name+" for deletion. Do you really want to delete this device?",function(){k.closest("tr").remove();var a=devices.splice(g,1);0<persist&&(logger(a[0]),send2dbase("delete_device",a[0]),1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name));1<debug&&alert("Removed object id:"+f);activate_room(c);return 1},function(){activate_room(c);return 1},"Confirm Delete");return 1}if("Sel"==b&&"checkbox"==$(this).attr("type"))return message("Device Add",1),alert("Device Add\nid: "+
f),1;d=$(this).attr("id");f=d.slice(0,-2);value=$(this).val();handle_device(f,value);store_device(s_room_id,f,value);1==jqmobile?(d="0"==d.substr(-1,1)?d.slice(0,-1)+"1":d.slice(0,-1)+"0",$("#"+d).removeClass("hover")):$(this).parent().siblings().children().removeClass("hover");$(this).addClass("hover");button_class=$(a.target).parent().parent().attr("class");"devrow dimrow"==button_class&&(a="#"+f+"Fd",value=load_device(s_room_id,f),"OFF"==value&&(value=0),1==jqmobile?($(a).val(value),$(a).slider("refresh")):
($(a).slider("option","value",value),$("#"+f+"Fl").val(value)))});if(1!=jqmobile){var n;$("#gui_devices tbody").last().sortable({start:function(a,b){$(b.item).data("startindex",b.item.index());n=b.item.index();logger("Start pos: "+n)},stop:function(a,b){var c=b.item.index(),d,e;logger("sortable:: start_pos: "+n+", stop_pos: "+c);for(var f=g=0;f<devices.length;f++)devices[f].room==s_room_id&&(g==n?e=f:g==c&&(d=f),g++);logger("room: "+s_room_id+",start_index: "+e+", stop_index: "+d);logger("room: "+
s_room_id+",start_pos:   "+n+", stop_pos:     "+c);c=devices.splice(e,1);devices.splice(d,0,c[0]);logger("name of device moved: "+c[0].name);for(var g=1,f=0;f<devices.length;f++)devices[f].room==s_room_id&&(devices[f].id="D"+g,logger("storing device: id: "+devices[f].id+", name: "+devices[f].name),g++)}}).disableSelection()}}
function activate_scene(c){$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");html_msg='<div id="gui_scenes"></div>';$("#gui_content").append(html_msg);for(var b=0;b<scenes.length;b++){var a=scenes[b].id;if(c==a){2<debug&&alert("Activate_screen:: Making buttons for scene: "+a);html_msg='<table border="0">';$("#gui_scenes").append(html_msg);var e=$("#gui_scenes").children(),f=scenes[b].seq,d='<thead><tr class="switch"><td colspan="2"><input type="submit" id="Fx'+a+'" value="X" class="dbuttons scene_button del_button"><input type="submit" id="Fr'+
a+'" value="+" class="dbuttons scene_button new_button"></td><td colspan="2"><input type="input"  id="Fl'+a+'" value= "'+scenes[b].name+'" class="dlabels"></td><td><input type="submit" id="Fc'+a+'" value="STOP" class="dbuttons scene_button"><input type="submit" id="Fe'+a+'" value="Store" class="dbuttons scene_button"><input type="submit" id="Fq'+a+'" value=">" class="dbuttons scene_button play_button"></td></thead>';$(e).append(d);$(e).append("<tbody>");if(""!=f)for(var g=f.split(","),f=0;f<g.length;f+=
2){var h=f/2+1,d=decode_scene_string(g[f]);decode_scene_string(g[f+1]);d='<tr class="scene"><td><input type="checkbox" id="s'+a+'c" name="cb'+h+'" value="yes"></td><td> '+h+'<td><input type="input" id="Fs'+a+"i"+h+'" value= "'+g[f]+'" class="dlabels sval"></td><td><input type="text" id="Ft'+a+"t"+h+'" value= "'+g[f+1]+'" class="dbuttons scene_button sval"></td><td>'+d;$(e).append(d)}else h=0;1==s_recording&&(d=decode_scene_string(s_recorder),logger("Need to decode s_recorder"),s_recording=0,h++,d=
'<tr class="scene"><td><input type="checkbox" id="s'+a+'c" name="cb'+h+'" value="yes"></td><td>'+h+'<td><input type="input" id="Fs'+a+"i"+h+'" value= "'+s_recorder+'" class="dlabels sval"></td><td><input type="text" id="Ft'+a+"t"+h+'" value= "00:00:10" class="dbuttons scene_button sval"></td><td colspan="2">'+d,$(e).append(d),scenes[b].seq=1==h?s_recorder+",00:00:10":scenes[b].seq+(","+s_recorder+",00:00:10"),2<debug&&alert("Recorder adding:: j: "+b+", s_scene_id: "+s_scene_id+"\n\n id: "+scenes[b].id+
"\nval: "+scenes[b].val+"\n name: "+scenes[b].name+"\nseq: "+scenes[b].seq),send2dbase("store_scene",scenes[b]),message("Device command added to the scene"))}}1!=jqmobile&&$("#gui_scenes tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){var d="";$("#gui_scenes .scene").each(function(a){var b=$(this).children().children(".dbuttons").attr("id").substr(4);logger("scn: "+c+" html index: "+a+" scene ind: "+b);d+=g[2*(b-1)]+","+g[2*(b-1)+1]+","});logger("my_list :"+
d);d=d.slice(0,-1);logger("scene: "+c+", "+scenes[c-1].name+", my_list: "+d);scenes[c-1].seq=d}}).disableSelection();s_scene_id=c}
function activate_timer(c){2<debug&&alert("activate_timer");$("#gui_content").empty();html_msg='<div id="gui_timers"></div>';$("#gui_content").append(html_msg);for(var b=0;b<timers.length;b++){var a=timers[b].id;if(c==a){var e=timers[b];html_msg='<table border="0">';$("#gui_timers").append(html_msg);var f=$("#gui_timers").children(),d='<thead><tr class="switch"><td><input type="submit" id="'+a+'Fe" value="Store" class="dbuttons play_button" style="min-width:100px;"></td><td><input type="input"  id="'+
a+'Fl" value="'+timers[b].name+'" class="dlabels"></td><td><input type="submit" id="'+a+'Fx" value="Cancel Once" class="dbuttons stop_button" ></td></thead>';$(f).append(d);$(f).append("<tbody>");a="<tr>";a+='<td><label for="scene">Select Scene: </label></td>';a+='<td><select id="scene" value="scene" style="font-size:normal;" class="dlabels">';for(h=0;h<scenes.length;h++)a=scenes[h].name==e.scene?a+('<option class="dlabels" value="'+scenes[h].name+'" selected>'+scenes[h].name+"</option>"):a+('<option class="dlabels" value="'+
scenes[h].name+'" >'+scenes[h].name+"</option>");a+="</select></td>";d='<tr class="timer"><form><fieldset name="scene_select">'+a+"<br /></fieldset></form>";$(f).append(d);a=e.tstart.split(":");d='<td><input type="text" id="Tv" value= "';switch(a[0]){case "96":d+="Sunrise - "+30*a[1]+" minutes";break;case "97":d+="Sunrise + "+30*a[1]+" minutes";break;case "98":d+="Sunset - "+30*a[1]+" minutes";break;case "99":d+="Sunset + "+30*a[1]+" minutes";break;default:d+=("00"+a[0]).slice(-2)+":"+("00"+a[1]).slice(-2)}d+=
'" class="dlabels sval" style="width:120px;">';d+="</td>";str3="<td>";str3+='<input type="submit" id="Ts" value="Time" class="dbuttons timbut">';str3+='<input type="submit" id="Tr" value="SunRise" class="dbuttons timbut" >';str3+='<input type="submit" id="Td" value="SunSet" class="dbuttons timbut" >';str3+="</select></td>";d='<tr class="timer"><tr><td><label for="tstart">Start time: </label></td>'+d+"<form><fieldset>"+str3+"<br /></fieldset></form></tr>";$(f).append(d);$(".timbut").removeClass("hover");
"96"==a[0]||"97"==a[0]?$("#Tr").addClass("hover"):"98"==a[0]||"99"==a[0]?$("#Td").addClass("hover"):$("#Ts").addClass("hover");a="<td>Start Date: </td>";if(1!=jqmobile)a+='<td><input  class="dlabels" type="text" id="startd" value="'+e.startd+'"/></td>',d='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(f).append(d),$(function(){$("#startd").datepicker({dateFormat:"dd/mm/y"})});else{var d=e.startd.substr(0,2),g=e.startd.substr(3,2),h=e.startd.substr(6,2),a=a+('<td><input  class="dlabels" type="text" min="2013-12-15" id="startd" value="20'+
h+"-"+g+"-"+d+'"/></td>'),d='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>";$(f).append(d);startd=$("#startd").mobipick({dateFormat:"dd/MM/yy"});startd.on("change",function(){e.startd=$("#startd").val();alert("startd:: "+e.startd)})}a="<td>End Date: </td>";1!=jqmobile?(a+='<td><input  class="dlabels" type="text" id="endd" value="'+e.endd+'"/></td>',d='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(f).append(d),$(function(){$("#endd").datepicker({dateFormat:"dd/mm/y"})})):
(d=e.endd.substr(0,2),g=e.endd.substr(3,2),h=e.endd.substr(6,2),a+='<td><input  class="dlabels" type="text" min="2013-12-15" id="endd" value="20'+h+"-"+g+"-"+d+'"/></td>',d='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(f).append(d),endd=$("#endd").mobipick({dateFormat:"dd/MM/yy"}),endd.on("change",function(){e.endd=$("#endd").val()}));for(var a='<td colspan="3"><br /><div class="days">',d="Mon Tue Wed Thu Fri Sat Sun".split(" "),h=0;7>h;h++)a="x"!=e.days.substr(h,1)?a+(" "+d[h]+
'<input type="checkbox" id="'+h+'" name="'+d[h]+'" value="'+h+'" checked="checked" >'):a+(" "+d[h]+'<input type="checkbox" id="'+h+'" name="'+d[h]+'" value="'+h+'" >');a+="</div></td>";d='<tr><td colspan="3"><p>On what days of the week?</p></td></tr>';d+='<tr class="timer">'+a+"<br></tr>";$(f).append(d);a='<tr><td colspan="3"><a>What months should the timer run?</a></td></tr>';a+='<tr class="timer"><td colspan="3"><br /><div class="months">';g="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");
for(h=0;12>h;h++)a="x"!=e.months.substr(h,1)?a+(" "+g[h]+'<input type="checkbox" id="'+h+'" name="'+g[h]+'" value="'+h+'" checked="checked">'):a+(" "+g[h]+'<input type="checkbox" id="'+h+'" name="'+g[h]+'" value="'+h+'">');a+="</div></td><br></tr>";$(f).append(a);$("#gui_timers").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();a=$(a.target).attr("id");var b=get_timer(s_timer_id);switch(a.substr(-2)){case "Fe":var c=$.map($(".days :input:checkbox:checked"),function(a,b){return+a.value}),
d="xxxxxxx";a="mtwtfss";for(var e=0;e<c.length;e++)d=d.substr(0,c[e])+a.substr(c[e],1)+d.substr(c[e]+1);b.days=d;c=$.map($(".months :input:checkbox:checked"),function(a,b){return+a.value});d="xxxxxxxxxxxx";a="jfmamjjasond";for(e=0;e<c.length;e++)d=d.substr(0,c[e])+a.substr(c[e],1)+d.substr(c[e]+1);b.months=d;b.scene=$("#scene").val();b.startd=$("#startd").val();b.endd=$("#endd").val();a="STORE timer::\n, scene: "+b.scene+"\n, tstart: "+b.tstart+"\n, startd: "+b.startd+"\n, endd: "+b.endd+"\n, days: "+
b.days+"\n, months: "+b.months+"\n, skip: "+b.skip+"\n";1<=debug&&logger("store_timer"+a);send2dbase("store_timer",b);break;case "Fx":$(".timbut").removeClass("hover");$("#Fx").addClass("hover");myConfirm("You are about to cancel this timer. If you continue, the system will for one time skip this timer action",function(){message("Skipping")},function(){message("Not Skipping");return 0},"Cancel this timer once?");b.skip="1";set_timer(s_timer_id,b);send2dbase("store_timer",b);$("#Fx").removeClass("hover");
break;case "Fr":myConfirm("You are about to add a new action to the timer. If you continue, the systemwill be in recording mode until you have selected a device action. Then you are returnedto this timer screen again. Please confirm if you want to add a device.",function(){message('<p style="textdecoration:blink; background-color:red; color:white;">RECORDING</p>')},function(){s_recording=0;return 1},"Adding a Timer action?");s_recording=1;s_recorder="";init_rooms("init");break;case "Ts":$(".timbut").removeClass("hover");
$("#Ts").addClass("hover");for(var f=$("#Tv").val(),c="",e=0;24>e;e++)c=12==e?c+("<option selected>"+("00"+e).slice(-2)+"</option>"):c+("<option>"+("00"+e).slice(-2)+"</option>");a="";for(e=0;60>e;e++)a+="<option>"+("00"+e).slice(-2)+"</option>";a='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm</p><br /><label for="val_1">hrs: </label><select id="val_1" value="'+f.substr(0,2)+'" >'+c+'</select><label for="val_2">mins: </label><select id="val_2" value="'+
f.substr(3,2)+'">'+a+"</select></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);a=a[0]+":"+a[1];$("#Tv").val(a);b.tstart=a;1<debug&&alert("Timer changed from "+f+" to: "+a);set_timer(s_timer_id,b)},function(){},"Confirm Change");break;case "Tr":$(".timbut").removeClass("hover");$("#Tr").addClass("hover");f=$("#Tv").val();a="";for(e=-4;5>e;e++)a=0==e?a+("<option selected>"+30*("00"+e).slice(-2)+"</option>"):a+("<option>"+30*("00"+e).slice(-2)+"</option>");
a='<form id="addRoomForm"><fieldset><p>Setting the timer to start at SunRise</p><br /><label for="val_1">Sunrise offset in minutes: </label><select id="val_1" value="'+f.substr(3,2)+'">'+a+"</select></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);0>a[0]?(laval="SunRise - "+a[0].substr(1)+" minutes",b.tstart="96:"+("00"+a[0]/-30).slice(-2)):(laval="SunRise + "+a[0]+" minutes",b.tstart="97:"+("00"+a[0]/30).slice(-2));$("#Tv").val(laval);1<debug&&alert("Timer changed from "+
f+" to: "+laval);set_timer(s_timer_id,b)},function(){},"Set Sunrise Timer");break;case "Td":$(".timbut").removeClass("hover");$("#Td").addClass("hover");f=$("#Tv").val();a="";for(e=-4;5>e;e++)a=0==e?a+("<option selected>"+30*("00"+e).slice(-2)+"</option>"):a+("<option>"+30*("00"+e).slice(-2)+"</option>");a='<form id="addRoomForm"><fieldset><p>Setting the timer to start at SunSet</p><br /><label for="val_1">Sunset offset in minutes: </label><select id="val_1" value="'+f.substr(3,2)+'">'+a+"</select></fieldset></form>";
askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);0>a[0]?(laval="SunSet - "+a[0].substr(1)+" minutes",b.tstart="98:"+("00"+a[0]/-30).slice(-2)):(laval="SunSet + "+a[0]+" minutes",b.tstart="99:"+("00"+a[0]/30).slice(-2));$("#Tv").val(laval);1<debug&&alert("Timer changed from "+f+" to: "+laval);0>set_timer(s_timer_id,b)&&alert("Cannot set timer values in object")},function(){},"Set Sunset Timer");break;case "Tv":$("#Ts").hasClass("hover")&&alert("Ts time");$("#Tr").hasClass("hover")&&
alert("Tr sunrise");$("#Td").hasClass("hover")&&alert("Td sunsetk");break;default:alert("Sequence action unknown: "+a.substr(-2))}})}}s_timer_id=c}
function activate_handset(c){$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");html_msg='<div id="gui_handsets"></div>';$("#gui_content").append(html_msg);for(var b,a=b=0;a<handsets.length;a++){var e=handsets[a].id;if(c==e){2<debug&&alert("Activate_handset:: Making buttons for handset: "+e);var f=handsets[a].name,d=handsets[a].scene,g=handsets[a].addr,h=handsets[a].unit,k=handsets[a].val;if(0==b){html_msg='<table border="0">';$("#gui_handsets").append(html_msg);var r=$("#gui_handsets").children(),
p='<thead><tr class="switch"><td colspan="2"><input type="submit" id="Fx'+e+'" value="X" class="dbuttons del_button"><input type="submit" id="Fr'+e+'" value="+" class="dbuttons new_button"></td><td colspan="2"><input type="input"  id="Fl'+e+'" value= "'+f+'" class="dlabels"> addr: '+g+'</td><td><input type="submit" id="Fe'+e+'" value="Store" class="dbuttons"></td></thead>';$(r).append(p);$(r).append("<tbody>");b=1}if(""!=d)for(f=d.split(","),g=0;g<f.length;g+=2){var q=g/2+1,p=0==k?"off":"on",m=decode_scene_string(f[g]);
decode_scene_string(f[g+1]);p='<tr class="handset"><td><input type="checkbox" id="s'+e+'c" name="cb'+q+'" value="yes"></td><td>But '+h+" "+p+'</td><td><input type="input" id="Fs'+e+"u"+h+"v"+k+"i"+q+'" value= "'+f[g]+'" class="dlabels sval"></td><td><input type="text" id="Ft'+e+"u"+h+"v"+k+"i"+q+'" value= "'+f[g+1]+'" class="dbuttons sval"></td><td>'+m;$(r).append(p)}else q=0;1==s_recording&&(m=decode_scene_string(s_recorder),logger("Decode s_recorder to: "+m),s_recording=0,q++,p='<tr class="handset"><td><input type="checkbox" id="s'+
e+'c" name="cb'+q+'" value="yes"></td><td>But '+q+'<td><input type="input" id="Fs'+e+"u"+h+"v"+k+"i"+q+'" value= "'+s_recorder+'" class="dlabels sval"></td><td><input type="text" id="Ft'+e+"u"+h+"v"+k+"i"+q+'" value= "00:00:10" class="dbuttons sval"></td><td colspan="2">'+m,$(r).append(p),handsets[a].scene=1==q?s_recorder+",00:00:10":handsets[a].scene+(","+s_recorder+",00:00:10"),2<debug&&alert("Recorder adding:: j: "+a+", s_handset_id: "+s_handset_id+"\n\n id: "+handsets[a].id+"\nval: "+handsets[a].val+
"\n name: "+handsets[a].name+"\nseq: "+handsets[a].scene),send2dbase("store_handset",handsets[a]),message("Device command added to the handsets",1))}}$("#gui_handsets").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();var b=$(a.target).attr("id");parse_int(b);switch(b.substr(0,2)){case "Fe":for(var c=get_handset(s_handset_id),e=c.name,f=0;f<handsets.length;f++)handsets[f].id==s_handset_id&&(logger("Fe Storing handset:: "+e+":"+handsets[f].unit+":"+handsets[f].val),send2dbase("store_handset",
handsets[f]));break;case "Fx":2<debug&&alert("Activate_handset:: Delete Fx button pressed");var g="Deleted actions ";0<debug&&myConfirm("You are about to delete one or more button actions for this handset. If you continue, all lines that you checked will be deleted from the system and this will be synchronized with the database.\nPlease keep in mind that you will delete ALL lines that you checked and and its corresponding actions ",function(){$($("#gui_handsets .handset").get().reverse()).each(function(a){var b=
$(this).children().children(".dlabels").attr("id"),f=$(this).children().children(".dlabels").attr("value"),h=parse_int(b)[0],k=parse_int(b)[1],m=parse_int(b)[2],l=parse_int(b)[3];c=get_handset_record(h,k,m);d=c.scene;var n=d.split(","),l=n.indexOf(f);if($(this).children().children('input[type="checkbox"]').is(":checked"))for(1<debug&&alert("delete handset button: "+e+"\nid: "+b+", scene ind: "+l+" selected, index: "+a+"\nHandset id: "+h+", unit: "+k+", val: "+m+"\nScene: "+d),a=n.splice(l,2),l--,
1<debug&&alert("removed:"+a[0]+","+a[1]+": from seq: "+n),g+=l+" : "+decode_scene_string(a[0])+"; ",l=0;l<handsets.length;l++)if(handsets[l].id==h&&handsets[l].unit==k&&handsets[l].val==m){"undefined"==typeof n?2<debug&&alert("activate_handset:: case FX: handset_split undefined"):(handsets[l].scene=n.join(),2<debug&&alert("scene: "+handsets[l].scene));break}});message(g);activate_handset(s_handset_id)},function(){activate_handset(s_handset_id);return 0},"Continue Deleting Handet(s)?");break;case "Fr":2<
debug&&alert("Activate_handset:: Add Fr button pressed, start recording ...");myConfirm("You are about to add an action to this handset. If you continue, the system will be in recording mode until you have selected a device action. Then you are returned to this scene screen again. Please confirm if you want to add actions to this handset. ",function(){message('<p style="textdecoration: blink; background-color:red; color:white;">RECORDING</p>');s_recording=1;s_recorder="";init_handsets("init")},function(){s_recording=
0;return 1},"Adding a handset action?");break;case "Ft":var h=$(a.target).val(),f="";for(i=0;24>i;i++)f=i==h.substr(0,2)?f+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):f+("<option>"+("00"+i).slice(-2)+"</option>");var k="";for(i=0;60>i;i++)k=i==h.substr(3,2)?k+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):k+("<option>"+("00"+i).slice(-2)+"</option>");var m="";for(i=0;60>i;i++)m=i==h.substr(6,2)?m+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):
m+("<option>"+("00"+i).slice(-2)+"</option>");f='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm:ss</p><br /><label style="width:50px;" for="val_1">hrs: </label><select id="val_1" value="'+h.substr(0,2)+'" >'+f+'</select><label style="width:50px;" for="val_2">mins: </label><select id="val_2" value="'+h.substr(3,2)+'">'+k+'</select><label style="width:50px;" for="val_3">secs: </label><select id="val_3" selectedIndex="10" value="'+h.substr(6,2)+
'">'+m+"</select></fieldset></form>";askForm(f,function(c){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+c);c=c[0]+":"+c[1]+":"+c[2];$(a.target).val(c);2<debug&&alert("Timer changed from "+h+" to: "+$(a.target).val());var d=parse_int(b),e;for(e=0;e<handsets.length&&(handsets[e].id!=d[0]||handsets[e].unit!=d[1]||handsets[e].val!=d[2]);e++);var d=handsets[e].scene.split(","),f=$(a.target).attr("id"),g="Fs"+f.substr(2),k=$("#"+g).val();alert("tid: "+f+", sid: "+g+", sval: "+k);f=d.indexOf(k);
alert("split ind: "+f);d[f+1]=c;handsets[e].scene=d.join();return 0},function(){return 1},"Confirm Change");break;default:alert("Sequence action unknown: "+b.substr(-2))}});1!=jqmobile&&$("#gui_handsets tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){var d="";$("#gui_handsets .scene").each(function(a){var b=$(this).children().children(".dbuttons").attr("id").substr(4);logger("scn: "+c+" html index: "+a+" scene ind: "+b);d+=scene_split[2*(b-1)]+
","+scene_split[2*(b-1)+1]+","});logger("my_list :"+d);d=d.slice(0,-1);logger("scene: "+c+", "+handsets[c-1].name+", my_list: "+d);handsets[c-1].scene=d}}).disableSelection();s_handset_id=c}
function activate_weather(c){$("#gui_messages").empty();$("#gui_content").empty();$("#gui_content").css("overflow-x","auto");html_msg='<div id="gui_weather"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_weather").append(html_msg);for(var b=$("#gui_weather").children(),a=0,e=0;e<weather.length;e++)weather[e].location==c&&a++;var f,d=100/a;f="<tbody><tr>";for(e=0;e<a;e++)f+='<td width="'+d+'%" class="cw_button">',f+='<canvas id="canvasRadial'+(e+1)+'" width="201" height="201"></canvas>',
f+="</td>";f+="</tr><tr>";for(e=0;e<a;e++){var g="canvasRadial"+(a+e+1)+"";f+='<td width="'+d+'%" class="cw_button">';f+='<canvas id="'+g+'" width="201" height="201">No canvas in your browser...</canvas>';f+="</td>"}f+="</tr>";f+="</tbody></table>";$(b).append(f);$.getScript("steel/steelseries-min.js",function(){steelseries.Section(0,25,"rgba(0, 0, 220, 0.3)");steelseries.Section(25,50,"rgba(0, 220, 0, 0.3)");steelseries.Section(50,75,"rgba(220, 220, 0, 0.3)");var b=[steelseries.Section(950,990,"rgba(0, 0, 220, 0.3)"),
steelseries.Section(990,1030,"rgba(0, 220, 0, 0.3)"),steelseries.Section(1030,1050,"rgba(220, 220, 0, 0.3)")];steelseries.Section(75,100,"rgba(220, 0, 0, 0.3)");var d=[steelseries.Section(1050,1100,"rgba(220, 0, 0, 0.3)")],e=new steelseries.gradientWrapper(-20,40,[0,.2,.4,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]),f=new steelseries.gradientWrapper(0,
100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);new steelseries.gradientWrapper(950,1100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);for(var g={},m=0,n=0;n<weather.length;n++)weather[n].location==
c&&("temperature"in weather[n]&&"undefined"!==typeof weather[n].temperature&&""!==weather[n].temperature?(g[m]=new steelseries.RadialBargraph("canvasRadial"+(m+1),{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:-20,maxValue:40,valueGradient:e,useValueGradient:!0,titleString:weather[n].name+"@"+weather[n].location,unitString:"Temp C",threshold:30,lcdVisible:!0}),g[m].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m].setValueAnimated(weather[n].temperature),g[m].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL)):
logger("weather temperature "+m+" is not defined"),"humidity"in weather[n]&&"undefined"!==typeof weather[n].humidity&&""!==weather[n].humidity?(g[m+a]=new steelseries.RadialBargraph("canvasRadial"+(m+a+1),{gaugeType:steelseries.GaugeType.TYPE4,size:201,valueGradient:f,useValueGradient:!0,titleString:weather[n].location,unitString:"Humidity %",threshold:80,lcdVisible:!0}),g[m+a].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m+a].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL),
g[m+a].setValueAnimated(weather[n].humidity)):logger("weather humidity "+m+" is not defined"),"airpressure"in weather[n]&&"undefined"!==typeof weather[n].airpressure&&""!==weather[n].airpressure?(logger("iradial "+(m+a)+",j: "+n+" set airpressure: "+weather[n].airpressure),g[m+a]=new steelseries.RadialBargraph("canvasRadial"+(m+a+1),{gaugeType:steelseries.GaugeType.TYPE3,size:201,minValue:950,maxValue:1100,area:d,section:b,useSectionColors:!0,titleString:weather[n].location,unitString:"Pressure Pa",
threshold:80,lcdVisible:!0}),g[m+a].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m+a].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL),g[m+a].setValueAnimated(weather[n].airpressure)):logger("weather airpressure "+m+" is not defined"),m++);var l;l=setInterval(function(){if("weather"==s_screen){for(var b=0,d=0;d<weather.length;d++)weather[d].location==c&&("temperature"in weather[d]&&void 0!==weather[d].temperature&&""!=weather[d].temperature?g[b].setValueAnimated(weather[d].temperature):
message("not set temperature. ",3),"humidity"in weather[d]&&void 0!==weather[d].humidity&&""!=weather[d].humidity?(message("radial "+(b+a)+",j: "+d+" set humidity: "+weather[d].humidity,2),g[b+a].setValueAnimated(weather[d].humidity)):message("not set humidity. ",3),"airpressure"in weather[d]&&void 0!==weather[d].airpressure&&""!=weather[d].airpressure?(message("airpressure: "+weather[d].airpressure,2),g[b+a].setValueAnimated(weather[d].airpressure)):message("not set airpressure. ",3),b++);b=w_sock.readyState;
1!=b&&(logger("Websocket:: error. State is: "+b),message("Websocket:: error. State is: "+b))}else clearInterval(l),message("Suspend Dials")},2E3)})}
function activate_energy(c){$("#gui_messages").empty();$("#gui_content").empty();$("#gui_content").css("overflow-x","auto");html_msg='<div id="gui_energy"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_energy").append(html_msg);c=$("#gui_energy").children();for(var b="<tbody><tr>",a=0;4>a;a++)b+='<td width="25%" class="ce_button">',b+='<canvas id="canvasRadial'+(a+1)+'" width="201" height="201"></canvas>',b+="</td>";b+="</tr><tr>";for(a=0;4>a;a++)var e="canvasRadial"+
(4+a+1)+"",b=b+'<td width="25%" class="ce_button">',b=b+('<canvas id="'+e+'" width="201" height="201">No canvas in your browser...</canvas>'),b=b+"</td>";b+="</tr>";b+="</tbody></table>";$(c).append(b);$.getScript("steel/steelseries-min.js",function(){steelseries.Section(0,25,"rgba(0, 0, 220, 0.3)");steelseries.Section(25,50,"rgba(0, 220, 0, 0.3)");steelseries.Section(50,75,"rgba(220, 220, 0, 0.3)");steelseries.Section(950,990,"rgba(0, 0, 220, 0.3)");steelseries.Section(990,1030,"rgba(0, 220, 0, 0.3)");
steelseries.Section(1030,1050,"rgba(220, 220, 0, 0.3)");steelseries.Section(75,100,"rgba(220, 0, 0, 0.3)");steelseries.Section(1050,1100,"rgba(220, 0, 0, 0.3)");var a=new steelseries.gradientWrapper(0,5E3,[0,.2,.4,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);new steelseries.gradientWrapper(0,100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,
1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);var b={};b[0]=new steelseries.RadialBargraph("canvasRadial1",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Actual",unitString:"kW",threshold:30,lcdVisible:!0});b[0].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[0].setValueAnimated(energy.kw_act_use);b[0].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);
b[1]=new steelseries.RadialBargraph("canvasRadial2",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 1",unitString:"kW",threshold:75,lcdVisible:!0});b[1].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[1].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[1].setValueAnimated(energy.kw_ph1_use);b[2]=new steelseries.RadialBargraph("canvasRadial3",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,
maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 2",unitString:"kW",threshold:75,lcdVisible:!0});b[2].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[2].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[2].setValueAnimated(energy.kw_ph2_use);b[3]=new steelseries.RadialBargraph("canvasRadial4",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 3",unitString:"kW",threshold:75,lcdVisible:!0});
b[3].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[3].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[3].setValueAnimated(energy.kw_ph3_use);b[4]=new steelseries.RadialBargraph("canvasRadial5",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Hi Use",unitString:"kWhr",threshold:75,lcdVisible:!0});b[4].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[4].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);
b[4].setValueAnimated(energy.kw_hi_use);b[5]=new steelseries.RadialBargraph("canvasRadial6",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Lo Use",unitString:"kWhr",threshold:75,lcdVisible:!0});b[5].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[5].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[5].setValueAnimated(energy.kw_lo_use);b[7]=new steelseries.RadialBargraph("canvasRadial8",{gaugeType:steelseries.GaugeType.TYPE4,
size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Gas Use",unitString:"m3",threshold:75,lcdVisible:!0});b[7].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[7].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[7].setValueAnimated(energy.gas_use);var c;c=setInterval(function(){if("energy"==s_screen){b[0].setValueAnimated(energy.kw_act_use);b[1].setValueAnimated(energy.kw_ph1_use);b[2].setValueAnimated(energy.kw_ph2_use);b[3].setValueAnimated(energy.kw_ph3_use);
b[4].setValueAnimated(energy.kw_hi_use);b[5].setValueAnimated(energy.kw_lo_use);b[7].setValueAnimated(energy.gas_use);var a=w_sock.readyState;1!=a&&(logger("Websocket:: error. State is: "+a),message("Websocket:: error. State is: "+a))}else clearInterval(c),message("Suspend Dials"),logger("activate_energy:: s_screen is: "+s_screen)},2E3)})}
function activate_setting(c){$("#gui_content").empty();switch(c+""){case "0":html_msg='<table border="0">';$("#gui_content").append(html_msg);var b=$("#gui_content").children(),a='<tr class="switch"><td>Select the debug level: </td>';$(b).append(a);a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset" checked="checked"><label for="d0">L0</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">L1</label><input type="radio" name="choice" id="d2" value="2" class="buttonset"><label for="d2">L2</label><input type="radio" name="choice" id="d3" value="3" class="buttonset"><label for="d3">L3</label></span></td>';
$(b).append(a);c=" <br>This is some text to explain the use of the debug parameter. During normal operation, the parameter should  be set to 0, which means no debug messages are displayed and only a condensed set of status messages will be shown. <li>Level 1: Will set debug level so that more messages are displayed in the message area <li>Level 2: Will add popup alerts for the main things/buttons/events <li>Level 3: All error and comment messages are displayed <br /><br> ";$(b).append("<tr><td><span>"+
c+"</span>");debug=settings[0].val;$("#choice").buttonset();$("#d"+debug).attr("checked",!0).button("refresh");$("#choice input[type=radio]").change(function(){debug=this.value;settings[0].val=debug;0<persist&&(0<debug&&myAlert("Set : "+settings[0].name+" to "+settings[0].val,"DEBUG LEVEL"),send2dbase("store_setting",settings[0]));message("debug level set to "+debug)});break;case "1":html_msg='<table border="0">';$("#gui_content").append(html_msg);b=$("#gui_content").children();a='<tr class="switch"><td>Select which controller to use: </td>';
$(b).append(a);a=1==jqmobile?'<td><div data-role="controlgroup" data-type="horizontal"><input type="radio" name="choice" id="d0" value="0" class="buttonset" checked="checked"><label for="d0">ICS-1000</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">Raspberry</label></div></td>':'<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset" checked="checked"><label for="d0">ICS-1000</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">Raspberry</label></span></td>';
$(b).append(a);c="<br>\tThis parameter describes which controller we will use to send lamp commands to the devices. \tThe ICS-1000 is a safe choice in case you have one. For users that have a Raspberry PI \tand a 433 MHz transmitter (and implemented the commands as found in backend_rasp.php) \tit's much more fun to use the latter. Remember to pair your device with either or both.\t<br /><br>";$(b).append("<tr><td><span>"+c+"</span>");cntrl=settings[1].val;1==jqmobile?($("#d"+cntrl).attr("checked",
!0).button("refresh"),$(".buttonset").bind("click",function(a,b){cntrl=$(a.target).val();0==cntrl?(alert("Setting controller to ICS-1000"),s_controller=murl+"frontend_ics.php"):(alert("Setting controller to Raspberry"),s_controller=murl+"frontend_rasp.php");message("Controller value value set to "+cntrl);settings[1].val=cntrl;0<persist&&send2dbase("store_setting",settings[1])})):($("#choice").buttonset(),$("#d"+cntrl).attr("checked",!0).button("refresh"),$("#choice input[type=radio]").change(function(a){cntrl=
this.value;0==cntrl?(myAlert("Setting controller to ICS-1000"),s_controller=murl+"frontend_ics.php"):(myAlert("Setting controller to Raspberry"),s_controller=murl+"frontend_rasp.php");message("Controller value value set to "+cntrl);settings[1].val=cntrl;0<persist&&(1<debug&&alert("Set : "+settings[1].name+" to "+settings[1].val),send2dbase("store_setting",settings[1]))}));break;case "2":html_msg='<table border="0">';$("#gui_content").append(html_msg);b=$("#gui_content").children();a='<tr class="switch"><td>Select SQL use or plain files: </td>';
$(b).append(a);a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset"><label for="d0">Files</label><input type="radio" name="choice" id="d1" value="1" class="buttonset" checked="checked"><label for="d1">SQL</label></span></td>';$(b).append(a);c="<br>\tThis parameter describes what kind of storage we use on the backend. \tThe simplest solution is using files for storage, but then we will not be able to\tsynchronize all ations on the client with storage. <br><br>\tAt the moment, only MySQL is implemented! (and it works like a charm)\t<br /><br> ";
$(b).append("<tr><td><span>"+c+"</span>");mysql=settings[2].val;$("#choice").buttonset();$("#d"+mysql).attr("checked",!0).button("refresh");$("#choice input[type=radio]").change(function(){mysql=this.value;settings[2].val=mysql;0<persist&&(0<debug&&alert("Set : "+settings[2].name+" to "+settings[2].val),send2dbase("store_setting",settings[2]));message("MySQL value set to "+mysql)});break;case "3":html_msg='<table border="0">';$("#gui_content").append(html_msg);b=$("#gui_content").children();a='<tr class="switch"><td>Select persistence to the database: </td>';
$(b).append(a);a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset"><label for="d0">Easy</label><input type="radio" name="choice" id="d1" value="1" class="buttonset" checked="checked"><label for="d1">Relaxed</label><input type="radio" name="choice" id="d2" value="2" class="buttonset"><label for="d2">Strict</label></span></td>';$(b).append(a);c="<br>\t\tThis parameter deals with the persistence of the data to the SQL database. <li>Easy: Button changes are locally saved, and will be remembered in this session. \t\tConfiguration changes to scenes/timers are saved to memory only. \t\tRe-ordering buttons in sequences are cosmetic only, as soon as you move away from the page \t\tchanges are forgotten <li>Relaxed: Changes in devices are remembered during the session and are written to the backend \t\tchanges in sequences are not. When other users use remotes or other jqmobile apps,\t\trelaxed still has advantages, although remembering buttons settings between sessions is less useful<li>Strict: As far as possible, every change in configuration data will be written to the \t\tbackend database. More traffic overhead, slower performance, but maximum consistency of \t\tthe database also between different webusers or sessions.";
$(b).append("<tr><td><span>"+c+"</span>");persist=settings[3].val;$("#choice").buttonset();$("#d"+persist).attr("checked",!0).button("refresh");$("#choice input[type=radio]").change(function(){persist=this.value;settings[3].val=persist;message("Persist value set to "+persist);0<=persist&&(0<debug&&alert("Set : "+settings[3].name+" to "+settings[3].val),send2dbase("store_setting",settings[3]))});break;case "4":$("#gui_content").empty();html_msg='<div id="gui_skin"></div>';$("#gui_content").append(html_msg);
html_msg='<table border="0">';$("#gui_skin").append(html_msg);"undefined"!==typeof Storage&&localStorage.getItem("skin");b=$("#gui_skin").children();a='<thead><tr class="switch"><td colspan="2">Choose your Style/Skin setting </td></tr></thead>';$(b).append(a);c="This option allows you to set the skin for your LamPI application. It will allow you to make your own selection of skins in a /styles/yourskin.css file, and make it the style of choice for your setting.<br><br>";c+="Note: Not supported on mobile devices!<br>";
c+="Note: Better not choose a files for use on mobile devices ...<br><br>";$(b).append('<tr><td colspan="2"><span>'+c+"</span>");$(b).append('<tr><td colspan="2">current skin is: <a class="dlabels">'+skin+"</a></td></tr><br><br><br>");var e='<fieldset><label for="load_skin">Select File: </label><select id="load_skin" value="styles/classic-blue.css" style="width:300px;" class="select-file">',f=[];logger("Calling dir read for: styles",0);logger("Host: "+window.location.host,1);c=window.location.host.split(":");
$.ajax({url:"http://"+c[0]+"/styles",success:function(c){$(c).find("a:contains(.css)").each(function(){var a=this.href.replace(window.location.host,"").replace(window.location.pathname,"").replace("http://",""),b=f.push("styles/"+a);logger("Filename: "+a+", new files length: "+b)});logger("Skin selection #files: "+f.length);for(c=0;c<f.length;c++)e=f[c]==settings[4].val?e+("<option selected>"+f[c]+"</option>"):e+("<option>"+f[c]+"</option>");e+="</select>";e+="</fieldset>";a='<tr><td><input type="submit" name="load_button" id="d1" value="load" class="dbuttons cc_button"><label for="d1">Load Configuration</label><td><form action="">'+
e+"</form></td></tr>";$(b).append(a)}});$("#gui_skin").on("click",".dbuttons",function(a){a=this.value;message("Skin selected "+a);switch(a){case "load":skin=$("#load_skin").val();$("link[href^='styles']").attr("href",skin);myConfirm("Do you want to set the "+skin+" Skin file as your default skin for users that start the application? Otherwise the existing default skin "+settings[4].val+" will be used. Please note that if you press cancel this skin will still be used in your current browser sesssion until you load another skin",
function(){message("updating the database");settings[4].val=skin;send2dbase("store_setting",settings[4])},function(){message("Not updated");return 0},"Set Default?");"undefined"!==typeof Storage&&(localStorage.setItem("skin",skin),1<=debug&&logger("Set localstorage skin: "+skin));activate_setting(4);break;default:myAlert("Unknown option for Skin/Styles Setting: "+bak)}});break;case "5":$("#gui_content").empty();html_msg='<div id="gui_backup"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';
$("#gui_backup").append(html_msg);b=$("#gui_backup").children();a='<thead><tr class="switch"><td colspan="2">What Backup or Restore action can we organize for you </td></tr></thead>';$(b).append(a);c="<br>This page allows you to perform some backup and restore functions.<br>It allows you to restore your database to a previous/known state,for example if you messed up.<br>Making regular backups of your configuration to file will greatly help in restoring to a useful state if something goes wrong.<br/><br/>The database.cfg file is one of the default files for the system, so please use another name for your backup.<br/><br/>NOTE: At this moment we do not check for overwriting existing files.<br/>";
$(b).append('<tr><td colspan="2"><span>'+c+"</span></td>");e='<fieldset><label for="load_config">Select File: </label><select id="load_config" value="load" class="dlabels" style="width:200px;">';f={};f=send2set("list_config","*cfg");e+="<option>   </option>";for(c=0;c<f.length;c++)e+="<option>"+f[c]+"</option>";e+="</select>";e+="</fieldset>";a='<tr><td><input type="submit" name="store_button" id="d0" value="store" class="dbuttons buttonset"><label for="d0">Backup the configuration</label></td><td><fieldset>To File &nbsp&nbsp:&nbsp&nbsp<input type="input" id="store_config" value="" class="dlabels" style="width:200px;"></fieldset></td></tr><tr><td><input type="submit" name="load_button" id="d1" value="load" class="dbuttons cc_button"><label for="d1">Load Configuration</label><td><form action="">'+
e+"</form></td></tr>";$(b).append(a);$("#gui_backup").on("click",".dbuttons",function(a){bak=this.value;message("Backup Restore function chosen "+bak);switch(bak){case "store":a=$("#store_config").val();".cfg"!=a.substr(-4)&&(a+=".cfg");send2set("store_config",a);0<debug&&myAlert("Backup: "+a);break;case "load":a=$("#load_config").val();send2set("load_config",a);1<=debug?myAlert("The configuration file is now set to: "+a,"CONFIGURATION"):message("Configuration file loaded "+a);break;default:myAlert("Unknown option for Backup Setting: "+
bak)}});break;case "6":$("#gui_content").empty();html_msg='<div id="gui_console"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_console").append(html_msg);b=$("#gui_console").children();a='<thead><tr class="switch"><td colspan="2">Select your console function</td></tr></thead>';$(b).append(a);a='<thead><tr class="switch">';1==jqmobile?a+='<td><input type="submit" id="Cc" value="Clients" class="dbuttons" ></td>':(a+="<td>",a+='<input type="submit" id="Cc" value="Connected Clients" class="dbuttons" >',
a+='<input type="submit" id="Cs" value="Sunrise Sunset" class="dbuttons" >',a+='<input type="submit" id="Cl" value="Daemon log" class="dbuttons" >',a+='<input type="submit" id="Cz" value="Zway log" class="dbuttons" >',a+='<input type="submit" id="Cr" value="Daemon Restart" class="dbuttons" >',a+="</td>");$(b).append(a);$(b).append("</tr>");$("#gui_console").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();a=$(a.target).attr("id");switch(a.substr(0,2)){case "Cl":a={tcnt:++w_tcnt%
1E3,action:"console",request:"logs"};logger(a);message("Console Log request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cz":a={tcnt:++w_tcnt%1E3,action:"console",request:"zlogs"};logger(a);message("Console ZLog request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cs":a={tcnt:++w_tcnt%1E3,action:"console",request:"sunrisesunset"};logger(a);message("Console Sunrise/Sunset request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cc":a={tcnt:++w_tcnt%1E3,
action:"console",request:"clients"};logger(a);message("Console Client request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cr":a={tcnt:++w_tcnt%1E3,action:"console",request:"rebootdaemon"};logger(a);message("Console Client request sent to server",1);w_sock.send(JSON.stringify(a));break;default:alert("Console action unknown: "+a.substr(-2))}});break;case "7":logger("init_settings:: weather selected",2);break;case "8":logger("init_settings:: energy selected",2);break;default:myAlert("Config encountered internal error: unknown button "+
c)}}function room_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="hr_button '+a+'">'}function scene_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="hs_button '+a+'">'}function menu_button(c,b,a){return'<td><input type="submit" id="'+c+'" value= "'+b+'" class="hm_button '+a+'"></td>'}function timer_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="ht_button '+a+'">'}
function handset_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="hh_button '+a+'">'}function weather_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="hw_button '+a+'">'}function setting_button(c,b,a){return'<input type="submit" id="'+c+'" value= "'+b+'" class="hc_button '+a+'">'}
function store_device(c,b,a){for(var e=0;e<devices.length;e++){var f=devices[e].id;if(devices[e].room==c&&f==b){c=devices[e].type;"OFF"==a&&"switch"==c?devices[e].val=0:"ON"==a&&"switch"==c?devices[e].val=1:"ON"==a&&"dimmer"==c?devices[e].val=devices[e].lastval:"OFF"==a&&"dimmer"==c?devices[e].val=0:(devices[e].val=a,devices[e].lastval=a);break}}return 1}function find_device(c,b){for(var a=0;a<devices.length;a++){var e=devices[a].id;if(devices[a].room==c&&e==b)return a}return-1}
function lookup_uaddr(c,b){for(var a=0;a<devices.length;a++){var e=devices[a].uaddr;if(devices[a].room==c&&e==b)return a}logger("lookp_uaddr:: No index in devices found for room: "+c+", dev id: "+b,1);return-1}function load_device(c,b){for(var a=0;a<devices.length;a++){var e=devices[a].id;if(devices[a].room==c&&e==b)return devices[a].val}return 1}function get_scene(c){for(var b=0;b<scenes.length;b++)if(scenes[b].id==c)return scenes[b];return-1}
function idx_scene(c){for(var b=0;b<scenes.length;b++)if(scenes[b].id==c)return b;return-1}function get_handset(c){for(var b=0;b<handsets.length;b++)if(handsets[b].id==c)return handsets[b];return 1}function get_handset_record(c,b,a){for(var e=0;e<handsets.length;e++)if(handsets[e].id==c&&handsets[e].unit==b&&handsets[e].val==a)return handsets[e];return 1}function get_timer(c){for(var b=0;b<timers.length;b++)if(timers[b].id==c)return timers[b];return-1}
function set_timer(c,b){for(var a=0;a<timers.length;a++)if(timers[a].id==c)return timers[a]=b,0;return-1}
function decode_scene_string(c){logger("decode_scene_string: "+c,2);var b,a,e,f;b=0;switch(c.substr(b,1)){case "!":b++;f="";"R"==c.substr(b,1)?(b++,e=c.substr(b+1,1),"D"==e||"F"==e?(a=c.substr(b,1),b++):(a=c.substr(b,2),b+=2)):alert("decode_scene: Room not found in command string");for(var d=0;d<rooms.length;d++)rooms[d].id==a&&(f+=rooms[d].name);if("D"==c.substr(b,1)){f+=", ";b++;"F"==c.substr(b+1,1)?(e=c.substr(b,1),b++):(e=c.substr(b,2),b+=2);for(d=0;d<devices.length;d++)if(devices[d].uaddr==e&&
devices[d].room==a)switch(f+=devices[d].name,devices[d].type){case "dimmer":f+=", dimmer";break;case "switch":f+=", switch";break;default:alert("decode_scene:: Unsupported devicetype: "+devices[d].type)}if("F"==c.substr(b,1))switch(b++,a=c.substr(b,1),a){case "a":f+=", ALL OFF";break;case "o":f+=", set dimmer";break;case "0":f+=", OFF";break;case "1":f+=", ON";break;case "k":f+=", Man. Lock";break;case "l":f+=", Full Lock";break;case "d":b++,"P"==c.substr(b,1)&&(b++,f+=", dim value: "+c.substr(b))}}else"F"==
c.substr(b,1)?f+=", All off":alert("Unknown syntax: "+e+" at this position. cmd:: "+c);break;case "0":f="Timing delay "+c.substr(1)}return f}
function load_database(c){var b=murl+"frontend_sql.php";3<=debug?alert("load_database:: sqlServer:: "+b):logger("load_database:: sqlServer: "+b,2);if(1!=phonegap){logger("load_database:: Calling send2daemon with load_database, "+c+" , "+c,2);var a;a=setInterval(function(){var b=w_sock.readyState;1!=b?(logger("Websocket:: error. State is: "+b),message("Websocket:: error. State is: "+b)):(clearInterval(a),message("Loading Database"),send2daemon("load_database",c,c))},500);return 1}1!=phonegap&&0!=settings[1].val||
logger("load_database:: Using good old ajax style",1);$.ajax({url:b,async:!1,type:"GET",dataType:"json",data:{action:"load_database",message:c},timeout:6E3,success:function(a){rooms=a.appmsg.rooms;devices=a.appmsg.devices;scenes=a.appmsg.scenes;timers=a.appmsg.timers;handsets=a.appmsg.handsets;settings=a.appmsg.settings;brands=a.appmsg.brands;weather=a.appmsg.weather;$("#gui_header").append('<table border="0">');$("#gui_header").children();init();1<debug&&alert("Ajax call load_database success. \nTransaction Nr: "+
a.tcnt+",\nStatus: "+a.status+".\nApp Msg: "+a.appmsg+".\nApp Err: "+a.apperr);but="Load_database success";1<debug&&(but+="<br>AppErr: "+a.apperr);message(but);return 0},error:function(a,f,d){1<debug?alert("load_database:: Error "+b+" sending cmd:: "+c+"\nError: "+a.status+"\nTextStatus: "+f+"\nerrorThrown: "+d+"\n\nFunction load_database will finish now!"):alert("Timeout connecting to database on "+b);rooms=localStorage.getItem("rooms");devices=localStorage.getItem("devices");return-1}})}
function handle_device(c,b){var a="",e="",f="";3<=debug&&alert("handle_device:: \nid: "+c+"\nval: "+b);switch(b){case "Fo":a+="Fo";break;case "ON":case "F1":for(var d=0;d<devices.length;d++)if(devices[d].id==c&&devices[d].room==s_room_id){a="dimmer"==devices[d].type?a+"FdP"+devices[d].lastval:a+"F1";break}break;case "OFF":case "F0":a+="F0";break;case "DUP":a+="S1";break;case "D":alert("handle_device:: "+b+" command not recognized");break;case "Fa":return f="!R"+s_room_id+"Fa",message_device("gui",
e,f),1;default:a=a+"Fd"+b}for(d=0;d<devices.length;d++)if(devices[d].id==c.substr(0,2)&&devices[d].room==s_room_id){f=devices[d].uaddr;e=brands[devices[d].brand].fname;f="!R"+s_room_id+"D"+f+a;break}logger("handle_device:: action is: "+e+", lamp command code is: "+f);message_device("gui",e,f)}
function send2daemon(c,b,a){logger("send2daemon: action: "+c+", cmd: "+b,2);c={tcnt:++w_tcnt%1E3+"",type:"raw",action:c,cmd:b,message:a};for(b=0;4>b;b++)switch(w_sock.readyState){case 0:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 1:return logger("send2daemon:: sending: "+JSON.stringify(c),2),w_sock.send(JSON.stringify(c)),0;case 2:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 3:setTimeout(function(){logger("send2daemon:: socket not ready: "+
w_sock.readyState,2)},1E3);break;default:logger("send2daemon:: readystate not defined: "+w_sock.readyState,1)}logger("send2daemon:: unable to transmit message 4 times: "+w_sock.readyState,1);return-1}
function message_device(c,b,a){if(s_recording)return s_recorder+=a,activate_scene(s_scene_id),1;1!=phonegap&&1==settings[1].val?(logger("message_device:: Calling send2daemon with "+c+", "+b+", "+a,2),send2daemon(c,b,a)):1==phonegap||0==settings[1].val?$.ajax({url:s_controller,type:"POST",dataType:"json",data:{action:b,message:a},timeout:5E3,success:function(b){switch(b.status){case "OK":var f="Dev cmd "+a+" <br>Status: "+b.status+", Return: "+b.appmsg;2<=debug&&(f+="\nAppErr: "+b.apperr);message(f);
break;case "ERR":f="Dev cmd:"+c+","+a+" <br>Status: "+b.status+" Error: "+b.apperr,message(f)}2<=debug&&myAlert("message_device: "+c+"\ntransaction:"+b.tcnt+"\nStatus: "+b.status+"\n\nApp Msg: "+b.appmsg+"\n\nApp Err: "+b.apperr)},error:function(b,f,d){myAlert("Message_device Error on "+c+"\ncontroller_cmd: "+a+"\njqXHR: "+b+"\ntextstatus"+f+", "+d)}}):message("message_device:: xmit faked");return 1}
function send2dbase(c,b){1!=phonegap&&1==settings[1].val?(logger("send2dbase:: Receiving websocket command "+c+", dbase_arg: <"+b+">"),send2daemon("dbase",c,b)):1==phonegap||0==settings[1].val?(logger("send_2_database:: Receiving ajax command "+c),$.ajax({url:murl+"frontend_sql.php",type:"POST",dataType:"json",data:{action:c,message:b},timeout:8E3,success:function(a){0<debug&&message("Send 2 dbase:: Success");1<debug&&alert("Ajax call send2dbase: "+c+" success: \n,\nStatus: "+a.status+".\nApp Msg: "+
a.appmsg+".\nApp Err: "+a.apperr);message(a.appmsg)},error:function(a,b,c){alert("send2dbase:: request failed \nError: "+a.responseText+"\nTextStatus: "+b+"\nerrorThrown: "+c+"\n\nFunction send2dbase will finish now!");return-1}})):message("send2dbase:: Error database message")}
function send2set(c,b){if(1!=phonegap&&1==settings[1].val)logger("send2set:: Receiving websocket command "+c+", set_arg: <"+b+">"),send2daemon("setting",c,b);else{if(1==phonegap||0==settings[1].val){var a={};$.ajax({async:!1,url:murl+"frontend_set.php",type:"POST",dataType:"json",data:{action:c,message:b},timeout:7E3,success:function(b){0<debug&&message("send2set:: Success");1<debug&&alert("Ajax call send2set success: \n,\nStatus: "+b.status+".\nApp Msg: "+b.appmsg+".\nApp Err: "+b.apperr);return a=
b.appmsg},error:function(a,b,d){alert("send2set:: command: "+c+"\nError:"+a+"\nTextStatus: "+b+"\nerrorThrown: "+d+"\n\nFunction send2set will finish now!");return-1}});2<debug&&alert("send2set:: returning"+a);return a}message("send2dbase:: Error database message")}};