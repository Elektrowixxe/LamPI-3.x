var healthcount=5,healthtime=1E4,use_energy=0,loginprocess=!1,s_screen="config",s_scene_id=1,s_timer_id=1,s_handset_id=1,s_sensor_id="",s_energy_id=0,s_setting_id=0,s_recorder="",s_recording=0,s_room_id=1,max_rooms=16,max_scenes=16,max_devices=16,max_timers=16,max_handsets=8,max_sensors=8,lroot={},rooms={},devices={},scenes={},timers={},brands={},handsets={},weather={},sensors={},energy={},settings={},rules={},users={};
function logger(b,d){3<=debug&&alert("Message called: "+b+", lvl: "+d+", debug: "+debug);"undefined"===typeof d&&(d=debug);d<=debug&&console.log(b)}function message(b,d,a){2<debug&&alert("Message called: "+b+", lvl: "+d+", debug: "+debug);"undefined"===typeof d&&(d=debug);d<=debug&&($("#gui_messages").empty(""),b='<div id="comment">'+b+"</div>",$("#gui_messages").append(b));return 0}
function getURLParameter(b){return decodeURIComponent(((new RegExp("[?|&]"+b+"=([^&;]+?)(&|#|;|$)")).exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null}function isFunction(b){return typeof b===typeof Function}Array.prototype.contains=function(b){return-1<this.indexOf(b)};Storage.prototype.setObject=function(b,d){logger("setObject:: key: "+b+":"+JSON.stringify(d),2);this.setItem(b,JSON.stringify(d))};
Storage.prototype.getObject=function(b){var d=this.getItem(b);logger("getObject:: type: "+typeof d+", key: "+b+":"+JSON.stringify(d),2);if(null==d)return null;try{JSON.parse(d)}catch(a){return logger("getObject:: Exception error JSON parse"),null}return d&&JSON.parse(d)};function getTime(){var b=new Date;return pad(b.getHours(),2)+":"+pad(b.getMinutes(),2)+":"+pad(b.getSeconds(),2)}function parse_int(b){return b.match(/\d+\.?\d*/g)}function read_int(b){return b.match(/\d+\.?\d*/g)[0]}
function find_device(b,d){for(var a=0;a<devices.length;a++){var f=devices[a].id;if(devices[a].room==b&&f==d)return a}return-1}function lookup_uaddr(b,d){for(var a=0;a<devices.length;a++)if(devices[a].room==b&&devices[a].uaddr==d)return a;logger("lookup_uaddr:: No index in devices "+devices.length+" found for room: "+b+", uaddr: "+d,1);for(a=0;a<devices.length;a++)logger("lookup_addr:: device "+a+", room: "+devices[a].room+", uaddr: "+devices[a].uaddr,1);return-1}
function checkLength(b,d,a,f){return b.val().length>f||b.val().length<a?(b.addClass("ui-state-error"),updateTips("Length of "+d+" must be between "+a+" and "+f+"."),!1):!0}
function askForm(b,d,a,f){if(1==jqmobile){$("#header").empty();var g=$("<div/>").popup({id:"popform",dismissible:!1,theme:"b",overlayTheme:"a",title:f||"Confirm",maxWidth:"500px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<div/>",{text:f}).appendTo(g);$(b,{}).appendTo(g);$("<a>",{text:"Submit"}).buttonMarkup({inline:!0,icon:"check"}).bind("click",function(){if("function"==typeof d){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),
,$("#val_5").val()];setTimeout(function(){d(a)},50)}2<=debug&&alert("Submit");g.popup("close")}).appendTo(g);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).bind("click",function(){"function"==typeof a&&setTimeout(a,50);g.popup("close");1<debug&&alert("cancel")}).appendTo(g);g.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:f||"Confirm",minHeight:120,
dialogClass:"askform",buttons:{OK:function(){if("function"==typeof d){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),$("#val_5").val()];setTimeout(function(){d(a)},50)}$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function myAlert(b,d){$('<div style="padding:10px; min-width:350px; max-width:800px; min-height:400px; max-height:500px; overflow:scroll; word-wrap:break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:d||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){$(this).dialog("destroy")}}})}
function myConfirm(b,d,a,f){$('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:f||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){"function"==typeof d&&setTimeout(d,50);$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}}})}
function init_websockets(){var b=w_url.split(":");logger("init_websockets:: Splitting url and port: "+b[0],2);w_uri="ws://"+b[0]+":"+w_port;logger("init_websockets:: new WebSocket w_uri: "+w_uri,1);w_sock=new WebSocket(w_uri);w_sock.onopen=function(b){logger("Websocket:: Opening socket "+w_uri,1);message("websocket reopen",1)};w_sock.onclose=function(b){logger("Websocket:: socket closed "+w_uri+", code: "+b.code,1);message('<DIV style="textdecoration: blink; background-color:yellow; color:black;">Restarting the Websocket. Please wait ...</DIV>');
setTimeout(function(){message("")},500);setTimeout(function(){init_websockets()},1E3);logger("Websocket:: socket re-opened: "+w_sock.readyState)};w_sock.onerror=function(b){logger("Websocket:: error. State is: "+w_sock.readyState)};w_sock.onmessage=function(b){10>healthcount&&healthcount++;var a=JSON.parse(b.data);logger("Websocket:: message rcv: "+a.action,2);2<=debug&&console.log(a);b=a.tcnt;var f=a.type,g=a.action;switch(g){case "ack":3<=debug?message("action: "+g+", tcnt: "+b+", mes: "+e+", type: "+
f,3):logger("action: "+g+", tcnt: "+b+", mes: "+e+", type: "+f,2);break;case "alert":myAlert("Server msg:: "+a.message);break;case "alarm":myAlert("Server msg:: "+a.message);break;case "console":logger("console message received"+a.message,2);myAlert("<br>"+a.message,a.request+" Output");break;case "energy":use_energy||(use_energy=!0,init_menu(s_setting_id));logger("Energy message, kw_act_use: "+a.kw_act_use,1);energy.kw_hi_use=a.kw_hi_use;energy.kw_lo_use=a.kw_lo_use;energy.kw_hi_ret=a.kw_hi_ret;
energy.kw_lo_ret=a.kw_lo_ret;energy.gas_use=a.gas_use;energy.kw_act_use=a.kw_act_use;energy.kw_act_ret=a.kw_act_ret;energy.kw_ph1_use=a.kw_ph1_use;energy.kw_ph2_use=a.kw_ph2_use;energy.kw_ph3_use=a.kw_ph3_use;break;case "graph":logger("rcv:: graph response received, ",1);"function"==typeof display_graph&&display_graph(a.gtype,a.gperiod);break;case "upd":case "gui":var e=a.message;switch(f){case "json":logger("onmessage:: read upd message. Type is: "+f+". Json is not supported yet",1);var k=a.room,
l=a.uaddr,c=a.val,h=lookup_uaddr(k,l);devices[h].val=c;k==s_room_id&&"room"==s_screen?activate_room(s_room_id):["g_grid","g_all","g_room","g_devices"].contains(s_screen)&&update_grid(h);break;case "raw":e=a.message;logger("onmessage:: read upd message. Type is: "+f+", msg: "+e,1);var m=parse_int(e);"!R"==e.substr(0,2)&&(k=m[0],l=m[1],h=lookup_uaddr(k,l),e.search("FdP"),c=m[2],logger("onmessage:: room: "+k+", uaddr: "+l+", val: "+c+", ind: "+h+", scrn: "+s_screen,1),devices[h].val=c,k==s_room_id&&
"room"==s_screen?activate_room(s_room_id):["g_grid","g_all","g_room","g_devices"].contains(s_screen)&&update_grid(h));break;default:logger("onmessage:: read upd message. Unknown type: "+f,1)}0==debug?message("Update: "+devices[h].name+" to value: "+c,0):message("action: "+g+", tcnt: "+b+", mes: "+e+", type: "+f,1);break;case "list_config":settings[5].list=a.list;logger("list_config msg received: "+a.list,1);activate_setting("5");break;case "list_user":logger("list_user message received",1);users=
a.message;activate_setting("2b");break;case "load_database":logger("Receiving load_database message",2);lroot=a.response;rooms=a.response.rooms;devices=a.response.devices;scenes=a.response.scenes;timers=a.response.timers;handsets=a.response.handsets;settings=a.response.settings;brands=a.response.brands;sensors=weather=a.response.sensors;rules=a.response.rules;init();void 0!==typeof Storage&&(localStorage.setObject("rooms",rooms),localStorage.setObject("devices",devices),localStorage.setObject("scenes",
scenes),localStorage.setObject("timers",timers),localStorage.setObject("handsets",handsets),localStorage.setObject("settings",settings),localStorage.setObject("brands",brands),localStorage.setObject("sensors",sensors));message("database received: #rooms: "+rooms.length+", #devices:"+devices.length);break;case "login":if(loginprocess)break;loginprocess=!0;"undefined"!==typeof Storage?(e=localStorage.getItem("uname"),c=localStorage.getItem("pword"),1<=debug&&logger("Support for localstorage, uname: "+
e),null===e&&(e=""),null===c&&(c="")):(loger("No local storage in browser",1),message("No local storage in browser"),e="login",c="****");void 0!==a.message?logger("Lampi.js:: received login request, message"+a.message,1):(logger("Lampi.js:: received login request",1),a.message="Please logon ");askForm('<form id="addRoomForm"><fieldset><p>Since your computer <'+a.address+"> might be outside our network, we ask you to logon to the system and prove your identity <br><br>"+a.message+'</p><label for="val_1">Login: </label><input type="text" name="val_1" id="val_1" value="'+
e+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Password: </label><input type="text" name="val_2" id="val_2" value="'+c+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);var b={tcnt:++w_tcnt%1E3,type:"raw",action:"login",login:a[0],password:a[1]};w_sock.send(JSON.stringify(b));logger(b);"undefined"!==typeof Storage&&(localStorage.setItem("uname",a[0]),localStorage.setItem("pword",
a[1]),logger("localstorage:: uname: "+a[0]));2<=debug&&myAlert("Submit login: "+a[0]+", password: "+a[1]);loginprocess=!1;logger("s_screen is: "+s_screen,1);return 1},function(){2<=debug&&myAlert("Submit login Cancelled");loginprocess=!1;return 0},"Confirm Login");break;case "sensor":logger("Sensor message from "+a.address+":"+a.channel,1);for(c=0;c<sensors.length&&(sensors[c].address!=a.address||sensors[c].channel!=a.channel);c++);c<sensors.length&&(a.hasOwnProperty("temperature")&&(sensors[c].sensor.temperature.val=
a.temperature),a.hasOwnProperty("humidity")&&(void 0==sensors[c].sensor.humidity?logger("sensor "+a.address+":"+a.channel+" humidity undefined",1):sensors[c].sensor.humidity.val=a.humidity),a.hasOwnProperty("airpressure")&&(sensors[c].sensor.airpressure.val=a.airpressure),a.hasOwnProperty("windspeed")&&(sensors[c].sensor.windspeed.val=a.windspeed),a.hasOwnProperty("winddirection")&&(sensors[c].sensor.winddirection.val=a.winddirection),a.hasOwnProperty("rainfall")&&(sensors[c].sensor.railfall.val=
a.railfall),e="",2<=debug&&(e+="Sensor "+sensors[c].name+"@ "+sensors[c].location,e+=": temp: "+sensors[c].temperature,e+=", humi: "+sensors[c].humidity+"%<br>",logger("Sensor "+sensors[c].name+"@"+sensors[c].location+": temp: "+sensors[c].temperature+", humi: "+sensors[c].humidity+"%")),message(e));break;case "upd_config":logger("rcv:: upd_config message received",1);Object.keys(a.message).forEach(function(b){lroot[b]=a.message[b];switch(b){case "rooms":settings=a.message[b];break;case "devices":devices=
a.message[b];break;case "scenes":scenes=a.message[b];break;case "timers":timers=a.message[b];break;case "handsets":handsets=a.message[b];break;case "sensors":sensors=a.message[b];break;case "brands":brands=a.message[b];break;case "settings":settings=a.message[b];break;default:myAlert("rcv upd_config:: received unknown message key: "+b)}});activate(s_screen);break;case "weather":alert("UNEXPECTED WEATHER MESSAGE RECEIVED");for(c=0;c<weather.length&&(weather[c].address!=a.address||weather[c].channel!=
a.channel);c++);c<weather.length&&(weather[c].temperature=a.temperature,weather[c].humidity=a.humidity,weather[c].airpressure=a.airpressure,weather[c].windspeed=a.windspeed,weather[c].winddirection=a.winddirection,weather[c].rainfall=a.rainfall,e="",2<=debug&&(e+="Weather "+weather[c].name+"@ "+weather[c].location,e+=": temp: "+weather[c].temperature,e+=", humi: "+weather[c].humidity+"%<br>",logger("Weather "+weather[c].name+"@"+weather[c].location+": temp: "+weather[c].temperature+", humi: "+weather[c].humidity+
"%")),message(e));break;default:message("Unknown message: action: "+g+", tcnt: "+b+", mes: "+e+", type: "+f)}};logger("Websocket:: readyState: "+w_sock.readyState,1)}
function send2daemon(b,d,a){logger("send2daemon: action: "+b+", cmd: "+d,2);b={tcnt:++w_tcnt%1E3+"",type:"raw",action:b,cmd:d,message:a};for(d=0;4>d;d++)switch(w_sock.readyState){case 0:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 1:return logger("send2daemon:: sending: "+JSON.stringify(b),2),w_sock.send(JSON.stringify(b)),0;case 2:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 3:setTimeout(function(){logger("send2daemon:: socket not ready: "+
w_sock.readyState,2)},1E3);break;default:logger("send2daemon:: readystate not defined: "+w_sock.readyState,1)}logger("send2daemon:: unable to transmit message 4 times: "+w_sock.readyState,1);return-1}
function load_database(b){logger("load_database:: Calling send2daemon with load_database, "+b+" , "+b,2);var d;d=setInterval(function(){var a=w_sock.readyState;1!=a?(logger("load_database Websocket:: ERROR. State is: "+a,1),message("load_database:: Websocket:: ERROR. State is: "+a)):(clearInterval(d),message("load_database:: sending load_database request"),send2daemon("load_database",b,b))},500);return 1};