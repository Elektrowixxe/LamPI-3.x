var w_url=location.host,w_svr="LamPI-node.js",w_port="5000",w_uri,w_sock,w_tcnt=0,jqmobile=0,murl="/",skin="",debug="1",alarmStatus="2",use_energy=!1,loginprocess=!1,healthcount=5,healthtime=1E4,s_screen="room",s_room_id=1,s_scene_id=1,s_timer_id=1,s_handset_id=1,s_sensor_id="",s_energy_id=0,s_setting_id=0,s_recorder="",s_recording=0,max_rooms=16,max_scenes=16,max_devices=16,max_timers=16,max_handsets=8,max_sensors=8,lroot={},rooms={},devices={},moods={},scenes={},timers={},brands={},handsets={},
weather={},sensors={},energy={},settings={},users={};
function start_LAMP(){$(window).on("beforeunload",function(){logger("beforeunload closing the socket");w_sock.close()});$(window).load(function(){function b(){var a=w_url.split(":");logger("init_websockets:: Splitting url and port: "+a[0],2);w_uri="ws://"+a[0]+":"+w_port;logger("init_websockets:: new WebSocket w_uri: "+w_uri,1);w_sock=new WebSocket(w_uri);w_sock.onopen=function(a){logger("Websocket:: Opening socket "+w_uri,1);message("websocket reopen",1)};w_sock.onclose=function(a){logger("Websocket:: socket closed "+
w_uri+", code: "+a.code,1);message('<DIV style="textdecoration: blink; background-color:yellow; color:black;">Restarting the Websocket. Please wait ...</DIV>');setTimeout(function(){message("")},500);setTimeout(function(){b()},1E3);logger("Websocket:: socket re-opened: "+w_sock.readyState)};w_sock.onerror=function(a){logger("Websocket:: error. State is: "+w_sock.readyState)};w_sock.onmessage=function(a){10>healthcount&&healthcount++;2<=debug&&(logger("Websocket:: message received: "),console.log(a.data));
var c=JSON.parse(a.data);logger("Websocket:: message rcv: "+c.action,1);2<=debug&&console.log(c);a=c.tcnt;var e=c.type,d=c.action;switch(d){case "ack":3<=debug?message("action: "+d+", tcnt: "+a+", mes: "+b+", type: "+e,3):logger("action: "+d+", tcnt: "+a+", mes: "+b+", type: "+e,2);break;case "alert":myAlert("Server msg:: "+c.message);break;case "alarm":myAlert("Server msg:: "+c.message);break;case "upd":case "gui":var b=c.message;switch(e){case "json":logger("onmessage:: read upd message. Type is: "+
e+". Json is not supported yet",1);var l=c.room,p=c.uaddr,h=c.val,n=lookup_uaddr(l,p);devices[n].val=h;l==s_room_id&&"room"==s_screen&&activate_room(s_room_id);break;case "raw":b=c.message;logger("onmessage:: read upd message. Type is: "+e,1);var m=parse_int(b);"!R"==b.substr(0,2)&&(l=m[0],p=m[1],n=lookup_uaddr(l,p),b.search("FdP"),h=m[2],logger("onmessage:: room: "+l+", device: "+p+", val: "+h+", ind: "+n,2),devices[n].val=h,l==s_room_id&&"room"==s_screen&&activate_room(s_room_id));break;default:logger("onmessage:: read upd message. Unknown type: "+
e,1)}0==debug?message("Update: "+devices[n].name+" to value: "+h,0):message("action: "+d+", tcnt: "+a+", mes: "+b+", type: "+e,1);break;case "weather":alert("UNEXPECTED WEATHER MESSAGE RECEIVED");for(h=0;h<weather.length&&(weather[h].address!=c.address||weather[h].channel!=c.channel);h++);h<weather.length&&(weather[h].temperature=c.temperature,weather[h].humidity=c.humidity,weather[h].airpressure=c.airpressure,weather[h].windspeed=c.windspeed,weather[h].winddirection=c.winddirection,weather[h].rainfall=
c.rainfall,b="",2<=debug&&(b+="Weather "+weather[h].name+"@ "+weather[h].location,b+=": temp: "+weather[h].temperature,b+=", humi: "+weather[h].humidity+"%<br>",logger("Weather "+weather[h].name+"@"+weather[h].location+": temp: "+weather[h].temperature+", humi: "+weather[h].humidity+"%")),message(b));break;case "sensor":logger("Lampi.js:: received sensor message");for(h=0;h<sensors.length&&(sensors[h].address!=c.address||sensors[h].channel!=c.channel);h++);h<sensors.length&&(c.hasOwnProperty("temperature")&&
(sensors[h].sensor.temperature.val=c.temperature),c.hasOwnProperty("humidity")&&(sensors[h].sensor.humidity.val=c.humidity),c.hasOwnProperty("airpressure")&&(sensors[h].sensor.airpressure.val=c.airpressure),c.hasOwnProperty("windspeed")&&(sensors[h].sensor.windspeed.val=c.windspeed),c.hasOwnProperty("winddirection")&&(sensors[h].sensor.winddirection.val=c.winddirection),c.hasOwnProperty("rainfall")&&(sensors[h].sensor.railfall.val=c.railfall),b="",2<=debug&&(b+="Weather "+sensors[h].name+"@ "+sensors[h].location,
b+=": temp: "+sensors[h].temperature,b+=", humi: "+sensors[h].humidity+"%<br>",logger("Weather "+sensors[h].name+"@"+sensors[h].location+": temp: "+sensors[h].temperature+", humi: "+sensors[h].humidity+"%")),message(b));break;case "energy":use_energy||(use_energy=!0,init_menu(s_setting_id));logger("Energy message, kw_act_use: "+c.kw_act_use,1);energy.kw_hi_use=c.kw_hi_use;energy.kw_lo_use=c.kw_lo_use;energy.kw_hi_ret=c.kw_hi_ret;energy.kw_lo_ret=c.kw_lo_ret;energy.gas_use=c.gas_use;energy.kw_act_use=
c.kw_act_use;energy.kw_act_ret=c.kw_act_ret;energy.kw_ph1_use=c.kw_ph1_use;energy.kw_ph2_use=c.kw_ph2_use;energy.kw_ph3_use=c.kw_ph3_use;break;case "console":logger("console message received"+c.message,2);myAlert("<br>"+c.message,c.request+" Output");break;case "list_user":logger("list_user message received",1);users=c.message;activate_setting("2b");break;case "login":if(loginprocess)break;loginprocess=!0;"undefined"!==typeof Storage?(b=localStorage.getItem("uname"),h=localStorage.getItem("pword"),
1<=debug&&logger("Support for localstorage, uname: "+b),null===b&&(b=""),null===h&&(h="")):(logger("No local storage in browser",1),message("No local storage in browser"),b="login",h="****");void 0!==c.message?logger("Lampi.js:: received login request, message"+c.message,1):(logger("Lampi.js:: received login request",1),c.message="Please logon ");askForm('<form id="addRoomForm"><fieldset><p>Since your computer <'+c.address+"> might be outside our network, we ask you to logon to the system and prove your identity <br><br>"+
c.message+'</p><label for="val_1">Login: </label><input type="text" name="val_1" id="val_1" value="'+b+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Password: </label><input type="text" name="val_2" id="val_2" value="'+h+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);var c={tcnt:++w_tcnt%1E3,type:"raw",action:"login",login:a[0],password:a[1]};w_sock.send(JSON.stringify(c));logger(c);
"undefined"!==typeof Storage&&(localStorage.setItem("uname",a[0]),localStorage.setItem("pword",a[1]),logger("localstorage:: uname: "+a[0]));2<=debug&&myAlert("Submit login: "+a[0]+", password: "+a[1]);loginprocess=!1;logger("s_screen is: "+s_screen,1);return 1},function(){2<=debug&&myAlert("Submit login Cancelled");loginprocess=!1;return 0},"Confirm Login");break;case "load_database":logger("Receiving load_database message",2);rooms=c.response.rooms;devices=c.response.devices;scenes=c.response.scenes;
timers=c.response.timers;handsets=c.response.handsets;settings=c.response.settings;brands=c.response.brands;sensors=weather=c.response.sensors;init();void 0!==typeof Storage&&(localStorage.setObject("rooms",rooms),localStorage.setObject("devices",devices),localStorage.setObject("scenes",scenes),localStorage.setObject("timers",timers),localStorage.setObject("handsets",handsets),localStorage.setObject("settings",settings),localStorage.setObject("brands",brands),localStorage.setObject("sensors",sensors));
message("database received: #rooms: "+rooms.length+", #devices:"+devices.length);break;case "upd_config":logger("rcv:: upd_config message received",1);Object.keys(c.message).forEach(function(a){lroot[a]=c.message[a];switch(a){case "rooms":settings=c.message[a];break;case "devices":devices=c.message[a];break;case "scenes":scenes=c.message[a];break;case "timers":timers=c.message[a];break;case "handsets":handsets=c.message[a];break;case "sensors":sensors=c.message[a];break;case "brands":brands=c.message[a];
break;case "settings":settings=c.message[a];break;default:myAlert("rcv upd_config:: received unknown message key: "+a)}});activate(s_screen);break;default:message("Unknown message: action: "+d+", tcnt: "+a+", mes: "+b+", type: "+e)}};logger("Websocket:: readyState: "+w_sock.readyState,1)}$("#gui_header").on("click",".hr_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hr_button").removeClass("hover");$(this).addClass("hover");activate_room(id)});
$("#gui_header").on("click",".cr_button",function(a){a.preventDefault();selected=$(this);$(".cr_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_rooms;){for(a=0;a<rooms.length&&rooms[a].id!=b;a++);if(a==rooms.length)break;b++}if(b>max_rooms)return alert("Unable to add more rooms"),-1;2<debug&&alert("Add Room: New index found: "+b);askForm("<form><fieldset><p>You have created room nr "+b+'. Please specify name for your new room</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /></fieldset></form>',
function(a){2<debug&&alert(" Dialog returned Name,Type: "+a);a={id:b,name:a[0]};rooms.push(a);s_room_id=b;send2daemon("dbase","add_room",a);init_rooms("init");return 1},function(){activate_room(s_room_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Room: </label><select id="val_1" value="val_1" >';for(a=0;a<rooms.length;a++)c+="<option>"+rooms[a].name+"</option>";a="<form><fieldset><br />You are planning to delete a room from the system. If you do so, all actions associated with the room must be deleted too.\nPlease start with selecting a room from the list on top of the screen.Please click on the room you wish to delete from the system.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);for(var b=a[0],c=0;c<rooms.length&&rooms[c].name!=b;c++);a=rooms[c].id;for(var d=0;d<devices.length;d++)if(devices[d].room==a)return alert("Room "+b+" is not empty\nWe cannot delete this room\nSorry"),0;b=rooms.splice(c,1);s_room_id==a&&(s_room_id=rooms[0].id);logger(b[0],2);send2daemon("dbase","delete_room",b[0]);2<=debug&&alert("Removed from dbase:: id: "+b[0].id+" , name: "+b[0].name);
init_rooms("init");return 1},function(){activate_room(s_room_id);return 1},"Confirm Delete Room");break;case "Help":helpForm("Room","This form allows you to control the lighting in a particular room Select the room that you like to control with the buttons in the top header area For every device in the room, whether dimmer or switch, users can change the light setting.\nThe small buttons in the top right corner are special buttons The leftmost green one allows you to add a device to the active room.\nThe red X allows you to delete a device from the room. Press the X and you'll see small selection buttons on the left of every device line. Press one and you'll be able to delete the device.\n"),
$(".cr_button").removeClass("hover")}$(this).removeClass("hover")});$("#gui_header").on("click",".hs_button",function(a){a.preventDefault();selected=$(this);$(".hs_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_scene(id)});$("#gui_header").on("click",".cs_button",function(a){a.preventDefault();selected=$(this);$(".cs_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=
1;b<=max_scenes;){for(a=0;a<scenes.length&&scenes[a].id!=b;a++);if(a==scenes.length)break;b++}if(b>max_scenes)return alert("Unable to add more scenes"),-1;askForm("<form><fieldset><p>You have created scene nr "+b+'. Please specify name for your new scene</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a={id:b,name:a[0],val:"0",
seq:""};scenes.push(a);send2daemon("dbase","add_scene",a);s_scene_id=b;init_scenes("init");return 1},function(){activate_scene(s_scene_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Scene: </label><select id="val_1" value="val_1" >';for(a=0;a<scenes.length;a++)c+="<option>"+scenes[a].name+"</option>";a="<form><fieldset><br>You are planning to delete a scene from the system. If you do so, all actions associated with the scene must be deleted too.\nPlease start with selecting a scene from the list.<br /><br />"+
(c+"</select>")+"<br></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=0;b<scenes.length&&scenes[b].name!=a;b++);a=scenes.splice(b,1);logger(a[0]);send2daemon("dbase","delete_scene",a[0]);1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name);s_scene_id=scenes[0].id;init_scenes("init");return 1},function(){activate_scene(s_scene_id);return 1},"Confirm Delete Scene");break;case "Help":helpForm("Scene","This is the Help screen for Scenes (or sequences if you wish)\n\nIn the header section you see an overview of your scenes defined, which enables you to view/change or add to a scene of your choice. \n\nThe Context section in the middle shows for each defines scene the sequence of actions that will be performed when you RUN that scene with the blue > button. \nIf you add or remove a device action to a scene this will NOT be stored unless you use the store function which will write the sequence to the database. ");
$(".cs_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_header").on("click",".ht_button",function(a){a.preventDefault();selected=$(this);
$(".ht_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_timer(id);2<debug&&alert("init_timer:: Button event")});$("#gui_header").on("click",".ct_button",function(a){a.preventDefault();selected=$(this);$(".ct_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_timers;){for(a=0;a<timers.length&&timers[a].id!=b;a++);if(a==timers.length)break;b++}if(b>
max_timers)return alert("Unable to add more timers"),-1;askForm("<form><fieldset><p>You have created timer nr"+b+'. Please specify name for your new timer</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a={id:b,name:a[0],scene:"",tstart:"00:00:00",startd:"01/01/13",endd:"",days:"mtwtfss",months:"jfmamjjasond",skip:"0"};timers.push(a);
send2daemon("dbase","add_timer",a);s_timer_id=b;init_timers("init");return 1},function(){activate_timer(s_timer_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Timer: </label><select id="val_1" value="val_1" >';for(a=0;a<timers.length;a++)c+="<option>"+timers[a].name+"</option>";a="<form><fieldset><br />You are planning to delete a timer from the system. If you do so, all actions associated with the timer are deleted too.\nPlease start with selecting a timer from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=0;b<timers.length&&timers[b].name!=a;b++);a=timers.splice(b,1);logger(a[0]);send2daemon("dbase","delete_timer",a[0]);1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name);s_timer_id=timers[0].id;init_timers("init");return 1},function(){activate_timer(s_timer_id);return 1},"Confirm Delete Timer");break;case "Help":helpForm("Timers","This is the Help screen for Timers\n\nIn the header section you see an overview of your timers defined, selecting one enables you to view/change or add to a timer. \n\nThe Content section in the middle shows its settings: Which scene should be started, on what time, and on whichs days or months. \nIf you change a timer setting this will NOT be stored unless you use the store function which will write the timer to the database. ");
$(".ct_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}$(this).removeClass("hover")});$("#gui_header").on("click",".hh_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hh_button").removeClass("hover");$(this).addClass("hover");activate_handset(id)});$("#gui_header").on("click",".ch_button",function(a){a.preventDefault();selected=$(this);$(".ch_button").removeClass("hover");$(this).addClass("hover");
value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_handsets;){for(a=0;a<handsets.length&&handsets[a].id!=b;a++);if(a==handsets.length)break;b++}if(b>max_handsets)return alert("Unable to add more handsets"),-1;askForm("<form><fieldset><br />DRAFT:<p>You have created handset nr "+b+'. Please specify name for your new remote</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><br /><label for="val_2">Address: </label><input type="text" name="val_2" id="val_2" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',
function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);var c=a[0];a=a[1];for(var d=0;d<handsets.length&&handsets[d].addr!=a;d++);if(d!=handsets.length)return alert("The handset address "+a+" is already registered"),0;1<debug&&alert("New handset on ind: "+b+", name: "+c+", addr: "+a);c={id:b,name:c,brand:"",addr:a,unit:"0",val:"0",type:"switch",scene:""};handsets.push(c);logger("Added new handset "+c.name);send2daemon("dbase","add_handset",c);s_handset_id=b;init_handsets("init");return 1},
function(){activate_handset(s_handset_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Handset: </label><select id="val_1" value="val_1" >',d=[];for(a=0;a<handsets.length;a++)-1==$.inArray(handsets[a].id,d)&&(c+="<option>"+handsets[a].name+"</option>",d[d.length]=handsets[a].id);a="<form><fieldset><br>DRAFT:</br><br />You are planning to delete a handset from the system. If you do so, all actions associated with the handset must be deleted too.\nPlease start with selecting a handset from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=handsets.length-1;0<=b;b--)if(2<debug&&alert("working with i: "+b+", handset id: "+handsets[b].name),handsets[b].name==a){var c=handsets.splice(b,1);logger(c[0]);send2daemon("dbase","delete_handset",c[0]);1<debug&&myAlert("Removed from dbase:: id: "+c[0].id+" , name: "+c[0].name)}s_handset_id=handsets[0].id;init_handsets("init");return 1},function(){activate_handset(s_handset_id);
return 1},"Confirm Delete Handset");break;case "Help":helpForm("Handsets","This is the Help screen for Handsets or Remote controls\n\nIn the header section you see an overview of your handsets defined, which enables you to view/change or add to a handset of your choice. \n\nThe Content section in the middle shows for each defined handset the button definitions. If you add or remove a device action to a handset these will NOT be stored unless you use the store function which will write the sequence to the database. ");
$(".ch_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_header").on("click",".hw_button",function(a){a.preventDefault();a.stopPropagation();
selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hw_button").removeClass("hover");$(this).addClass("hover");activate_sensors(id)});$("#gui_content").on("click",".cw_button",function(a){a.preventDefault();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".cw_button").removeClass("hover");$(this).addClass("hover");window.open("http://"+w_url+"/graphs/sensor.html","_parent");$(this).removeClass("hover")});$("#gui_header").on("click",".cw_button",function(a){a.preventDefault();
selected=$(this);$(".cw_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":for(var b=1;b<=max_sensors;){for(a=0;a<sensors.length&&sensors[a].id!=b;a++);if(a==sensors.length)break;b++}if(b>max_sensors)return alert("Unable to add more weather sensors"),-1;askForm("<form><fieldset><br />DRAFT:<p>You have created sensors device nr "+b+'. Please specify name</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><br /><label for="val_2">Address: </label><input type="text" name="val_2" id="val_2" value="" class="text ui-widget-content ui-corner-all" /><br /></fieldset></form>',
function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);var c=a[0];a=a[1];for(var d=0;d<sensors.length&&sensors[d].addr!=a;d++);if(d!=sensors.length)return alert("The sensors address "+a+" is already registered"),0;1<=debug&&alert("New sensor on ind: "+b+", name: "+c+", addr: "+a);c={id:b,name:c,brand:"",addr:a,unit:"0",val:"0",type:"switch",scene:""};sensors.push(c);logger("Added new sensor "+nesensors.name);send2daemon("dbase","add_sensors",c);s_sensor_id=b;init_sensors("init");return 1},
function(){activate_sensors(s_sensor_id);return 1},"Confirm Create");break;case "Del":var c='<label for="val_1">Delete Sensor: </label><select id="val_1" value="val_1" >',d=[];for(a=0;a<sensors.length;a++)-1==$.inArray(sensors[a].id,d)&&(c+="<option>"+sensors[a].name+"</option>",d[d.length]=sensors[a].id);a="<form><fieldset><br>DRAFT:</br><br />You are planning to delete a sensor from the system. If you do so, all actions associated with the sensor must be deleted too.\nPlease start with selecting a sensor from the list.<br /><br />"+
(c+"</select>")+"<br /></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2: "+a);a=a[0];for(var b=sensors.length-1;0<=b;b--)if(2<debug&&alert("working with i: "+b+", sensors id: "+sensors[b].name),sensors[b].name==a){var c=sensors.splice(b,1);logger(c[0]);send2daemon("dbase","delete_sensors",c[0]);1<debug&&myAlert("Removed from dbase:: id: "+c[0].id+" , name: "+c[0].name)}s_sensor_id=sensors[0].id;init_sensors("init");return 1},function(){activate_sensors(s_sensor_id);
return 1},"Confirm Delete sensor");break;case "Help":helpForm("Sensor","This is the Help screen for sensors stations and sensors\n\nIn the header section you see an overview of your sensors defined, which enables you to view/change or add sensors to a station of your choice. \n\nThe Content section in the middle shows for each defined station the dials, it will only show those sensors available for a station\nIt is quite good possible to change the layout of the dials, as well as color etc.\nAt the moment these style definitions are part of the steel subdirectory");
$(".cw_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}1!=jqmobile&&$("#gui_header tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,b){$("#gui_devices tr").each(function(a){0!=a?logger(a+": "+$(this).children().children(".dlabels").attr("id")):logger(a+": Header")})}}).disableSelection();$(this).removeClass("hover")});$("#gui_content").on("click",".ce_button",function(a){a.preventDefault();a.stopPropagation();
selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".ce_button").removeClass("hover");$(this).addClass("hover");window.open("http://"+w_url+"/graphs/energy.html","_parent");$(this).removeClass("hover")});$("#gui_header").on("click",".hc_button",function(a){a.preventDefault();selected=$(this);$(".hc_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");activate_setting(id)});$("#gui_header").on("click",".cc_button",function(a){a.preventDefault();
selected=$(this);$(".cc_button").removeClass("hover");$(this).addClass("hover");value=$(this).val();id=$(a.target).attr("id");switch(id){case "Add":alert("Add a Setting");break;case "Del":break;case "Help":alert("This is the Help screen for Setting Configuration\n\nIn the header section you see buttons to select a configuration item, each one will show a form where you can change certain settings. ");$(".cc_button").removeClass("hover");break;default:alert("Error:: click id "+id+" not recognized")}});
$("#gui_content").on("click",".scene_button",function(a){a.preventDefault();a.stopPropagation();value=$(this).val();var b=$(a.target).attr("id"),c=get_scene(s_scene_id),d=c.name,g=c.seq.split(",");logger("scene handler:: scene_name: "+d,2);switch(b.substr(0,2)){case "Fq":d='!FqP"'+c.name+'"';message_device("scene","run",d);break;case "Fe":d='!FeP"'+c.name+'"='+c.seq;send2daemon("dbase","store_scene",c);break;case "Fx":2<debug&&alert("Activate_screen:: Delete Fx button pressed");var k="Deleted actions ";
$($("#gui_scenes .scene").get().reverse()).each(function(a){var b=$(this).children().children(".dlabels").attr("id");a=parse_int(b)[1];$(this).children().children('input[type="checkbox"]').is(":checked")&&(1<debug&&alert("delete scene id: "+b+", index: "+a+" selected"),b=g.splice(2*(a-1),2),a--,1<debug&&alert("removed:"+b[0]+","+b[1]+": from seq: "+g),k+=a+" : "+decode_scene_string(b[0])+"; ")});message(k);for(c=0;c<scenes.length;c++)if(scenes[c].id==s_scene_id){"undefined"==typeof g?2<debug&&alert("activate_scene:: case FX: scene_split undefined"):
(scenes[c].seq=g.join(),2<debug&&alert("seq: "+scenes[c].seq));break}activate_scene(s_scene_id);break;case "Fc":d='!FcP"'+c.name+'"';alert("Cancel current Sequence: "+c.name+"\nScene cmd: "+d);message_device("scene","cancel",d);break;case "Fr":2<debug&&alert("Activate_screen:: Add Fr button pressed, start recording ...");myConfirm("You are about to add a new action to the scene. If you continue, the system will be in recording mode until you have selected a device action. Then you are returned to this scene screen again. Please confirm if you want to add a device. ",
function(){message('<p style="textdecoration: blink; background-color:red; color:white;">RECORDING</p>')},function(){s_recording=0;return 1},"Adding a Device action?");s_recording=1;s_recorder="";init_rooms("init");break;case "Ft":for(var l=$(a.target).val(),c="",d=0;24>d;d++)c=d==l.substr(0,2)?c+('<option selected="selected">'+("00"+d).slice(-2)+"</option>"):c+("<option>"+("00"+d).slice(-2)+"</option>");for(var p="",d=0;60>d;d++)p=d==l.substr(3,2)?p+('<option selected="selected">'+("00"+d).slice(-2)+
"</option>"):p+("<option>"+("00"+d).slice(-2)+"</option>");for(var h="",d=0;60>d;d++)h=d==l.substr(6,2)?h+('<option selected="selected">'+("00"+d).slice(-2)+"</option>"):h+("<option>"+("00"+d).slice(-2)+"</option>");c='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm:ss</p><br /><label style="width:50px;" for="val_1">hrs: </label><select id="val_1" value="'+l.substr(0,2)+'" >'+c+'</select><label style="width:50px;" for="val_2">mins: </label><select id="val_2" value="'+
l.substr(3,2)+'">'+p+'</select><label style="width:50px;" for="val_3">secs: </label><select id="val_3" selectedIndex="10" value="'+l.substr(6,2)+'">'+h+"</select></fieldset></form>";askForm(c,function(c){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+c);c=c[0]+":"+c[1]+":"+c[2];$(a.target).val(c);2<debug&&alert("Timer changed from "+l+" to: "+$(a.target).val());var d=parse_int(b)[1];g[2*(d-1)+1]=c;var e="";$("#gui_scenes .scene").each(function(a){a=$(this).children().children(".dbuttons").attr("id");
a=parse_int(a)[1];e+=g[2*(a-1)]+","+g[2*(a-1)+1]+","});e=e.slice(0,-1);c=idx_scene(s_scene_id);logger("store_scene:: sindex: "+c+",my_list :"+e);logger("store_scene: "+c+", "+scenes[c].name+", my_list: "+e);scenes[c].seq=e;2<debug&&alert("new scene_list:: "+e);return 0},function(){return 1},"Confirm Change");break;default:alert("Sequence action unknown: "+b.substr(-2))}});if(1==jqmobile){var d=load_database("init");0>d&&alert("Error:: loading database failed");b()}else"undefined"!==typeof Storage&&
(logger("Loading user and database settings from localStorage",1),localStorage.getItem("uname"),localStorage.getItem("pword"),localStorage.getItem("saddr"),rooms=localStorage.getObject("rooms"),devices=localStorage.getObject("devices"),scenes=localStorage.getObject("scenes"),timers=localStorage.getObject("timers"),handsets=localStorage.getObject("handsets"),brands=localStorage.getObject("brands"),sensors=localStorage.getObject("sensors"),settings=localStorage.getObject("settings")),b(),d=load_database("init"),
0>d&&alert("Error:: loading database failed")})}
function init(){debug=settings[0].val;0<energy.length?use_energy=!0:!1;1!=jqmobile&&("undefined"!==typeof Storage?(skin=localStorage.getItem("skin"),logger("init:: localStorage, skin: "+skin,1)):logger("init:: No localStorage support for skin",1),null==skin&&(skin=settings[4].val),$("link[href^='styles']").attr("href",skin));setInterval(function(){send2daemon("ping","","");0<healthcount&&healthcount--;logger("healthcount:: "+healthcount,2);1==jqmobile?(logger("healthcount mobile:: "+healthcount,1),
$("#health-slider").val(healthcount).slider("refresh")):(logger("healthcount ui:: "+healthcount,1),$("#health-slider").val(healthcount),$("#health-slider").slider("option","value",healthcount))},1E4);energy.kw_hi_use=0;energy.kw_lo_use=0;energy.kw_hi_ret=0;energy.kw_lo_ret=0;energy.gas_use=0;energy.kw_act_use=0;energy.kw_act_ret=0;energy.kw_ph1_use=0;energy.kw_ph2_use=0;energy.kw_ph3_use=0;devices.sort(function(b,a){return b.id<a.id?-1:b.id>a.id?1:0});if(2<=debug)for(var b=0;b<devices.length;b++)logger("devices i: "+
b+", id: "+devices[b].id+", name: "+devices[b].name);init_rooms(s_room_id);init_menu(s_setting_id)}function activate(b){switch(b){case "room":activate_room(s_room_id);break;case "screne":activate_scene(s_scene_id);break;case "timer":activate_timer(s_timer_id);break;case "sensor":activate_sensors(s_sensor_id);break;case "energy":activate_energy(s_energy_id);break;case "config":activate_setting(s_setting_id)}}
function logger(b,d){3<=debug&&alert("Message called: "+b+", lvl: "+d+", debug: "+debug);"undefined"===typeof d&&(d=debug);d<=debug&&console.log(b)}function message(b,d,a){2<debug&&alert("Message called: "+b+", lvl: "+d+", debug: "+debug);"undefined"===typeof d&&(d=debug);d<=debug&&($("#gui_messages").empty(""),b='<div id="comment">'+b+"</div>",$("#gui_messages").append(b));return 0}Storage.prototype.setObject=function(b,d){logger("setObject:: key: "+b+":"+JSON.stringify(d),2);this.setItem(b,JSON.stringify(d))};
Storage.prototype.getObject=function(b){var d=this.getItem(b);logger("getObject:: type: "+typeof d+", key: "+b+":"+JSON.stringify(d),2);if(null==d)return null;try{JSON.parse(d)}catch(a){return logger("getObject:: Exception error JSON parse"),null}return d&&JSON.parse(d)};function getTime(){var b=new Date;return pad(b.getHours(),2)+":"+pad(b.getMinutes(),2)+":"+pad(b.getSeconds(),2)}function parse_int(b){return b.match(/\d+\.?\d*/g)}function read_int(b){return b.match(/\d+\.?\d*/g)[0]}
function myAlert(b,d){$('<div style="padding:10px; min-width:350px; max-width:800px; min-height:400px; max-height:500px; overflow:scroll; word-wrap:break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:d||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){$(this).dialog("destroy")}}})}
function myConfirm(b,d,a,f){$('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:f||"Confirm",minHeight:75,dialogClass:"askform",buttons:{OK:function(){"function"==typeof d&&setTimeout(d,50);$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}}})}
function helpForm(b,d,a,f){if(1==jqmobile){$("#header").empty();var c=$("<div/>").popup({id:"popform",dismissible:!1,theme:"a",overlayTheme:"a",maxWidth:"400px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<h2/>",{text:b}).appendTo(c);$("<p/>",{text:d}).appendTo(c);$("<a>",{text:"Read More"}).buttonMarkup({inline:!0,icon:"check"}).on("click",function(){if("function"==typeof a){var b=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val()];
setTimeout(function(){a(b)},50)}switch(s_screen){case "room":var d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/rooms.html","_blank");d.focus();break;case "scene":d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/scenes.html","_blank");d.focus();break;case "timer":d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/timers.html","_blank");d.focus();break;case "handset":d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/handsets.html","_blank");
d.focus();break;case "sensor":d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/weather.html","_blank");d.focus();break;case "energy":d=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/energy.html","_blank"),d.focus()}2<=debug&&alert("Read More for screen: "+s_screen);c.popup("close")}).appendTo(c);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).on("click",function(){c.popup("close");1<debug&&alert("cancel")}).appendTo(c);c.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+
d+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:b||"Help",minHeight:120,buttons:{More:function(){"function"==typeof a&&setTimeout(function(){a(ret)},50);switch(s_screen){case "room":var b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/rooms.html","_blank");b.focus();break;case "scene":b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/scenes.html","_blank");b.focus();break;case "timer":b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/timers.html",
"_blank");b.focus();break;case "handset":b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/handsets.html","_blank");b.focus();break;case "sensor":b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/weather.html","_blank");b.focus();break;case "energy":b=window.open("http://platenspeler.github.io/LamPI-3.0/UserGuide/energy.html","_blank"),b.focus()}$(this).dialog("destroy")},Done:function(){"function"==typeof f&&setTimeout(f,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function checkLength(b,d,a,f){return b.val().length>f||b.val().length<a?(b.addClass("ui-state-error"),updateTips("Length of "+d+" must be between "+a+" and "+f+"."),!1):!0}
function askForm(b,d,a,f){if(1==jqmobile){$("#header").empty();var c=$("<div/>").popup({id:"popform",dismissible:!1,theme:"b",overlayTheme:"a",title:f||"Confirm",maxWidth:"500px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<div/>",{text:f}).appendTo(c);$(b,{}).appendTo(c);$("<a>",{text:"Submit"}).buttonMarkup({inline:!0,icon:"check"}).bind("click",function(){if("function"==typeof d){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),
,$("#val_5").val()];setTimeout(function(){d(a)},50)}2<=debug&&alert("Submit");c.popup("close")}).appendTo(c);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).bind("click",function(){"function"==typeof a&&setTimeout(a,50);c.popup("close");1<debug&&alert("cancel")}).appendTo(c);c.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:f||"Confirm",minHeight:120,
dialogClass:"askform",buttons:{OK:function(){if("function"==typeof d){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),$("#val_5").val()];setTimeout(function(){d(a)},50)}$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function init_rooms(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="";for(var d=0;d<rooms.length;d++)room_name=rooms[d].name,room_id=rooms[d].id,b=room_id==s_room_id?b+room_button(room_id,room_name,"hover"):b+room_button(room_id,room_name);$("#gui_header_content").append(b);b='<input type="submit" id="Add"  value= "+"  class="cr_button new_button"><input type="submit" id="Del"  value= "X"  class="cr_button del_button"><input type="submit" id="Help" value= "?" class="cr_button help_button">';
$("#gui_header_controls").append(b);1==jqmobile?(b='<div data-role="fieldcontain" class="container-health"><label for="health-slider"></label>',b+='<input type="range" name="health-slider" id="health-slider" value='+healthcount+' min="0" max="9" data-mini="true"  data-highlight="true" class="slider-health"/></div>',$("#gui_header_controls").append(b),logger("Starting Healthcount Slider function",2),$("#health-slider").slider(),$("#health-slider").next().find(".ui-slider-handle").hide(),$("#health-slider").slider("refresh")):
(b='<div id="health-slider" class="slider-health" ></div>',$("#gui_header_controls").append(b),$(function(){logger("Starting Healthcount Slider function",2);$("#health-slider").slider({range:"max",min:0,max:9,value:healthcount,slide:function(a,b){$("#health-slider").val(b.value);var c=healthcount;2>=c?$(".slider-health").css("background","#4ea6cf"):2<c&&3>=c?$(".slider-health").css("background","#5ac5cf"):3<c&&4>=c?$(".slider-health").css("background","#7dd7bf"):4<c&&5>=c?$(".slider-health").css("background",
"#b1cfa1"):5<c&&6>=c?$(".slider-health").css("background","#e5bf7c"):6<c&&7>=c?$(".slider-health").css("background","#d79168"):7<c&&8>=c?$(".slider-health").css("background","#cd7159"):8<c&&$(".slider-health").css("background","#c4463a")}})}));s_screen="room";activate_room(s_room_id)}
function init_scenes(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="Init Scenes, scenes read: ";for(var d="",a=0;a<scenes.length;a++){var f=scenes[a].id,c=scenes[a].name;b+=a+", ";d=f==s_scene_id?d+scene_button(f,c,"hover"):d+scene_button(f,c)}1<debug&&message(b);$("#gui_header_content").append(d);d='<input type="submit" id="Add" value= "+" class="cs_button new_button"><input type="submit" id="Del" value= "X" class="cs_button del_button"><input type="submit" id="Help" value= "?" class="cs_button help_button">';
$("#gui_header_controls").append(d);s_screen="scene";activate_scene(s_scene_id)}
function init_timers(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="Init Timers, timers read: ";for(var d="",a=0;a<timers.length;a++){var f=timers[a].id,c=timers[a].name;b+=a+", ";d=f==s_timer_id?d+timer_button(f,c,"hover"):d+timer_button(f,c)}1<debug&&message(b);$("#gui_header_content").append(d);d='<input type="submit" id="Add" value= "+" class="ct_button new_button"><input type="submit" id="Del" value= "X" class="ct_button del_button">';d+=
'<input type="submit" id="Help" value= "?" class="ct_button help_button">';$("#gui_header_controls").append(d);s_screen="timer";activate_timer(s_timer_id)}
function init_handsets(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="Init Handsets, handsets read: ";for(var d="",a=[],f=0;f<handsets.length;f++)if(-1==$.inArray(handsets[f].id,a)){var c=handsets[f].id,e=handsets[f].name;b+=f+", ";d=c==s_handset_id?d+handset_button(c,e,"hover"):d+handset_button(c,e);a[a.length]=handsets[f].id}1<debug&&message(b);$("#gui_header_content").append(d);d='<input type="submit" id="Add" value= "+" class="ch_button new_button"><input type="submit" id="Del" value= "X" class="ch_button del_button">';
d+='<input type="submit" id="Help" value= "?" class="ch_button help_button">';$("#gui_header_controls").append(d);s_screen="handset";activate_handset(s_handset_id)}
function init_sensors(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="Init sensors, config read: ";var d="";""==s_sensor_id&&(s_sensor_id=sensors[0].location);for(var a=[],f=0;f<sensors.length;f++)if(-1==$.inArray(sensors[f].location,a)){var c=sensors[f].location;b+=f+", ";d=c==s_sensor_id?d+sensors_button(c,c,"hover"):d+sensors_button(c,c);a[a.length]=sensors[f].location}1<debug&&message(b);$("#gui_header_content").append(d);
d='<input type="submit" id="Help" value= "?" class="cw_button help_button">';$("#gui_header_controls").append(d);s_screen="sensor";activate_sensors(s_sensor_id)}
function init_energy(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="";$("#gui_header_content").append(b);1<debug&&message("Init energy, config read: ");b='<input type="submit" id="Help" value= "?" class="cw_button help_button">';$("#gui_header_controls").append(b);s_screen="energy";activate_energy(s_energy_id)}
function init_settings(b){$("#gui_header").empty();html_msg='<div id="gui_header_content"></div><div id="gui_header_controls"></div>';$("#gui_header").append(html_msg);b="";for(var d=0;d<settings.length;d++){var a=settings[d].id,f=settings[d].name;b=a==s_setting_id?b+setting_button(a,f,"hover"):b+setting_button(a,f)}$("#gui_header_content").append(b);b='<input type="submit" id="Help" value= "?" class="cc_button help_button"></td>';$("#gui_header_controls").append(b);s_screen="config";activate_setting(s_setting_id)}
function init_menu(b){$("#gui_menu").empty();if(1==jqmobile)b='<div data-role="fieldcontain" class="ui-hide-label"><label for="select-choice-1" class="select hm_button">menu</label> <select name="select-choice-1" id="select-choice-1"> ',b+='<option value="Rooms">Rooms</option>',b+='<option value="Scenes">Scenes</option>',b+='<option value="Timers">Timers</option>',b+='<option value="Handsets">Handsets</option>',0<sensors.length&&(b+='<option value="Sensor">Sensor</option>'),use_energy&&(b+='<option value="Energy">Energy</option>'),
b+='<option value="Config">Config</option>',b+="</select></div>",$("#gui_menu").append(b),$("#select-choice-1").change(function(){var a=$(this).val();switch(a){case "Rooms":init_rooms("init");break;case "Scenes":init_scenes(s_scene_id);break;case "Timers":init_timers();break;case "Handsets":init_handsets();break;case "Config":init_settings();break;case "Sensor":init_sensors();break;case "Energy":init_energy();break;default:message("init_menu:: id: "+a+" not a valid menu option")}});else{html_msg=
'<table border="0">';$("#gui_menu").append(html_msg);b=$("#gui_menu").children();var d='<tr><td><input type="submit" id="M1" value= "Rooms" class="hm_button hover"></td><tr><td><input type="submit" id="M2" value= "Scenes" class="hm_button"></td><tr><td><input type="submit" id="M3" value= "Timers" class="hm_button"></td><tr><td><input type="submit" id="M4" value= "Handsets" class="hm_button"></td>';0<sensors.length&&(d+='<tr><td><input type="submit" id="M6" value= "Sensor" class="hm_button"></td>');
use_energy&&(d+='<tr><td><input type="submit" id="M7" value= "Energy" class="hm_button"></td>');d+='<tr><td></td><tr><td></td><tr><td><input type="submit" id="M5" value= "Config" class="hm_button"></td></table>';$(b).append(d);$("#gui_menu").on("click",".hm_button",function(a){a.preventDefault();a.stopPropagation();selected=$(this);value=$(this).val();id=$(a.target).attr("id");$(".hm_button").removeClass("hover");$(this).addClass("hover");switch(id){case "M1":init_rooms("init");break;case "M2":init_scenes(s_scene_id);
break;case "M3":init_timers();break;case "M4":init_handsets();break;case "M5":init_settings();break;case "M6":init_sensors();break;case "M7":init_energy();break;default:message("init_menu:: id: "+id+" not a valid menu option")}})}}
function activate_room(b,d){for(var a,f,c=0;c<rooms.length;c++)if(rooms[c].id==b){f=rooms[c].name;break}$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");a='<div id="gui_devices"></div>';$("#gui_content").append(a);a='<table border="0">';$("#gui_devices").append(a);var c=$("#gui_devices").children(),e='<thead><tr class="headrow switch">',e=("Del"==d?e+'<td colspan="2">':e+"<td>")+'<input type="submit" id="Rx" value="X" class="dbuttons del_button" ><input type="submit" id="Ra" value="+" class="dbuttons new_button" ></td>',
e=e+('<td class="filler" align="center">'+f+"</td>");1!=jqmobile&&(e+="<td></td>");e+='<td><input type="submit" id="Fa" value="ALL OFF" class="dbuttons all_off_button" ></td>';$(c).append(e);$(c).append("</tr>");a="</thead><tbody>";$(c).append(a);c=$("#gui_devices tbody").last();for(f=0;f<devices.length;f++){var g=devices[f].id,k=devices[f].room;if(k==b){a=devices[f].name;var l=devices[f].type,e=devices[f].val,p,h;0==e?(p=" hover",h=""):(p="",h=" hover");switch(l){case "switch":1==jqmobile?(e='<tr class="devrow switch">',
"Del"==d&&(e+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),e+='<td colspan="2"><input type="text" id="'+g+'" value="'+a+'" class="dlabels"></td>',e+='<td><input type="submit" id="'+g+'F0" value="OFF" class="dbuttons off_button'+p+'">',e+='<input type="submit" id="'+g+'F1" value="ON" class="dbuttons on_button'+h+'"></td>'):(e='<tr class="devrow switch">',"Del"==d&&(e+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),
e+='<td colspan="2"><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td>',e+="<td></td>",e+='<td><input type="submit" id="'+g+'F0" value= "OFF" class="dbuttons off_button'+p+'">',e+='    <input type="submit" id="'+g+'F1" value= "ON" class="dbuttons on_button'+h+'"></td>');$(c).append(e);break;case "dimmer":1==jqmobile?(l='<tr class="devrow dimrow">',"Del"==d&&(l+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),l+='<td colspan="2"><label for="'+
g+'Fd">'+a+"</label>",l+='<input type="number" data-type="range" style="min-width:32px;" id="'+g+'Fd" name="'+g+'Fl" value="'+e+'" min=0 max=31 data-highlight="true" data-mini="false" class="ddimmer"/></td>',l+='<td><input type="submit" id="'+g+'F0" value= "OFF" class="dbuttons off_button'+p+'" />',l+='<input type="submit" id="'+g+'F1" value= "ON" class="dbuttons on_button'+h+'" /></td>',l+="</tr>"):(l='<tr class="devrow dimrow">',"Del"==d&&(l+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+
'" value="yes" class="dbuttons"></td>'),l+='<td><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td><td><div id="'+g+'Fd" class="slider slider-dimmer"></div></td><td><input type="text" id="'+g+'Fl" class="slidval"></td><td><input type="submit" id="'+g+'F0" value="OFF" class="dbuttons off_button'+p+'">    <input type="submit" id="'+g+'F1" value="ON" class="dbuttons on_button'+h+'"></td></tr>');c.append(l);var n="#"+g+"Fl",m="#"+g+"Fd";1==jqmobile?$(function(){var a=load_device(k,g);
"F0"==a&&(a=0);$(m).slider({stop:function(a,b){var c=$(a.target).attr("id"),d=$(a.target).val();0==d?(handle_device(c.slice(0,-2),"F"+d),$("#"+c.slice(0,-2)+"F1").removeClass("hover"),$("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$("#"+c.slice(0,-2)+"F0").removeClass("hover"),$("#"+c.slice(0,-2)+"F1").addClass("hover"));store_device(s_room_id,c.slice(0,-2),d)}});$(m).slider("refresh")}):$(function(){var a=load_device(k,g);"F0"==a&&(a=0);$(m).slider({range:"max",main:1,min:0,
max:32,value:a,slide:function(a,b){var c="#"+$(a.target).attr("id").slice(0,-1)+"l";$(c).val(b.value)},stop:function(a,b){var c=$(a.target).attr("id"),d=b.value;0==d?(d=0,handle_device(c.slice(0,-2),"F"+d),$(this).parent().siblings().children().removeClass("hover"),$(this).parent().siblings().children("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$(this).parent().siblings().children().removeClass("hover"),$(this).parent().siblings().children("#"+c.slice(0,-2)+"F1").addClass("hover"));
store_device(s_room_id,c.slice(0,-2),d)}});$(n).val(a)});break;case "thermostat":1==jqmobile?(l='<tr class="devrow dimrow">',"Del"==d&&(l+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),l+='<td colspan="2"><label for="'+g+'Fd">'+a+"</label>",l+='<input type="number" data-type="range" style="min-width:32px;" id="'+g+'Fd" name="'+g+'Fl" value="'+e+'" min=15 max=25 data-highlight="true" data-mini="false" data-theme="b" class="ddimmer"/></td>',l+="<td></td>",
l+="</tr>"):(l='<tr class="devrow dimrow">',"Del"==d&&(l+='<td><input type="checkbox" id="'+g+'c" name="cb'+g+'" value="yes" class="dbuttons"></td>'),l+='<td><input type="submit" id="'+g+'" value= "'+a+'" class="dlabels"></td><td><div id="'+g+'Fd" class="slider slider-thermo"></div></td><td><input type="text" id="'+g+'Fl" class="slidval"></td><td></td></tr>');c.append(l);n="#"+g+"Fl";m="#"+g+"Fd";1==jqmobile?$(function(){var a=load_device(k,g);"F0"==a&&(a=0);$(m).slider({stop:function(a,b){var c=
$(a.target).attr("id"),d=$(a.target).val();0==d?(handle_device(c.slice(0,-2),"F"+d),$("#"+c.slice(0,-2)+"F1").removeClass("hover"),$("#"+c.slice(0,-2)+"F0").addClass("hover")):(handle_device(c,"P"+d),$("#"+c.slice(0,-2)+"F0").removeClass("hover"),$("#"+c.slice(0,-2)+"F1").addClass("hover"));store_device(s_room_id,c.slice(0,-2),d)}});$(m).slider("refresh")}):$(function(){var a=load_device(k,g);$(m).slider({range:"max",main:1,min:15,max:25,value:a,slide:function(a,b){var c="#"+$(a.target).attr("id").slice(0,
-1)+"l";$(c).val(b.value)},stop:function(a,b){var c=$(a.target).attr("id"),d=b.value;handle_device(c,"P"+d);store_device(s_room_id,c.slice(0,-2),d)}});$(n).val(a)});break;default:alert("lamp_button, type: "+l+" unknown")}}}s_room_id=b;$("#gui_devices").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();var c=$(a.target).attr("id");switch(c){case "Ra":2<debug&&alert("activate_room:: Add Device Button: "+c);for(var e=1;e<=max_devices;){for(a=0;a<devices.length&&(devices[a].room!=
s_room_id||devices[a].id.substr(1)!=e);a++);if(a==devices.length)break;e++}1<debug&&alert("Add device:: room:"+s_room_id+", device: "+e+", devices.length: "+devices.length);c='<label for="val_3">  Select Brand: </label><select id="val_3" value="kaku">';for(a=0;a<brands.length;a++)c+="<option>"+brands[a].name+"</option>";askForm('<form id="addRoomForm"><fieldset><p>You have created a new device, please give it a name and specify its type and brand. Optionally, the group address can be set if this device address is different from the room address</p><label for="val_1">Name: </label><input type="text" name="val_1" id="val_1" value="" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Type: </label><select id="val_2" value="switch" ><option selected="selected">switch</option><option>dimmer</option><br /><option>thermostat</option></select><br />'+
(c+"</select><br />")+'<label for="val_4">Group addr: </label><input type="text" name="val_4" id="val_4" value="'+(Number(s_room_id)+99)+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_5">Unit addr: </label><input type="text" name="val_5" id="val_5" value="'+e+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);for(var b,c,d=0;d<brands.length;d++)brands[d].name==a[2]&&(b=brands[d].id,c=brands[d].fname);
if("dimmer"==a[1]&&"kaku"!=c&&"zwave"!=c)return alert("Type dimmer is not supported for brand "+c),1;if("thermostat"==a[1]&&"zwave"!=c)return alert("Type thermostat is not supported for brand "+c),1;a={id:"D"+e,room:""+s_room_id+"",gaddr:a[3],name:a[0],type:a[1],uaddr:a[4],val:"0",lastval:"0",brand:b};devices.push(a);logger(a,2);send2daemon("dbase","add_device",a);activate_room(s_room_id);return 1},function(){activate_room(b);return 1},"Confirm Create");return 1;case "Rx":return message('<p style="textdecoration: blink; background-color:yellow; color:black;">Click a button to delete ...</p>'),
activate_room(b,"Del"),1;case "Fa":handle_device("","Fa");for(a=0;a<devices.length;a++)devices[a].room==s_room_id&&"thermostat"!=devices[a].type&&(store_device(s_room_id,devices[a].id,"OFF"),logger("activate_room:: All Off command for device: "+devices[a].uaddr,2));activate_room(s_room_id);return 1}if("Del"==d&&"checkbox"==$(this).attr("type")){1>debug&&$("#gui_messages").empty();var f=c.slice(0,-1),g=find_device(s_room_id,f),l=$(this);message("Device to delete: id Name"+devices[g].name,0);myConfirm("You have selected device "+
devices[g].name+" for deletion. Do you really want to delete this device?",function(){l.closest("tr").remove();var a=devices.splice(g,1);logger(a[0]);send2daemon("dbase","delete_device",a[0]);1<debug&&alert("Removed from dbase:: id: "+a[0].id+" , name: "+a[0].name);1<debug&&alert("Removed object id:"+f);activate_room(b);return 1},function(){activate_room(b);return 1},"Confirm Delete");return 1}if("Sel"==d&&"checkbox"==$(this).attr("type"))return message("Device Add",1),alert("Device Add\nid: "+f),
1;c=$(this).attr("id");f=c.slice(0,-2);value=$(this).val();handle_device(f,value);store_device(s_room_id,f,value);1==jqmobile?(c="0"==c.substr(-1,1)?c.slice(0,-1)+"1":c.slice(0,-1)+"0",$("#"+c).removeClass("hover")):$(this).parent().siblings().children().removeClass("hover");$(this).addClass("hover");button_class=$(a.target).parent().parent().attr("class");"devrow dimrow"==button_class&&(a="#"+f+"Fd",value=load_device(s_room_id,f),"OFF"==value&&(value=0),1==jqmobile?($(a).val(value),$(a).slider("refresh")):
($(a).slider("option","value",value),$("#"+f+"Fl").val(value)))});if(1!=jqmobile){var q;$("#gui_devices tbody").last().sortable({start:function(a,b){$(b.item).data("startindex",b.item.index());q=b.item.index();logger("Start pos: "+q)},stop:function(a,b){var c=b.item.index(),d,e;logger("sortable:: start_pos: "+q+", stop_pos: "+c);for(var f=g=0;f<devices.length;f++)devices[f].room==s_room_id&&(g==q?e=f:g==c&&(d=f),g++);logger("room: "+s_room_id+",start_index: "+e+", stop_index: "+d);logger("room: "+
s_room_id+",start_pos:   "+q+", stop_pos:     "+c);c=devices.splice(e,1);devices.splice(d,0,c[0]);logger("name of device moved: "+c[0].name);for(var g=1,f=0;f<devices.length;f++)devices[f].room==s_room_id&&(devices[f].id="D"+g,logger("storing device: id: "+devices[f].id+", name: "+devices[f].name),g++)}}).disableSelection()}}
function activate_scene(b){$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");html_msg='<div id="gui_scenes"></div>';$("#gui_content").append(html_msg);for(var d=0;d<scenes.length;d++){var a=scenes[d].id;if(b==a){2<debug&&alert("Activate_screen:: Making buttons for scene: "+a);html_msg='<table border="0">';$("#gui_scenes").append(html_msg);var f=$("#gui_scenes").children(),c=scenes[d].seq,e='<thead><tr class="switch"><td colspan="2"><input type="submit" id="Fx'+a+'" value="X" class="dbuttons scene_button del_button"><input type="submit" id="Fr'+
a+'" value="+" class="dbuttons scene_button new_button"></td><td colspan="2"><input type="input"  id="Fl'+a+'" value= "'+scenes[d].name+'" class="dlabels"></td><td><input type="submit" id="Fc'+a+'" value="STOP" class="dbuttons scene_button"><input type="submit" id="Fe'+a+'" value="Store" class="dbuttons scene_button"><input type="submit" id="Fq'+a+'" value=">" class="dbuttons scene_button play_button"></td></thead>';$(f).append(e);$(f).append("<tbody>");if(""!=c)for(var g=c.split(","),c=0;c<g.length;c+=
2){var k=c/2+1,e=decode_scene_string(g[c]);decode_scene_string(g[c+1]);e='<tr class="scene"><td><input type="checkbox" id="s'+a+'c" name="cb'+k+'" value="yes"></td><td> '+k+'<td><input type="input" id="Fs'+a+"i"+k+'" value= "'+g[c]+'" class="dlabels sval"></td><td><input type="text" id="Ft'+a+"t"+k+'" value= "'+g[c+1]+'" class="dbuttons scene_button sval"></td><td>'+e;$(f).append(e)}else k=0;1==s_recording&&(e=decode_scene_string(s_recorder),logger("Need to decode s_recorder"),s_recording=0,k++,e=
'<tr class="scene"><td><input type="checkbox" id="s'+a+'c" name="cb'+k+'" value="yes"></td><td>'+k+'<td><input type="input" id="Fs'+a+"i"+k+'" value= "'+s_recorder+'" class="dlabels sval"></td><td><input type="text" id="Ft'+a+"t"+k+'" value= "00:00:10" class="dbuttons scene_button sval"></td><td colspan="2">'+e,$(f).append(e),scenes[d].seq=1==k?s_recorder+",00:00:10":scenes[d].seq+(","+s_recorder+",00:00:10"),2<debug&&alert("Recorder adding:: j: "+d+", s_scene_id: "+s_scene_id+"\n\n id: "+scenes[d].id+
"\nval: "+scenes[d].val+"\n name: "+scenes[d].name+"\nseq: "+scenes[d].seq),send2daemon("dbase","store_scene",scenes[d]),message("Device command added to the scene"))}}1!=jqmobile&&$("#gui_scenes tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,c){var d="";$("#gui_scenes .scene").each(function(a){var c=$(this).children().children(".dbuttons").attr("id").substr(4);logger("scn: "+b+" html index: "+a+" scene ind: "+c);d+=g[2*(c-1)]+","+g[2*(c-1)+1]+","});
logger("my_list :"+d);d=d.slice(0,-1);logger("scene: "+b+", "+scenes[b-1].name+", my_list: "+d);scenes[b-1].seq=d}}).disableSelection();s_scene_id=b}
function activate_timer(b){2<debug&&alert("activate_timer");$("#gui_content").empty();html_msg='<div id="gui_timers"></div>';$("#gui_content").append(html_msg);for(var d=0;d<timers.length;d++){var a=timers[d].id;if(b==a){var f=timers[d];html_msg='<table border="0">';$("#gui_timers").append(html_msg);var c=$("#gui_timers").children(),e='<thead><tr class="switch"><td><input type="submit" id="'+a+'Fe" value="Store" class="dbuttons play_button" style="min-width:100px;"></td><td><input type="input"  id="'+
a+'Fl" value="'+timers[d].name+'" class="dlabels"></td><td><input type="submit" id="'+a+'Fx" value="Cancel Once" class="dbuttons stop_button" ></td></thead>';$(c).append(e);$(c).append("<tbody>");a="<tr>";a+='<td><label for="scene">Select Scene: </label></td>';a+='<td><select id="scene" value="scene" style="font-size:normal;" class="dlabels">';for(k=0;k<scenes.length;k++)a=scenes[k].name==f.scene?a+('<option class="dlabels" value="'+scenes[k].name+'" selected>'+scenes[k].name+"</option>"):a+('<option class="dlabels" value="'+
scenes[k].name+'" >'+scenes[k].name+"</option>");a+="</select></td>";e='<tr class="timer"><form><fieldset name="scene_select">'+a+"<br /></fieldset></form>";$(c).append(e);a=f.tstart.split(":");e='<td><input type="text" id="Tv" value= "';switch(a[0]){case "96":e+="Sunrise - "+30*a[1]+" minutes";break;case "97":e+="Sunrise + "+30*a[1]+" minutes";break;case "98":e+="Sunset - "+30*a[1]+" minutes";break;case "99":e+="Sunset + "+30*a[1]+" minutes";break;default:e+=("00"+a[0]).slice(-2)+":"+("00"+a[1]).slice(-2)}e+=
'" class="dlabels sval" style="width:120px;">';e+="</td>";str3="<td>";str3+='<input type="submit" id="Ts" value="Time" class="dbuttons timbut">';str3+='<input type="submit" id="Tr" value="SunRise" class="dbuttons timbut" >';str3+='<input type="submit" id="Td" value="SunSet" class="dbuttons timbut" >';str3+="</select></td>";e='<tr class="timer"><tr><td><label for="tstart">Start time: </label></td>'+e+"<form><fieldset>"+str3+"<br /></fieldset></form></tr>";$(c).append(e);$(".timbut").removeClass("hover");
"96"==a[0]||"97"==a[0]?$("#Tr").addClass("hover"):"98"==a[0]||"99"==a[0]?$("#Td").addClass("hover"):$("#Ts").addClass("hover");a="<td>Start Date: </td>";if(1!=jqmobile)a+='<td><input  class="dlabels" type="text" id="startd" value="'+f.startd+'"/></td>',e='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(c).append(e),$(function(){$("#startd").datepicker({dateFormat:"dd/mm/y"})});else{var e=f.startd.substr(0,2),g=f.startd.substr(3,2),k=f.startd.substr(6,2),a=a+('<td><input  class="dlabels" type="text" min="2013-12-15" id="startd" value="20'+
k+"-"+g+"-"+e+'"/></td>'),e='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>";$(c).append(e);startd=$("#startd").mobipick({dateFormat:"dd/MM/yy"});startd.on("change",function(){f.startd=$("#startd").val();alert("startd:: "+f.startd)})}a="<td>End Date: </td>";1!=jqmobile?(a+='<td><input  class="dlabels" type="text" id="endd" value="'+f.endd+'"/></td>',e='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(c).append(e),$(function(){$("#endd").datepicker({dateFormat:"dd/mm/y"})})):
(e=f.endd.substr(0,2),g=f.endd.substr(3,2),k=f.endd.substr(6,2),a+='<td><input  class="dlabels" type="text" min="2013-12-15" id="endd" value="20'+k+"-"+g+"-"+e+'"/></td>',e='<tr class="timer"><form><fieldset>'+a+"</fieldset></form></tr>",$(c).append(e),endd=$("#endd").mobipick({dateFormat:"dd/MM/yy"}),endd.on("change",function(){f.endd=$("#endd").val()}));for(var a='<td colspan="3"><br /><div class="days">',e="Mon Tue Wed Thu Fri Sat Sun".split(" "),k=0;7>k;k++)a="x"!=f.days.substr(k,1)?a+(" "+e[k]+
'<input type="checkbox" id="'+k+'" name="'+e[k]+'" value="'+k+'" checked="checked" >'):a+(" "+e[k]+'<input type="checkbox" id="'+k+'" name="'+e[k]+'" value="'+k+'" >');a+="</div></td>";e='<tr><td colspan="3"><p>On what days of the week?</p></td></tr>';e+='<tr class="timer">'+a+"<br></tr>";$(c).append(e);a='<tr><td colspan="3"><a>What months should the timer run?</a></td></tr>';a+='<tr class="timer"><td colspan="3"><br /><div class="months">';g="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" ");
for(k=0;12>k;k++)a="x"!=f.months.substr(k,1)?a+(" "+g[k]+'<input type="checkbox" id="'+k+'" name="'+g[k]+'" value="'+k+'" checked="checked">'):a+(" "+g[k]+'<input type="checkbox" id="'+k+'" name="'+g[k]+'" value="'+k+'">');a+="</div></td><br></tr>";$(c).append(a);$("#gui_timers").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();a=$(a.target).attr("id");var b=get_timer(s_timer_id);switch(a.substr(-2)){case "Fe":var c=$.map($(".days :input:checkbox:checked"),function(a,b){return+a.value}),
d="xxxxxxx";a="mtwtfss";for(var e=0;e<c.length;e++)d=d.substr(0,c[e])+a.substr(c[e],1)+d.substr(c[e]+1);b.days=d;c=$.map($(".months :input:checkbox:checked"),function(a,b){return+a.value});d="xxxxxxxxxxxx";a="jfmamjjasond";for(e=0;e<c.length;e++)d=d.substr(0,c[e])+a.substr(c[e],1)+d.substr(c[e]+1);b.months=d;b.scene=$("#scene").val();b.startd=$("#startd").val();b.endd=$("#endd").val();a="STORE timer::\n, scene: "+b.scene+"\n, tstart: "+b.tstart+"\n, startd: "+b.startd+"\n, endd: "+b.endd+"\n, days: "+
b.days+"\n, months: "+b.months+"\n, skip: "+b.skip+"\n";1<=debug&&logger("store_timer"+a);send2daemon("dbase","store_timer",b);break;case "Fx":$(".timbut").removeClass("hover");$("#Fx").addClass("hover");myConfirm("You are about to cancel this timer. If you continue, the system will for one time skip this timer action",function(){message("Skipping")},function(){message("Not Skipping");return 0},"Cancel this timer once?");b.skip="1";set_timer(s_timer_id,b);send2daemon("dbase","store_timer",b);$("#Fx").removeClass("hover");
break;case "Fr":myConfirm("You are about to add a new action to the timer. If you continue, the systemwill be in recording mode until you have selected a device action. Then you are returnedto this timer screen again. Please confirm if you want to add a device.",function(){message('<p style="textdecoration:blink; background-color:red; color:white;">RECORDING</p>')},function(){s_recording=0;return 1},"Adding a Timer action?");s_recording=1;s_recorder="";init_rooms("init");break;case "Ts":$(".timbut").removeClass("hover");
$("#Ts").addClass("hover");for(var f=$("#Tv").val(),c="",e=0;24>e;e++)c=12==e?c+("<option selected>"+("00"+e).slice(-2)+"</option>"):c+("<option>"+("00"+e).slice(-2)+"</option>");a="";for(e=0;60>e;e++)a+="<option>"+("00"+e).slice(-2)+"</option>";a='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm</p><br /><label for="val_1">hrs: </label><select id="val_1" value="'+f.substr(0,2)+'" >'+c+'</select><label for="val_2">mins: </label><select id="val_2" value="'+
f.substr(3,2)+'">'+a+"</select></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);a=a[0]+":"+a[1];$("#Tv").val(a);b.tstart=a;1<debug&&alert("Timer changed from "+f+" to: "+a);set_timer(s_timer_id,b)},function(){},"Confirm Change");break;case "Tr":$(".timbut").removeClass("hover");$("#Tr").addClass("hover");f=$("#Tv").val();a="";for(e=-4;5>e;e++)a=0==e?a+("<option selected>"+30*("00"+e).slice(-2)+"</option>"):a+("<option>"+30*("00"+e).slice(-2)+"</option>");
a='<form id="addRoomForm"><fieldset><p>Setting the timer to start at SunRise</p><br /><label for="val_1">Sunrise offset in minutes: </label><select id="val_1" value="'+f.substr(3,2)+'">'+a+"</select></fieldset></form>";askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);0>a[0]?(laval="SunRise - "+a[0].substr(1)+" minutes",b.tstart="96:"+("00"+a[0]/-30).slice(-2)):(laval="SunRise + "+a[0]+" minutes",b.tstart="97:"+("00"+a[0]/30).slice(-2));$("#Tv").val(laval);1<debug&&alert("Timer changed from "+
f+" to: "+laval);set_timer(s_timer_id,b)},function(){},"Set Sunrise Timer");break;case "Td":$(".timbut").removeClass("hover");$("#Td").addClass("hover");f=$("#Tv").val();a="";for(e=-4;5>e;e++)a=0==e?a+("<option selected>"+30*("00"+e).slice(-2)+"</option>"):a+("<option>"+30*("00"+e).slice(-2)+"</option>");a='<form id="addRoomForm"><fieldset><p>Setting the timer to start at SunSet</p><br /><label for="val_1">Sunset offset in minutes: </label><select id="val_1" value="'+f.substr(3,2)+'">'+a+"</select></fieldset></form>";
askForm(a,function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);0>a[0]?(laval="SunSet - "+a[0].substr(1)+" minutes",b.tstart="98:"+("00"+a[0]/-30).slice(-2)):(laval="SunSet + "+a[0]+" minutes",b.tstart="99:"+("00"+a[0]/30).slice(-2));$("#Tv").val(laval);1<debug&&alert("Timer changed from "+f+" to: "+laval);0>set_timer(s_timer_id,b)&&alert("Cannot set timer values in object")},function(){},"Set Sunset Timer");break;case "Tv":$("#Ts").hasClass("hover")&&alert("Ts time");$("#Tr").hasClass("hover")&&
alert("Tr sunrise");$("#Td").hasClass("hover")&&alert("Td sunsetk");break;default:alert("Sequence action unknown: "+a.substr(-2))}})}}s_timer_id=b}
function activate_handset(b){$("#gui_content").empty();$("#gui_content").css("overflow-y","auto");html_msg='<div id="gui_handsets"></div>';$("#gui_content").append(html_msg);for(var d,a=d=0;a<handsets.length;a++){var f=handsets[a].id;if(b==f){2<debug&&alert("Activate_handset:: Making buttons for handset: "+f);var c=handsets[a].name,e=handsets[a].scene,g=handsets[a].addr,k=handsets[a].unit,l=handsets[a].val;if(0==d){html_msg='<table border="0">';$("#gui_handsets").append(html_msg);var p=$("#gui_handsets").children(),
h='<thead><tr class="switch"><td colspan="2"><input type="submit" id="Fx'+f+'" value="X" class="dbuttons del_button"><input type="submit" id="Fr'+f+'" value="+" class="dbuttons new_button"></td><td colspan="2"><input type="input"  id="Fl'+f+'" value= "'+c+'" class="dlabels"> addr: '+g+'</td><td><input type="submit" id="Fe'+f+'" value="Store" class="dbuttons"></td></thead>';$(p).append(h);$(p).append("<tbody>");d=1}if(""!=e)for(c=e.split(","),g=0;g<c.length;g+=2){var n=g/2+1,h=0==l?"off":"on",m=decode_scene_string(c[g]);
decode_scene_string(c[g+1]);h='<tr class="handset"><td><input type="checkbox" id="s'+f+'c" name="cb'+n+'" value="yes"></td><td>But '+k+" "+h+'</td><td><input type="input" id="Fs'+f+"u"+k+"v"+l+"i"+n+'" value= "'+c[g]+'" class="dlabels sval"></td><td><input type="text" id="Ft'+f+"u"+k+"v"+l+"i"+n+'" value= "'+c[g+1]+'" class="dbuttons sval"></td><td>'+m;$(p).append(h)}else n=0;1==s_recording&&(m=decode_scene_string(s_recorder),logger("Decode s_recorder to: "+m),s_recording=0,n++,h='<tr class="handset"><td><input type="checkbox" id="s'+
f+'c" name="cb'+n+'" value="yes"></td><td>But '+n+'<td><input type="input" id="Fs'+f+"u"+k+"v"+l+"i"+n+'" value= "'+s_recorder+'" class="dlabels sval"></td><td><input type="text" id="Ft'+f+"u"+k+"v"+l+"i"+n+'" value= "00:00:10" class="dbuttons sval"></td><td colspan="2">'+m,$(p).append(h),handsets[a].scene=1==n?s_recorder+",00:00:10":handsets[a].scene+(","+s_recorder+",00:00:10"),2<debug&&alert("Recorder adding:: j: "+a+", s_handset_id: "+s_handset_id+"\n\n id: "+handsets[a].id+"\nval: "+handsets[a].val+
"\n name: "+handsets[a].name+"\nseq: "+handsets[a].scene),send2daemon("dbase","store_handset",handsets[a]),message("Device command added to the handsets",1))}}$("#gui_handsets").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();var b=$(a.target).attr("id");parse_int(b);switch(b.substr(0,2)){case "Fe":for(var c=get_handset(s_handset_id),d=c.name,f=0;f<handsets.length;f++)handsets[f].id==s_handset_id&&(logger("Fe Storing handset:: "+d+":"+handsets[f].unit+":"+handsets[f].val),
send2daemon("dbase","store_handset",handsets[f]));break;case "Fx":2<debug&&alert("Activate_handset:: Delete Fx button pressed");var g="Deleted actions ";0<debug&&myConfirm("You are about to delete one or more button actions for this handset. If you continue, all lines that you checked will be deleted from the system and this will be synchronized with the database.\nPlease keep in mind that you will delete ALL lines that you checked and and its corresponding actions ",function(){$($("#gui_handsets .handset").get().reverse()).each(function(a){var b=
$(this).children().children(".dlabels").attr("id"),f=$(this).children().children(".dlabels").attr("value"),k=parse_int(b)[0],h=parse_int(b)[1],l=parse_int(b)[2],m=parse_int(b)[3];c=get_handset_record(k,h,l);e=c.scene;var n=e.split(","),m=n.indexOf(f);if($(this).children().children('input[type="checkbox"]').is(":checked"))for(1<debug&&alert("delete handset button: "+d+"\nid: "+b+", scene ind: "+m+" selected, index: "+a+"\nHandset id: "+k+", unit: "+h+", val: "+l+"\nScene: "+e),a=n.splice(m,2),m--,
1<debug&&alert("removed:"+a[0]+","+a[1]+": from seq: "+n),g+=m+" : "+decode_scene_string(a[0])+"; ",m=0;m<handsets.length;m++)if(handsets[m].id==k&&handsets[m].unit==h&&handsets[m].val==l){"undefined"==typeof n?2<debug&&alert("activate_handset:: case FX: handset_split undefined"):(handsets[m].scene=n.join(),2<debug&&alert("scene: "+handsets[m].scene));break}});message(g);activate_handset(s_handset_id)},function(){activate_handset(s_handset_id);return 0},"Continue Deleting Handet(s)?");break;case "Fr":2<
debug&&alert("Activate_handset:: Add Fr button pressed, start recording ...");myConfirm("You are about to add an action to this handset. If you continue, the system will be in recording mode until you have selected a device action. Then you are returned to this scene screen again. Please confirm if you want to add actions to this handset. ",function(){message('<p style="textdecoration: blink; background-color:red; color:white;">RECORDING</p>');s_recording=1;s_recorder="";init_handsets("init")},function(){s_recording=
0;return 1},"Adding a handset action?");break;case "Ft":var k=$(a.target).val(),f="";for(i=0;24>i;i++)f=i==k.substr(0,2)?f+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):f+("<option>"+("00"+i).slice(-2)+"</option>");var h="";for(i=0;60>i;i++)h=i==k.substr(3,2)?h+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):h+("<option>"+("00"+i).slice(-2)+"</option>");var l="";for(i=0;60>i;i++)l=i==k.substr(6,2)?l+('<option selected="selected">'+("00"+i).slice(-2)+"</option>"):
l+("<option>"+("00"+i).slice(-2)+"</option>");f='<form id="addRoomForm"><fieldset><p>You can change the timer settings for this action. Please use hh:mm:ss</p><br /><label style="width:50px;" for="val_1">hrs: </label><select id="val_1" value="'+k.substr(0,2)+'" >'+f+'</select><label style="width:50px;" for="val_2">mins: </label><select id="val_2" value="'+k.substr(3,2)+'">'+h+'</select><label style="width:50px;" for="val_3">secs: </label><select id="val_3" selectedIndex="10" value="'+k.substr(6,2)+
'">'+l+"</select></fieldset></form>";askForm(f,function(c){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+c);c=c[0]+":"+c[1]+":"+c[2];$(a.target).val(c);2<debug&&alert("Timer changed from "+k+" to: "+$(a.target).val());var d=parse_int(b),e;for(e=0;e<handsets.length&&(handsets[e].id!=d[0]||handsets[e].unit!=d[1]||handsets[e].val!=d[2]);e++);var d=handsets[e].scene.split(","),f=$(a.target).attr("id"),g="Fs"+f.substr(2),h=$("#"+g).val();alert("tid: "+f+", sid: "+g+", sval: "+h);f=d.indexOf(h);
alert("split ind: "+f);d[f+1]=c;handsets[e].scene=d.join();return 0},function(){return 1},"Confirm Change");break;default:alert("Sequence action unknown: "+b.substr(-2))}});1!=jqmobile&&$("#gui_handsets tbody").sortable({start:function(a,b){$(b.item).data("startindex",b.item.index())},stop:function(a,c){var d="";$("#gui_handsets .scene").each(function(a){var c=$(this).children().children(".dbuttons").attr("id").substr(4);logger("scn: "+b+" html index: "+a+" scene ind: "+c);d+=scene_split[2*(c-1)]+
","+scene_split[2*(c-1)+1]+","});logger("my_list :"+d);d=d.slice(0,-1);logger("scene: "+b+", "+handsets[b-1].name+", my_list: "+d);handsets[b-1].scene=d}}).disableSelection();s_handset_id=b}
function activate_sensors(b){$("#gui_messages").empty();$("#gui_content").empty();$("#gui_content").css("overflow-x","auto");html_msg='<div id="gui_sensors"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_sensors").append(html_msg);for(var d=$("#gui_sensors").children(),a=0,f=0;f<sensors.length;f++)sensors[f].location==b&&a++;var c,e=100/a;c="<tbody><tr>";for(f=0;f<a;f++)c+='<td width="'+e+'%" class="cw_button">',c+='<canvas id="canvasRadial'+(f+1)+'" width="201" height="201"></canvas>',
c+="</td>";c+="</tr><tr>";for(f=0;f<a;f++){var g="canvasRadial"+(a+f+1)+"";c+='<td width="'+e+'%" class="cw_button">';c+='<canvas id="'+g+'" width="201" height="201">No canvas in your browser...</canvas>';c+="</td>"}c+="</tr>";c+="</tbody></table>";$(d).append(c);$.getScript("steel/steelseries-min.js",function(){steelseries.Section(0,25,"rgba(0, 0, 220, 0.3)");steelseries.Section(25,50,"rgba(0, 220, 0, 0.3)");steelseries.Section(50,75,"rgba(220, 220, 0, 0.3)");var c=[steelseries.Section(950,990,"rgba(0, 0, 220, 0.3)"),
steelseries.Section(990,1030,"rgba(0, 220, 0, 0.3)"),steelseries.Section(1030,1050,"rgba(220, 220, 0, 0.3)")];steelseries.Section(75,100,"rgba(220, 0, 0, 0.3)");var d=[steelseries.Section(1050,1100,"rgba(220, 0, 0, 0.3)")],e=new steelseries.gradientWrapper(-20,40,[0,.2,.4,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]),f=new steelseries.gradientWrapper(0,
100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);new steelseries.gradientWrapper(950,1100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);for(var g={},m=0,q=0;q<sensors.length;q++)sensors[q].location==
b&&("temperature"in sensors[q].sensor?(g[m]=new steelseries.RadialBargraph("canvasRadial"+(m+1),{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:-20,maxValue:40,valueGradient:e,useValueGradient:!0,titleString:sensors[q].name+"@"+sensors[q].location,unitString:"Temp C",threshold:30,lcdVisible:!0}),g[m].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL),g[m].setValueAnimated(sensors[q].sensor.temperature.val)):logger("sensors temperature "+
m+" is not defined"),"humidity"in sensors[q].sensor?(g[m+a]=new steelseries.RadialBargraph("canvasRadial"+(m+a+1),{gaugeType:steelseries.GaugeType.TYPE4,size:201,valueGradient:f,useValueGradient:!0,titleString:sensors[q].location,unitString:"Humidity %",threshold:80,lcdVisible:!0}),g[m+a].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m+a].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL),g[m+a].setValueAnimated(sensors[q].sensor.humidity.val)):logger("sensors humidity "+m+" is not defined"),
"airpressure"in sensors[q].sensor?(logger("iradial "+(m+a)+",j: "+q+" set airpressure: "+sensors[q].sensor.airpressure.val),g[m+a]=new steelseries.RadialBargraph("canvasRadial"+(m+a+1),{gaugeType:steelseries.GaugeType.TYPE3,size:201,minValue:950,maxValue:1100,area:d,section:c,useSectionColors:!0,titleString:sensors[q].location,unitString:"Pressure Pa",threshold:80,lcdVisible:!0}),g[m+a].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL),g[m+a].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL),
g[m+a].setValueAnimated(sensors[q].sensor.airpressure.val)):logger("sensors airpressure "+m+" is not defined"),m++);var r;r=setInterval(function(){if("sensor"==s_screen){for(var c=0,d=0;d<sensors.length;d++)sensors[d].location==b&&("temperature"in sensors[d].sensor&&void 0!==sensors[d].sensor.temperature.val&&""!=sensors[d].sensor.temperature.val?g[c].setValueAnimated(sensors[d].sensor.temperature.val):message("not set temperature. ",3),"humidity"in sensors[d].sensor&&void 0!==sensors[d].sensor.humidity.val&&
""!=sensors[d].sensor.humidity.val?(message("radial "+(c+a)+",j: "+d+" set humidity: "+sensors[d].sensor.humidity.val,2),g[c+a].setValueAnimated(sensors[d].sensor.humidity.val)):message("not set humidity. ",3),"airpressure"in sensors[d].sensor&&void 0!==sensors[d].sensor.airpressure.val&&""!=sensors[d].sensor.airpressure.val?(message("airpressure: "+sensors[d].sensor.airpressure.val,2),g[c+a].setValueAnimated(sensors[d].sensor.airpressure.val)):message("not set airpressure. ",3),c++);c=w_sock.readyState;
1!=c&&(logger("Websocket:: error. State is: "+c),message("Websocket:: error. State is: "+c))}else clearInterval(r),message("Suspend Dials")},2E3)})}
function activate_energy(b){$("#gui_messages").empty();$("#gui_content").empty();$("#gui_content").css("overflow-x","auto");html_msg='<div id="gui_energy"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_energy").append(html_msg);b=$("#gui_energy").children();for(var d="<tbody><tr>",a=0;4>a;a++)d+='<td width="25%" class="ce_button">',d+='<canvas id="canvasRadial'+(a+1)+'" width="201" height="201"></canvas>',d+="</td>";d+="</tr><tr>";for(a=0;4>a;a++)var f="canvasRadial"+
(4+a+1)+"",d=d+'<td width="25%" class="ce_button">',d=d+('<canvas id="'+f+'" width="201" height="201">No canvas in your browser...</canvas>'),d=d+"</td>";d+="</tr>";d+="</tbody></table>";$(b).append(d);$.getScript("steel/steelseries-min.js",function(){steelseries.Section(0,25,"rgba(0, 0, 220, 0.3)");steelseries.Section(25,50,"rgba(0, 220, 0, 0.3)");steelseries.Section(50,75,"rgba(220, 220, 0, 0.3)");steelseries.Section(950,990,"rgba(0, 0, 220, 0.3)");steelseries.Section(990,1030,"rgba(0, 220, 0, 0.3)");
steelseries.Section(1030,1050,"rgba(220, 220, 0, 0.3)");steelseries.Section(75,100,"rgba(220, 0, 0, 0.3)");steelseries.Section(1050,1100,"rgba(220, 0, 0, 0.3)");var a=new steelseries.gradientWrapper(0,5E3,[0,.2,.4,.85,1],[new steelseries.rgbaColor(0,0,200,1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);new steelseries.gradientWrapper(0,100,[0,.33,.66,.85,1],[new steelseries.rgbaColor(0,0,200,
1),new steelseries.rgbaColor(0,200,0,1),new steelseries.rgbaColor(200,200,0,1),new steelseries.rgbaColor(200,0,0,1),new steelseries.rgbaColor(200,0,0,1)]);var b={};b[0]=new steelseries.RadialBargraph("canvasRadial1",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Actual",unitString:"kW",threshold:30,lcdVisible:!0});b[0].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[0].setValueAnimated(energy.kw_act_use);b[0].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);
b[1]=new steelseries.RadialBargraph("canvasRadial2",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 1",unitString:"kW",threshold:75,lcdVisible:!0});b[1].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[1].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[1].setValueAnimated(energy.kw_ph1_use);b[2]=new steelseries.RadialBargraph("canvasRadial3",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,
maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 2",unitString:"kW",threshold:75,lcdVisible:!0});b[2].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[2].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[2].setValueAnimated(energy.kw_ph2_use);b[3]=new steelseries.RadialBargraph("canvasRadial4",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:4,valueGradient:a,useValueGradient:!0,titleString:"Phase 3",unitString:"kW",threshold:75,lcdVisible:!0});
b[3].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[3].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[3].setValueAnimated(energy.kw_ph3_use);b[4]=new steelseries.RadialBargraph("canvasRadial5",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Hi Use",unitString:"kWhr",threshold:75,lcdVisible:!0});b[4].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[4].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);
b[4].setValueAnimated(energy.kw_hi_use);b[5]=new steelseries.RadialBargraph("canvasRadial6",{gaugeType:steelseries.GaugeType.TYPE4,size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Lo Use",unitString:"kWhr",threshold:75,lcdVisible:!0});b[5].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[5].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[5].setValueAnimated(energy.kw_lo_use);b[7]=new steelseries.RadialBargraph("canvasRadial8",{gaugeType:steelseries.GaugeType.TYPE4,
size:201,minValue:0,maxValue:9999,valueGradient:a,useValueGradient:!0,titleString:"Gas Use",unitString:"m3",threshold:75,lcdVisible:!0});b[7].setFrameDesign(steelseries.FrameDesign.GLOSSY_METAL);b[7].setBackgroundColor(steelseries.BackgroundColor.BRUSHED_METAL);b[7].setValueAnimated(energy.gas_use);var d;d=setInterval(function(){if("energy"==s_screen){b[0].setValueAnimated(energy.kw_act_use);b[1].setValueAnimated(energy.kw_ph1_use);b[2].setValueAnimated(energy.kw_ph2_use);b[3].setValueAnimated(energy.kw_ph3_use);
b[4].setValueAnimated(energy.kw_hi_use);b[5].setValueAnimated(energy.kw_lo_use);b[7].setValueAnimated(energy.gas_use);var a=w_sock.readyState;1!=a&&(logger("Websocket:: error. State is: "+a),message("Websocket:: error. State is: "+a))}else clearInterval(d),message("Suspend Dials"),logger("activate_energy:: s_screen is: "+s_screen)},2E3)})}
function activate_setting(b){s_setting_id=b;$("#gui_content").empty();switch(b+""){case "0":b=" <br>This is some text to explain the use of the debug parameter. During normal operation, the parameter should  be set to 0, which means no debug messages are displayed and only a condensed set of status messages will be shown. <li>Level 1: Will set debug level so that more messages are displayed in the message area </li><li>Level 2: Will add popup alerts for the main things/buttons/events </li><li>Level 3: All error and comment messages are displayed </li><br><br>";if(1==
jqmobile)$("#gui_content").append("<span>"+b+"</span>"),a='<fieldset data-role="controlgroup" data-type="horizontal"><legend>Select the LamPI debug level: </legend><input type="radio" name="radio-choice" id="rd0" value="0" checked="checked"><label for="rd0">L0</label><input type="radio" name="radio-choice" id="rd1" value="1"><label for="rd1">L1</label><input type="radio" name="radio-choice" id="rd2" value="2"><label for="rd2">L2</label><input type="radio" name="radio-choice" id="rd3" value="3"><label for="rd3">L3</label></fieldset>',
$("#gui_content").append(a),$("input[type='radio']").bind("change",function(a,b){debug=$("input[name*=radio-choice]:checked").val();settings[0].val=debug;send2daemon("dbase","store_setting",settings[0]);message("Debug set to: "+debug)});else{html_msg='<table border="0">';$("#gui_content").append(html_msg);var d=$("#gui_content").children();$(d).append("<tr><td><span>"+b+"</span>");var a='<tr class="switch"><td>Select the debug level: </td>';$(d).append(a);a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset" checked="checked"><label for="d0">L0</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">L1</label><input type="radio" name="choice" id="d2" value="2" class="buttonset"><label for="d2">L2</label><input type="radio" name="choice" id="d3" value="3" class="buttonset"><label for="d3">L3</label></span></td>';
$(d).append(a);debug=settings[0].val;$("#choice").buttonset();$("#d"+debug).attr("checked",!0).button("refresh");$("#choice input[type=radio]").change(function(){debug=this.value;settings[0].val=debug;0<debug&&myAlert("Set : "+settings[0].name+" to "+settings[0].val,"DEBUG LEVEL");send2daemon("dbase","store_setting",settings[0]);message("debug level set to "+debug)})}break;case "1":b=" <br>This menu option allows users to choose how the devices and sensors are laid out on the screen. The standard screen layout is with rows for the devices and using dials for the sensors.The rows layout is most used on hi-resolution tables and PCs. Mobile is a special variant of rows but for mobile devices. But alternatively the user may select that all devices are resented as tiles on the screen. <li>Rows: ....  </li><li>Mobile: ..... </li><li>Tiles: ....  </li><br><br>";
1==jqmobile?(logger("activate_setting:: layout jquerymobile",1),$("#gui_content").append("<span>"+b+"</span>"),a='<fieldset data-role="controlgroup" data-type="horizontal"><legend>Select the LamPI debug level: </legend><input type="radio" name="radio-choice" id="rd0" value="0" checked="checked"><label for="rd0">L0</label><input type="radio" name="radio-choice" id="rd1" value="1"><label for="rd1">L1</label><input type="radio" name="radio-choice" id="rd2" value="2"><label for="rd2">L2</label><input type="radio" name="radio-choice" id="rd3" value="3"><label for="rd3">L3</label></fieldset>',
$("#gui_content").append(a),$("input[type='radio']").bind("change",function(a,b){settings[1].val=$("input[name*=radio-choice]:checked").val();jqmobile=settings[1].val;send2daemon("dbase","store_setting",settings[1]);message("Layout set to: "+settings[1].val)})):(html_msg='<table border="0">',$("#gui_content").append(html_msg),d=$("#gui_content").children(),$(d).append("<tr><td><span>"+b+"</span>"),a='<tr class="switch"><td>Select the screen layout mode: </td>',$(d).append(a),a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset" checked="checked"><label for="d0">Rows</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">Mobile</label><input type="radio" name="choice" id="d2" value="2" class="buttonset"><label for="d2">Tiles</label></span></td>',
$(d).append(a),$("#choice").buttonset(),$("#d"+settings[1].val).attr("checked",!0).button("refresh"),$("#choice input[type=radio]").change(function(){settings[1].val=this.value;1<=debug&&myAlert("The Layout mode "+settings[1].name+" has been set to "+settings[1].val,"LamPI Layout Mode");send2daemon("dbase","store_setting",settings[1]);jqmobile=settings[1].val;message("The LamPI Layout mode has been set to "+settings[1].val+"<br>")}));break;case "2":logger("activate_setting:: users selected",2),send2daemon("dbase",
"list_user",settings[2]);case "2b":$("#gui_content").empty();html_msg='<div id="gui_uset"></div>';$("#gui_content").append(html_msg);$(d).append('<tr><td colspan="2"><span><br>This page allows you to perform some user setting functions.<br></span></td>');2<debug&&alert("Activate_setting 2:: Making buttons for setting: "+b);html_msg='<table border="0">';$("#gui_uset").append(html_msg);d=$("#gui_uset").children();a='<thead><tr class="switch"><td colspan="2"><input type="submit" id="Fx'+b+'" value="X" class="dbuttons scene_button del_button"><input type="submit" id="Fr'+
b+'" value="+" class="dbuttons scene_button new_button"></td><td colspan="2"><input type="input"  id="Fl'+b+'" value= "Users" class="dlabels"></td><td><input type="submit" id="Fe'+b+'" value="Store" class="dbuttons scene_button"></td></thead>';$(d).append(a);$(d).append("<tbody>");for(var f=0;f<users.length;f++)a='<tr class="scene"><td><input type="checkbox" id="s'+b+'c" name="cb'+f+'" value="yes"></td><td> '+f+"<td> "+users[f].name+'<td><input type="text" id="Fs'+b+"i"+f+'" value= "'+users[f].login+
'" class="dlabels sval"></td><td><input type="text" id="Ft'+b+"t"+f+'" value= "'+users[f].passw+'" class="dbuttons scene_button sval"></td>',$(d).append(a);$("#gui_uset").on("click",".dbuttons",function(a){bak=this.value;message("Backup Restore function chosen "+bak);switch(bak){case "store":a=$("#store_config").val();".cfg"!=a.substr(-4)&&(a+=".cfg");send2daemon("setting","store_config",a);0<debug&&myAlert("Backup: "+a);break;case "load":a=$("#load_config").val();send2daemon("setting","load_config",
a);1<=debug?myAlert("The configuration file is now set to: "+a,"CONFIGURATION"):message("Configuration file loaded "+a);break;default:myAlert("Unknown option for Users Setting: "+bak)}});break;case "3":html_msg='<table border="0">';$("#gui_content").append(html_msg);d=$("#gui_content").children();a='<tr class="switch"><td>Alarm status: </td>';$(d).append(a);a='<td><span id="choice" class="buttonset"><input type="radio" name="choice" id="d0" value="0" class="buttonset"><label for="d0">Armed</label><input type="radio" name="choice" id="d1" value="1" class="buttonset"><label for="d1">Home</label><input type="radio" name="choice" id="d2" value="2" class="buttonset" checked="checked"><label for="d2">Disarmed</label></span></td>';
$(d).append(a);b="<br>\t\tThis parameter deals with the status of the alarm system. <li>Armed: The system is armed and every alarm will reach the main subscriber of alarm events.<li>Home: The alarm system is armed, but only on outgoing sensors and on places that are not \t\tused in the house during night. <li>Disarmed: The alarm system is switched of. All sensors are not active.<br><br>";$(d).append("<tr><td><span>"+b+"</span>");alarmStatus=settings[3].val;$("#choice").buttonset();$("#d"+alarmStatus).attr("checked",
!0).button("refresh");$("#choice input[type=radio]").change(function(){alarmStatus=this.value;settings[3].val=alarmStatus;message("alarmStatus value set to "+alarmStatus);1<=debug&&alert("Set : "+settings[3].name+" to "+settings[3].val);send2daemon("dbase","store_setting",settings[3])});break;case "4":$("#gui_content").empty();html_msg='<div id="gui_skin"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_skin").append(html_msg);"undefined"!==typeof Storage&&localStorage.getItem("skin");
d=$("#gui_skin").children();a='<thead><tr class="switch"><td colspan="2">Choose your Style/Skin setting </td></tr></thead>';$(d).append(a);b="This option allows you to set the skin for your LamPI application. It will allow you to make your own selection of skins in a /styles/yourskin.css file, and make it the style of choice for your setting.<br><br>";b+="Note: Not supported on mobile devices!<br>";b+="Note: Better not choose a files for use on mobile devices ...<br><br>";$(d).append('<tr><td colspan="2"><span>'+
b+"</span>");$(d).append('<tr><td colspan="2">current skin is: <a class="dlabels">'+skin+"</a></td></tr><br><br><br>");var c='<fieldset><label for="load_skin">Select File: </label><select id="load_skin" value="styles/classic-blue.css" style="width:300px;" class="select-file">',e=[];logger("Calling dir read for: styles",0);logger("Host: "+window.location.host,1);b=window.location.host.split(":");$.ajax({url:"http://"+b[0]+"/styles",success:function(b){$(b).find("a:contains(.css)").each(function(){var a=
this.href.replace(window.location.host,"").replace(window.location.pathname,"").replace("http://",""),b=e.push("styles/"+a);logger("Filename: "+a+", new files length: "+b)});logger("Skin selection #files: "+e.length);for(b=0;b<e.length;b++)c=e[b]==settings[4].val?c+("<option selected>"+e[b]+"</option>"):c+("<option>"+e[b]+"</option>");c+="</select>";c+="</fieldset>";a='<tr><td><input type="submit" name="load_button" id="d1" value="load" class="dbuttons cc_button"><label for="d1">Load Configuration</label><td><form action="">'+
c+"</form></td></tr>";$(d).append(a)}});$("#gui_skin").on("click",".dbuttons",function(a){a=this.value;message("Skin selected "+a);switch(a){case "load":skin=$("#load_skin").val();$("link[href^='styles']").attr("href",skin);myConfirm("Do you want to set the "+skin+" Skin file as your default skin for users that start the application? Otherwise the existing default skin "+settings[4].val+" will be used. Please note that if you press cancel this skin will still be used in your current browser sesssion until you load another skin",
function(){message("updating the database");settings[4].val=skin;send2daemon("dbase","store_setting",settings[4])},function(){message("Not updated");return 0},"Set Default?");"undefined"!==typeof Storage&&(localStorage.setItem("skin",skin),1<=debug&&logger("Set localstorage skin: "+skin));activate_setting(4);break;default:myAlert("Unknown option for Skin/Styles Setting: "+bak)}});break;case "5":$("#gui_content").empty();html_msg='<div id="gui_backup"></div>';$("#gui_content").append(html_msg);html_msg=
'<table border="0">';$("#gui_backup").append(html_msg);d=$("#gui_backup").children();a='<thead><tr class="switch"><td colspan="2">What Backup or Restore action can we organize for you </td></tr></thead>';$(d).append(a);b="<br>This page allows you to perform some backup and restore functions.<br>It allows you to restore your database to a previous/known state,for example if you messed up.<br>Making regular backups of your configuration to file will greatly help in restoring to a useful state if something goes wrong.<br/><br/>The database.cfg file is one of the default files for the system, so please use another name for your backup.<br/><br/>NOTE: At this moment we do not check for overwriting existing files.<br/>";
$(d).append('<tr><td colspan="2"><span>'+b+"</span></td>");c='<fieldset><label for="load_config">Select File: </label><select id="load_config" value="load" class="dlabels" style="width:200px;">';e={};e=send2daemon("setting","list_config","*cfg");c+="<option>   </option>";for(b=0;b<e.length;b++)c+="<option>"+e[b]+"</option>";c+="</select>";c+="</fieldset>";a='<tr><td><input type="submit" name="store_button" id="d0" value="store" class="dbuttons buttonset"><label for="d0">Backup the configuration</label></td><td><fieldset>To File &nbsp&nbsp:&nbsp&nbsp<input type="input" id="store_config" value="" class="dlabels" style="width:200px;"></fieldset></td></tr><tr><td><input type="submit" name="load_button" id="d1" value="load" class="dbuttons cc_button"><label for="d1">Load Configuration</label><td><form action="">'+
c+"</form></td></tr>";$(d).append(a);$("#gui_backup").on("click",".dbuttons",function(a){bak=this.value;message("Backup Restore function chosen "+bak);switch(bak){case "store":a=$("#store_config").val();".cfg"!=a.substr(-4)&&(a+=".cfg");send2daemon("setting","store_config",a);0<debug&&myAlert("Backup: "+a);break;case "load":a=$("#load_config").val();send2daemon("setting","load_config",a);1<=debug?myAlert("The configuration file is now set to: "+a,"CONFIGURATION"):message("Configuration file loaded "+
a);break;default:myAlert("Unknown option for Backup Setting: "+bak)}});break;case "6":$("#gui_content").empty();html_msg='<div id="gui_console"></div>';$("#gui_content").append(html_msg);html_msg='<table border="0">';$("#gui_console").append(html_msg);d=$("#gui_console").children();a='<thead><tr class="switch"><td colspan="2">Select your console function</td></tr></thead>';$(d).append(a);a='<thead><tr class="switch">';1==jqmobile?a+='<td><input type="submit" id="Cc" value="Clients" class="dbuttons" ></td>':
(a+="<td>",a+='<input type="submit" id="Cc" value="Connected Clients" class="dbuttons" >',a+='<input type="submit" id="Cs" value="Sunrise Sunset" class="dbuttons" >',a+='<input type="submit" id="Cl" value="Daemon log" class="dbuttons" >',a+='<input type="submit" id="Cz" value="Zway log" class="dbuttons" >',a+='<input type="submit" id="Cr" value="Daemon Restart" class="dbuttons" >',a+='<input type="submit" id="Cp" value="Config Print" class="dbuttons" >',a+="</td>");$(d).append(a);$(d).append("</tr>");
$("#gui_console").on("click",".dbuttons",function(a){a.preventDefault();value=$(this).val();a=$(a.target).attr("id");switch(a.substr(0,2)){case "Cl":a={tcnt:++w_tcnt%1E3,action:"console",request:"logs"};logger(a);message("Console Log request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cz":a={tcnt:++w_tcnt%1E3,action:"console",request:"zlogs"};logger(a);message("Console ZLog request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cs":a={tcnt:++w_tcnt%1E3,action:"console",
request:"sunrisesunset"};logger(a);message("Console Sunrise/Sunset request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cc":a={tcnt:++w_tcnt%1E3,action:"console",request:"clients"};logger(a);message("Console Clients request sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cr":a={tcnt:++w_tcnt%1E3,action:"console",request:"rebootdaemon"};logger(a);message("Console Client request rebootDaemon sent to server",1);w_sock.send(JSON.stringify(a));break;case "Cp":a={tcnt:++w_tcnt%
1E3,action:"console",request:"printConfig"};logger(a);message("Console Client request printConfig sent to server",1);w_sock.send(JSON.stringify(a));break;default:alert("Console action unknown: "+a.substr(-2))}});break;case "7":logger("activate_setting:: rules selected",2);break;default:myAlert("Config encountered internal error: unknown button "+b)}}function room_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="hr_button '+a+'">'}
function scene_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="hs_button '+a+'">'}function menu_button(b,d,a){return'<td><input type="submit" id="'+b+'" value= "'+d+'" class="hm_button '+a+'"></td>'}function timer_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="ht_button '+a+'">'}function handset_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="hh_button '+a+'">'}
function sensors_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="hw_button '+a+'">'}function setting_button(b,d,a){return'<input type="submit" id="'+b+'" value= "'+d+'" class="hc_button '+a+'">'}
function store_device(b,d,a){for(var f=0;f<devices.length;f++){var c=devices[f].id;if(devices[f].room==b&&c==d){b=devices[f].type;"OFF"==a&&"switch"==b?devices[f].val=0:"ON"==a&&"switch"==b?devices[f].val=1:"ON"==a&&"dimmer"==b?devices[f].val=devices[f].lastval:"OFF"==a&&"dimmer"==b?devices[f].val=0:(devices[f].val=a,devices[f].lastval=a);break}}return 1}function find_device(b,d){for(var a=0;a<devices.length;a++){var f=devices[a].id;if(devices[a].room==b&&f==d)return a}return-1}
function lookup_uaddr(b,d){for(var a=0;a<devices.length;a++){var f=devices[a].uaddr;if(devices[a].room==b&&f==d)return a}logger("lookp_uaddr:: No index in devices found for room: "+b+", dev id: "+d,1);return-1}function load_device(b,d){for(var a=0;a<devices.length;a++){var f=devices[a].id;if(devices[a].room==b&&f==d)return devices[a].val}return 1}function get_scene(b){for(var d=0;d<scenes.length;d++)if(scenes[d].id==b)return scenes[d];return-1}
function idx_scene(b){for(var d=0;d<scenes.length;d++)if(scenes[d].id==b)return d;return-1}function get_handset(b){for(var d=0;d<handsets.length;d++)if(handsets[d].id==b)return handsets[d];return 1}function get_handset_record(b,d,a){for(var f=0;f<handsets.length;f++)if(handsets[f].id==b&&handsets[f].unit==d&&handsets[f].val==a)return handsets[f];return 1}function get_timer(b){for(var d=0;d<timers.length;d++)if(timers[d].id==b)return timers[d];return-1}
function set_timer(b,d){for(var a=0;a<timers.length;a++)if(timers[a].id==b)return timers[a]=d,0;return-1}
function decode_scene_string(b){logger("decode_scene_string: "+b,2);var d,a,f,c;d=0;switch(b.substr(d,1)){case "!":d++;c="";"R"==b.substr(d,1)?(d++,f=b.substr(d+1,1),"D"==f||"F"==f?(a=b.substr(d,1),d++):(a=b.substr(d,2),d+=2)):alert("decode_scene: Room not found in command string");for(var e=0;e<rooms.length;e++)rooms[e].id==a&&(c+=rooms[e].name);if("D"==b.substr(d,1)){c+=", ";d++;"F"==b.substr(d+1,1)?(f=b.substr(d,1),d++):(f=b.substr(d,2),d+=2);for(e=0;e<devices.length;e++)if(devices[e].uaddr==f&&
devices[e].room==a)switch(c+=devices[e].name,devices[e].type){case "dimmer":c+=", dimmer";break;case "switch":c+=", switch";break;default:alert("decode_scene:: Unsupported devicetype: "+devices[e].type)}if("F"==b.substr(d,1))switch(d++,a=b.substr(d,1),a){case "a":c+=", ALL OFF";break;case "o":c+=", set dimmer";break;case "0":c+=", OFF";break;case "1":c+=", ON";break;case "k":c+=", Man. Lock";break;case "l":c+=", Full Lock";break;case "d":d++,"P"==b.substr(d,1)&&(d++,c+=", dim value: "+b.substr(d))}}else"F"==
b.substr(d,1)?c+=", All off":alert("Unknown syntax: "+f+" at this position. cmd:: "+b);break;case "0":c="Timing delay "+b.substr(1)}return c}
function load_database(b){logger("load_database:: Calling send2daemon with load_database, "+b+" , "+b,2);var d;d=setInterval(function(){var a=w_sock.readyState;1!=a?(logger("load_database Websocket:: ERROR. State is: "+a,1),message("load_database:: Websocket:: ERROR. State is: "+a)):(clearInterval(d),message("load_database:: sending load_database request"),send2daemon("load_database",b,b))},500);return 1}
function handle_device(b,d){var a="",f="",c="";3<=debug&&alert("handle_device:: \nid: "+b+"\nval: "+d);switch(d){case "Fo":a+="Fo";break;case "ON":case "F1":for(var e=0;e<devices.length;e++)if(devices[e].id==b&&devices[e].room==s_room_id){a="dimmer"==devices[e].type?a+"FdP"+devices[e].lastval:a+"F1";break}break;case "OFF":case "F0":a+="F0";break;case "DUP":a+="S1";break;case "D":alert("handle_device:: "+d+" command not recognized");break;case "Fa":return c="!R"+s_room_id+"Fa",message_device("gui",
f,c),1;default:a=a+"Fd"+d}for(e=0;e<devices.length;e++)if(devices[e].id==b.substr(0,2)&&devices[e].room==s_room_id){c=devices[e].uaddr;f=brands[devices[e].brand].fname;c="!R"+s_room_id+"D"+c+a;break}logger("handle_device:: action is: "+f+", lamp command code is: "+c);message_device("gui",f,c)}
function send2daemon(b,d,a){logger("send2daemon: action: "+b+", cmd: "+d,2);b={tcnt:++w_tcnt%1E3+"",type:"raw",action:b,cmd:d,message:a};for(d=0;4>d;d++)switch(w_sock.readyState){case 0:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 1:return logger("send2daemon:: sending: "+JSON.stringify(b),2),w_sock.send(JSON.stringify(b)),0;case 2:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 3:setTimeout(function(){logger("send2daemon:: socket not ready: "+
w_sock.readyState,2)},1E3);break;default:logger("send2daemon:: readystate not defined: "+w_sock.readyState,1)}logger("send2daemon:: unable to transmit message 4 times: "+w_sock.readyState,1);return-1}function message_device(b,d,a){if(s_recording)return s_recorder+=a,activate_scene(s_scene_id),1;logger("message_device:: Calling send2daemon with "+b+", "+d+", "+a,2);send2daemon(b,d,a);return 1};