var use_energy=0,loginprocess=!1;function logger(b,c){3<=debug&&alert("Message called: "+b+", lvl: "+c+", debug: "+debug);"undefined"===typeof c&&(c=debug);c<=debug&&console.log(b)}function message(b,c,a){2<debug&&alert("Message called: "+b+", lvl: "+c+", debug: "+debug);"undefined"===typeof c&&(c=debug);c<=debug&&($("#gui_messages").empty(""),b='<div id="comment">'+b+"</div>",$("#gui_messages").append(b));return 0}function isFunction(b){return typeof b===typeof Function}
Storage.prototype.setObject=function(b,c){logger("setObject:: key: "+b+":"+JSON.stringify(c),2);this.setItem(b,JSON.stringify(c))};Storage.prototype.getObject=function(b){var c=this.getItem(b);logger("getObject:: type: "+typeof c+", key: "+b+":"+JSON.stringify(c),2);if(null==c)return null;try{JSON.parse(c)}catch(a){return logger("getObject:: Exception error JSON parse"),null}return c&&JSON.parse(c)};
function getTime(){var b=new Date;return pad(b.getHours(),2)+":"+pad(b.getMinutes(),2)+":"+pad(b.getSeconds(),2)}function parse_int(b){return b.match(/\d+\.?\d*/g)}function read_int(b){return b.match(/\d+\.?\d*/g)[0]}function find_device(b,c){for(var a=0;a<devices.length;a++){var g=devices[a].id;if(devices[a].room==b&&g==c)return a}return-1}
function lookup_uaddr(b,c){for(var a=0;a<devices.length;a++){var g=devices[a].uaddr;if(devices[a].room==b&&g==c)return a}logger("lookp_uaddr:: No index in devices found for room: "+b+", dev id: "+c,1);return-1}function checkLength(b,c,a,g){return b.val().length>g||b.val().length<a?(b.addClass("ui-state-error"),updateTips("Length of "+c+" must be between "+a+" and "+g+"."),!1):!0}
function askForm(b,c,a,g){if(1==jqmobile){$("#header").empty();var f=$("<div/>").popup({id:"popform",dismissible:!1,theme:"b",overlayTheme:"a",title:g||"Confirm",maxWidth:"500px",dialogClass:"askform",transition:"pop"}).bind("popupafterclose",function(){$(this).remove()});$("<div/>",{text:g}).appendTo(f);$(b,{}).appendTo(f);$("<a>",{text:"Submit"}).buttonMarkup({inline:!0,icon:"check"}).bind("click",function(){if("function"==typeof c){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),
,$("#val_5").val()];setTimeout(function(){c(a)},50)}2<=debug&&alert("Submit");f.popup("close")}).appendTo(f);$("<a>",{text:"CANCEL","data-jqm-rel":"back"}).buttonMarkup({inline:!0,icon:"back"}).bind("click",function(){"function"==typeof a&&setTimeout(a,50);f.popup("close");1<debug&&alert("cancel")}).appendTo(f);f.popup("open")}else $('<div style="padding: 10px; max-width: 500px; word-wrap: break-word;">'+b+"</div>").dialog({draggable:!1,modal:!0,resizable:!1,width:"auto",title:g||"Confirm",minHeight:120,
dialogClass:"askform",buttons:{OK:function(){if("function"==typeof c){var a=[$("#val_1").val(),$("#val_2").val(),$("#val_3").val(),$("#val_4").val(),$("#val_5").val()];setTimeout(function(){c(a)},50)}$(this).dialog("destroy")},Cancel:function(){"function"==typeof a&&setTimeout(a,50);$(this).dialog("destroy")}},close:function(){$(this).dialog("destroy")}})}
function init_websockets(){var b=w_url.split(":");logger("init_websockets:: Splitting url and port: "+b[0],2);w_uri="ws://"+b[0]+":"+w_port;logger("init_websockets:: new WebSocket w_uri: "+w_uri,1);w_sock=new WebSocket(w_uri);w_sock.onopen=function(c){logger("Websocket:: Opening socket "+w_uri,1);message("websocket reopen",1)};w_sock.onclose=function(c){logger("Websocket:: socket closed "+w_uri+", code: "+c.code,1);message('<DIV style="textdecoration: blink; background-color:yellow; color:black;">Restarting the Websocket. Please wait ...</DIV>');
setTimeout(function(){message("")},500);setTimeout(function(){init_websockets()},1E3);logger("Websocket:: socket re-opened: "+w_sock.readyState)};w_sock.onerror=function(c){logger("Websocket:: error. State is: "+w_sock.readyState)};w_sock.onmessage=function(c){10>healthcount&&healthcount++;var a=JSON.parse(c.data);logger("Websocket:: message rcv: "+a.action,2);2<=debug&&console.log(a);c=a.tcnt;var b=a.type,f=a.action;switch(f){case "ack":3<=debug?message("action: "+f+", tcnt: "+c+", mes: "+e+", type: "+
b,3):logger("action: "+f+", tcnt: "+c+", mes: "+e+", type: "+b,2);break;case "alert":myAlert("Server msg:: "+a.message);break;case "alarm":myAlert("Server msg:: "+a.message);break;case "upd":case "gui":var e=a.message;switch(b){case "json":logger("onmessage:: read upd message. Type is: "+b+". Json is not supported yet",1);var h=a.room,l=a.uaddr,d=a.val,k=lookup_uaddr(h,l);devices[k].val=d;h==s_room_id&&"room"==s_screen&&activate_room(s_room_id);break;case "raw":e=a.message;logger("onmessage:: read upd message. Type is: "+
b,1);var m=parse_int(e);"!R"==e.substr(0,2)&&(h=m[0],l=m[1],k=lookup_uaddr(h,l),e.search("FdP"),d=m[2],logger("onmessage:: room: "+h+", device: "+l+", val: "+d+", ind: "+k,2),devices[k].val=d,h==s_room_id&&"room"==s_screen&&activate_room(s_room_id));break;default:logger("onmessage:: read upd message. Unknown type: "+b,1)}0==debug?message("Update: "+devices[k].name+" to value: "+d,0):message("action: "+f+", tcnt: "+c+", mes: "+e+", type: "+b,1);break;case "weather":alert("UNEXPECTED WEATHER MESSAGE RECEIVED");
for(d=0;d<weather.length&&(weather[d].address!=a.address||weather[d].channel!=a.channel);d++);d<weather.length&&(weather[d].temperature=a.temperature,weather[d].humidity=a.humidity,weather[d].airpressure=a.airpressure,weather[d].windspeed=a.windspeed,weather[d].winddirection=a.winddirection,weather[d].rainfall=a.rainfall,e="",2<=debug&&(e+="Weather "+weather[d].name+"@ "+weather[d].location,e+=": temp: "+weather[d].temperature,e+=", humi: "+weather[d].humidity+"%<br>",logger("Weather "+weather[d].name+
"@"+weather[d].location+": temp: "+weather[d].temperature+", humi: "+weather[d].humidity+"%")),message(e));break;case "sensor":logger("Sensor message from "+a.address+":"+a.channel,1);for(d=0;d<sensors.length&&(sensors[d].address!=a.address||sensors[d].channel!=a.channel);d++);d<sensors.length&&(a.hasOwnProperty("temperature")&&(sensors[d].sensor.temperature.val=a.temperature),a.hasOwnProperty("humidity")&&(sensors[d].sensor.humidity.val=a.humidity),a.hasOwnProperty("airpressure")&&(sensors[d].sensor.airpressure.val=
a.airpressure),a.hasOwnProperty("windspeed")&&(sensors[d].sensor.windspeed.val=a.windspeed),a.hasOwnProperty("winddirection")&&(sensors[d].sensor.winddirection.val=a.winddirection),a.hasOwnProperty("rainfall")&&(sensors[d].sensor.railfall.val=a.railfall),e="",2<=debug&&(e+="Sensor "+sensors[d].name+"@ "+sensors[d].location,e+=": temp: "+sensors[d].temperature,e+=", humi: "+sensors[d].humidity+"%<br>",logger("Sensor "+sensors[d].name+"@"+sensors[d].location+": temp: "+sensors[d].temperature+", humi: "+
sensors[d].humidity+"%")),message(e));break;case "energy":use_energy||(use_energy=!0,init_menu(s_setting_id));logger("Energy message, kw_act_use: "+a.kw_act_use,1);energy.kw_hi_use=a.kw_hi_use;energy.kw_lo_use=a.kw_lo_use;energy.kw_hi_ret=a.kw_hi_ret;energy.kw_lo_ret=a.kw_lo_ret;energy.gas_use=a.gas_use;energy.kw_act_use=a.kw_act_use;energy.kw_act_ret=a.kw_act_ret;energy.kw_ph1_use=a.kw_ph1_use;energy.kw_ph2_use=a.kw_ph2_use;energy.kw_ph3_use=a.kw_ph3_use;break;case "console":logger("console message received"+
a.message,2);myAlert("<br>"+a.message,a.request+" Output");break;case "graph":logger("rcv:: graph response received, ",1);"function"==typeof display_graph&&display_graph(a.gtype,a.gperiod);break;case "list_user":logger("list_user message received",1);users=a.message;activate_setting("2b");break;case "login":if(loginprocess)break;loginprocess=!0;"undefined"!==typeof Storage?(e=localStorage.getItem("uname"),d=localStorage.getItem("pword"),1<=debug&&logger("Support for localstorage, uname: "+e),null===
e&&(e=""),null===d&&(d="")):(loger("No local storage in browser",1),message("No local storage in browser"),e="login",d="****");void 0!==a.message?logger("Lampi.js:: received login request, message"+a.message,1):(logger("Lampi.js:: received login request",1),a.message="Please logon ");askForm('<form id="addRoomForm"><fieldset><p>Since your computer <'+a.address+"> might be outside our network, we ask you to logon to the system and prove your identity <br><br>"+a.message+'</p><label for="val_1">Login: </label><input type="text" name="val_1" id="val_1" value="'+
e+'" class="text ui-widget-content ui-corner-all" /><br /><label for="val_2">Password: </label><input type="text" name="val_2" id="val_2" value="'+d+'" class="text ui-widget-content ui-corner-all" /></fieldset></form>',function(a){2<debug&&alert(" Dialog returned val_1,val_2,val_3: "+a);var b={tcnt:++w_tcnt%1E3,type:"raw",action:"login",login:a[0],password:a[1]};w_sock.send(JSON.stringify(b));logger(b);"undefined"!==typeof Storage&&(localStorage.setItem("uname",a[0]),localStorage.setItem("pword",
a[1]),logger("localstorage:: uname: "+a[0]));2<=debug&&myAlert("Submit login: "+a[0]+", password: "+a[1]);loginprocess=!1;logger("s_screen is: "+s_screen,1);return 1},function(){2<=debug&&myAlert("Submit login Cancelled");loginprocess=!1;return 0},"Confirm Login");break;case "load_database":logger("Receiving load_database message",2);rooms=a.response.rooms;devices=a.response.devices;scenes=a.response.scenes;timers=a.response.timers;handsets=a.response.handsets;settings=a.response.settings;brands=
a.response.brands;sensors=weather=a.response.sensors;rules=a.response.rules;init();void 0!==typeof Storage&&(localStorage.setObject("rooms",rooms),localStorage.setObject("devices",devices),localStorage.setObject("scenes",scenes),localStorage.setObject("timers",timers),localStorage.setObject("handsets",handsets),localStorage.setObject("settings",settings),localStorage.setObject("brands",brands),localStorage.setObject("sensors",sensors));message("database received: #rooms: "+rooms.length+", #devices:"+
devices.length);break;case "upd_config":logger("rcv:: upd_config message received",1);Object.keys(a.message).forEach(function(b){lroot[b]=a.message[b];switch(b){case "rooms":settings=a.message[b];break;case "devices":devices=a.message[b];break;case "scenes":scenes=a.message[b];break;case "timers":timers=a.message[b];break;case "handsets":handsets=a.message[b];break;case "sensors":sensors=a.message[b];break;case "brands":brands=a.message[b];break;case "settings":settings=a.message[b];break;default:myAlert("rcv upd_config:: received unknown message key: "+
b)}});activate(s_screen);break;default:message("Unknown message: action: "+f+", tcnt: "+c+", mes: "+e+", type: "+b)}};logger("Websocket:: readyState: "+w_sock.readyState,1)}
function send2daemon(b,c,a){logger("send2daemon: action: "+b+", cmd: "+c,2);b={tcnt:++w_tcnt%1E3+"",type:"raw",action:b,cmd:c,message:a};for(c=0;4>c;c++)switch(w_sock.readyState){case 0:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 1:return logger("send2daemon:: sending: "+JSON.stringify(b),2),w_sock.send(JSON.stringify(b)),0;case 2:setTimeout(function(){logger("send2daemon:: socket not ready: "+w_sock.readyState,2)},1E3);break;case 3:setTimeout(function(){logger("send2daemon:: socket not ready: "+
w_sock.readyState,2)},1E3);break;default:logger("send2daemon:: readystate not defined: "+w_sock.readyState,1)}logger("send2daemon:: unable to transmit message 4 times: "+w_sock.readyState,1);return-1}
function load_database(b){logger("load_database:: Calling send2daemon with load_database, "+b+" , "+b,2);var c;c=setInterval(function(){var a=w_sock.readyState;1!=a?(logger("load_database Websocket:: ERROR. State is: "+a,1),message("load_database:: Websocket:: ERROR. State is: "+a)):(clearInterval(c),message("load_database:: sending load_database request"),send2daemon("load_database",b,b))},500);return 1};